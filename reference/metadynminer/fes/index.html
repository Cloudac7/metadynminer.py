
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      <link rel="icon" href="../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.3.1, mkdocs-material-8.5.4">
    
    
      
        <title>Fes - metadynminer.py</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.80dcb947.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.cbb835fc.min.css">
        
          
          
          <meta name="theme-color" content="#4cae4f">
        
      
      

    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="green" data-md-color-accent="lightgreen">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#module-metadynminerfes" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../.." title="metadynminer.py" class="md-header__button md-logo" aria-label="metadynminer.py" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            metadynminer.py
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Fes
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/Cloudac7/metadynminer.py" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    metadynminer.py
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="metadynminer.py" class="md-nav__button md-logo" aria-label="metadynminer.py" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    metadynminer.py
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/Cloudac7/metadynminer.py" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    metadynminer.py
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        Home
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../../docs/example/tutorial/" class="md-nav__link">
        Tutorial
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3" type="checkbox" id="__nav_3" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_3">
          Reference
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Reference" data-md-level="1">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          Reference
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_1" type="checkbox" id="__nav_3_1" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_3_1">
          Metadynminer
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Metadynminer" data-md-level="2">
        <label class="md-nav__title" for="__nav_3_1">
          <span class="md-nav__icon md-icon"></span>
          Metadynminer
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Fes
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Fes
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#classes" class="md-nav__link">
    Classes
  </a>
  
    <nav class="md-nav" aria-label="Classes">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#fes" class="md-nav__link">
    Fes
  </a>
  
    <nav class="md-nav" aria-label="Fes">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#attributes" class="md-nav__link">
    Attributes
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#methods" class="md-nav__link">
    Methods
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#generate_cv_map" class="md-nav__link">
    generate_cv_map
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#make_gif" class="md-nav__link">
    make_gif
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#makefes" class="md-nav__link">
    makefes
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#makefes2" class="md-nav__link">
    makefes2
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#plot" class="md-nav__link">
    plot
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#removecv" class="md-nav__link">
    removeCV
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#set_fes" class="md-nav__link">
    set_fes
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#surface_plot" class="md-nav__link">
    surface_plot
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../hills/" class="md-nav__link">
        Hills
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../" class="md-nav__link">
        Index
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../minima/" class="md-nav__link">
        Minima
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../profile/" class="md-nav__link">
        Profile
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#classes" class="md-nav__link">
    Classes
  </a>
  
    <nav class="md-nav" aria-label="Classes">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#fes" class="md-nav__link">
    Fes
  </a>
  
    <nav class="md-nav" aria-label="Fes">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#attributes" class="md-nav__link">
    Attributes
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#methods" class="md-nav__link">
    Methods
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#generate_cv_map" class="md-nav__link">
    generate_cv_map
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#make_gif" class="md-nav__link">
    make_gif
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#makefes" class="md-nav__link">
    makefes
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#makefes2" class="md-nav__link">
    makefes2
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#plot" class="md-nav__link">
    plot
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#removecv" class="md-nav__link">
    removeCV
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#set_fes" class="md-nav__link">
    set_fes
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#surface_plot" class="md-nav__link">
    surface_plot
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  <a href="https://github.com/Cloudac7/metadynminer.py/edit/main/reference/metadynminer/fes.md" title="Edit this page" class="md-content__button md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25Z"/></svg>
  </a>


<h1 id="module-metadynminerfes">Module metadynminer.fes</h1>
<details class="example">
<summary>View Source</summary>
<div class="codehilite"><pre><span></span><code><span class="s s-Atom">import</span> <span class="s s-Atom">sys</span>

<span class="s s-Atom">import</span> <span class="s s-Atom">numpy</span> <span class="s s-Atom">as</span> <span class="s s-Atom">np</span>

<span class="s s-Atom">from</span> <span class="s s-Atom">tqdm</span> <span class="s s-Atom">import</span> <span class="s s-Atom">tqdm</span><span class="p">,</span> <span class="s s-Atom">trange</span>

<span class="s s-Atom">from</span> <span class="s s-Atom">typing</span> <span class="s s-Atom">import</span> <span class="nv">Optional</span><span class="p">,</span> <span class="nv">List</span>

<span class="s s-Atom">from</span> <span class="s s-Atom">metadynminer</span><span class="p">.</span><span class="s s-Atom">hills</span> <span class="s s-Atom">import</span> <span class="nv">Hills</span>

<span class="s s-Atom">class</span> <span class="nv">Fes</span><span class="o">:</span>

    <span class="s2">&quot;&quot;</span><span class="err">&quot;</span>

    <span class="nv">Computes</span> <span class="s s-Atom">the</span> <span class="s s-Atom">free</span> <span class="s s-Atom">energy</span> <span class="s s-Atom">surface</span> <span class="s s-Atom">corresponding</span> <span class="s s-Atom">to</span> <span class="s s-Atom">the</span> <span class="s s-Atom">provided</span> <span class="nv">Hills</span> <span class="s s-Atom">object</span><span class="p">.</span>

    <span class="nv">Usage</span><span class="o">:</span>

    <span class="err">```</span><span class="s s-Atom">python</span>

    <span class="s s-Atom">fes</span> <span class="o">=</span> <span class="s s-Atom">metadynminer</span><span class="p">.</span><span class="nv">Fes</span><span class="p">(</span><span class="s s-Atom">hills</span><span class="o">=</span><span class="s s-Atom">hillsfile</span><span class="p">)</span>

    <span class="err">```</span>

    <span class="nv">Args</span><span class="o">:</span>

        <span class="nf">hills</span> <span class="p">(</span><span class="nv">Hills</span><span class="p">)</span><span class="o">:</span> <span class="nv">The</span> <span class="nv">Hills</span> <span class="s s-Atom">object</span> <span class="s s-Atom">used</span> <span class="s s-Atom">for</span> <span class="s s-Atom">computing</span> <span class="s s-Atom">the</span> <span class="s s-Atom">free</span> <span class="s s-Atom">energy</span> <span class="s s-Atom">surface</span><span class="p">.</span>

        <span class="nf">original</span> <span class="p">(</span><span class="s s-Atom">bool</span><span class="p">,</span> <span class="s s-Atom">optional</span><span class="p">)</span><span class="o">:</span> <span class="s s-Atom">\</span>

            <span class="nv">If</span> <span class="nv">False</span><span class="p">,</span> <span class="s s-Atom">the</span> <span class="s s-Atom">free</span> <span class="s s-Atom">energy</span> <span class="s s-Atom">surface</span> <span class="s s-Atom">will</span> <span class="s s-Atom">be</span> <span class="s s-Atom">calculated</span> <span class="s s-Atom">using</span> <span class="s s-Atom">a</span> <span class="s s-Atom">fast</span> <span class="s s-Atom">but</span> <span class="s s-Atom">approximate</span> <span class="s s-Atom">algorithm</span><span class="p">.</span> <span class="s s-Atom">\</span>

            <span class="nv">If</span> <span class="nv">True</span><span class="p">,</span> <span class="s s-Atom">it</span> <span class="s s-Atom">will</span> <span class="s s-Atom">be</span> <span class="s s-Atom">calculated</span> <span class="s s-Atom">using</span> <span class="s s-Atom">a</span> <span class="s s-Atom">slower</span> <span class="s s-Atom">but</span> <span class="s s-Atom">exact</span> <span class="s s-Atom">algorithm</span> <span class="s s-Atom">\</span>

            <span class="p">(</span><span class="s s-Atom">same</span> <span class="s s-Atom">as</span> <span class="nv">FES</span> <span class="s s-Atom">calculated</span> <span class="s s-Atom">with</span> <span class="nv">PLUMED</span> <span class="err">`</span><span class="s s-Atom">sum_hills</span><span class="err">`</span> <span class="s s-Atom">function</span><span class="p">).</span> <span class="s s-Atom">\</span>

            <span class="nv">Defaults</span> <span class="s s-Atom">to</span> <span class="nv">False</span><span class="p">.</span>

        <span class="nf">calculate_new_fes</span> <span class="p">(</span><span class="s s-Atom">bool</span><span class="p">,</span> <span class="s s-Atom">optional</span><span class="p">)</span><span class="o">:</span> <span class="s s-Atom">\</span>

            <span class="nv">If</span> <span class="nv">True</span><span class="p">,</span> <span class="s s-Atom">the</span> <span class="s s-Atom">free</span> <span class="s s-Atom">energy</span> <span class="s s-Atom">surface</span> <span class="s s-Atom">will</span> <span class="s s-Atom">be</span> <span class="s s-Atom">calculated</span> <span class="s s-Atom">to</span> <span class="s s-Atom">form</span> <span class="err">`</span><span class="s s-Atom">self</span><span class="p">.</span><span class="s s-Atom">fes</span><span class="err">`</span><span class="p">.</span> <span class="s s-Atom">\</span>

            <span class="nv">Defaults</span> <span class="s s-Atom">to</span> <span class="nv">True</span><span class="p">.</span>

        <span class="nf">resolution</span> <span class="p">(</span><span class="s s-Atom">int</span><span class="p">,</span> <span class="s s-Atom">optional</span><span class="p">)</span><span class="o">:</span> <span class="s s-Atom">\</span>

            <span class="nv">The</span> <span class="s s-Atom">resolution</span> <span class="s s-Atom">of</span> <span class="s s-Atom">the</span> <span class="s s-Atom">free</span> <span class="s s-Atom">energy</span> <span class="s s-Atom">surface</span><span class="p">.</span> <span class="nv">Defaults</span> <span class="s s-Atom">to</span> <span class="mf">256.</span>

        <span class="nf">cv_select</span> <span class="p">(</span><span class="nv">List</span><span class="p">[</span><span class="s s-Atom">int</span><span class="p">],</span> <span class="s s-Atom">optional</span><span class="p">)</span><span class="o">:</span> <span class="s s-Atom">\</span>

            <span class="nv">A</span> <span class="s s-Atom">list</span> <span class="s s-Atom">of</span> <span class="s s-Atom">integers</span> <span class="s s-Atom">specifying</span> <span class="s s-Atom">which</span> <span class="s s-Atom">collective</span> <span class="nf">variables</span> <span class="p">(</span><span class="nv">CVs</span><span class="p">)</span> <span class="s s-Atom">should</span> <span class="s s-Atom">be</span> <span class="s s-Atom">used</span> <span class="s s-Atom">for</span> <span class="nv">FES</span> <span class="s s-Atom">calculation</span><span class="p">.</span> <span class="s s-Atom">\</span>

            <span class="nv">Defaults</span> <span class="s s-Atom">to</span> <span class="nv">None</span><span class="p">.</span>

        <span class="nf">cv_range</span> <span class="p">(</span><span class="nv">List</span><span class="p">[</span><span class="s s-Atom">float</span><span class="p">],</span> <span class="s s-Atom">optional</span><span class="p">)</span><span class="o">:</span> <span class="s s-Atom">\</span>

            <span class="nv">A</span> <span class="s s-Atom">list</span> <span class="s s-Atom">of</span> <span class="s s-Atom">two</span> <span class="s s-Atom">numbers</span> <span class="s s-Atom">defining</span> <span class="s s-Atom">the</span> <span class="s s-Atom">lower</span> <span class="s s-Atom">and</span> <span class="s s-Atom">upper</span> <span class="s s-Atom">bounds</span> <span class="s s-Atom">of</span> <span class="s s-Atom">the</span> <span class="nv">CVs</span> <span class="p">(</span><span class="s s-Atom">in</span> <span class="s s-Atom">the</span> <span class="s s-Atom">units</span> <span class="s s-Atom">of</span> <span class="s s-Atom">the</span> <span class="nv">CV</span><span class="p">).</span> <span class="s s-Atom">\</span>

            <span class="nv">Defaults</span> <span class="s s-Atom">to</span> <span class="nv">None</span><span class="p">.</span> <span class="s s-Atom">\</span>

        <span class="nf">time_min</span> <span class="p">(</span><span class="s s-Atom">int</span><span class="p">)</span><span class="o">:</span> <span class="nv">The</span> <span class="s s-Atom">starting</span> <span class="s s-Atom">time</span> <span class="s s-Atom">step</span> <span class="s s-Atom">of</span> <span class="s s-Atom">simulation</span><span class="p">.</span> <span class="nv">Defaults</span> <span class="s s-Atom">to</span> <span class="mf">0.</span>

        <span class="nf">time_max</span> <span class="p">(</span><span class="s s-Atom">int</span><span class="p">,</span> <span class="s s-Atom">optional</span><span class="p">)</span><span class="o">:</span> <span class="nv">The</span> <span class="s s-Atom">ending</span> <span class="s s-Atom">time</span> <span class="s s-Atom">step</span> <span class="s s-Atom">of</span> <span class="s s-Atom">simulation</span><span class="p">.</span> <span class="nv">Defaults</span> <span class="s s-Atom">to</span> <span class="nv">None</span><span class="p">.</span>

    <span class="s2">&quot;&quot;&quot;</span>

<span class="s2">    def __init__(</span>

<span class="s2">        self,</span>

<span class="s2">        hills: Hills,</span>

<span class="s2">        original: bool = False,</span>

<span class="s2">        calculate_new_fes: bool = True,</span>

<span class="s2">        resolution: int = 256,</span>

<span class="s2">        cv_select: Optional[List[int]] = None,</span>

<span class="s2">        cv_range: Optional[List[float]] = None,</span>

<span class="s2">        time_min: int = 0,</span>

<span class="s2">        time_max: Optional[int] = None</span>

<span class="s2">    ):</span>

<span class="s2">        self.res = resolution</span>

<span class="s2">        self.fes = None</span>

<span class="s2">        self.hills = hills</span>

<span class="s2">        self.periodic = hills.get_periodic()</span>

<span class="s2">        if cv_select != None:</span>

<span class="s2">            self.cvs = len(cv_select)</span>

<span class="s2">        else:</span>

<span class="s2">            cv_select = [i for i in range(self.hills.cvs)]</span>

<span class="s2">            self.cvs = len(cv_select)</span>

<span class="s2">        if time_max != None:</span>

<span class="s2">            if time_max &lt;= time_min:</span>

<span class="s2">                print(&quot;</span><span class="nv">Error</span><span class="o">:</span> <span class="nv">End</span> <span class="s s-Atom">time</span> <span class="o">is</span> <span class="s s-Atom">lower</span> <span class="s s-Atom">than</span> <span class="s s-Atom">start</span> <span class="s s-Atom">time</span><span class="s2">&quot;)</span>

<span class="s2">            if time_max &gt; len(self.hills.cv[:, 0]):</span>

<span class="s2">                time_max = len(self.hills.cv[:, 0])</span>

<span class="s2">                print(</span>

<span class="s2">                    f&quot;</span><span class="nv">Error</span><span class="o">:</span> <span class="nv">End</span> <span class="s s-Atom">time</span> <span class="p">{</span><span class="s s-Atom">time_max</span><span class="p">}</span> <span class="o">is</span> <span class="s s-Atom">higher</span> <span class="s s-Atom">than</span><span class="s2">&quot;,</span>

<span class="s2">                    f&quot;</span><span class="s s-Atom">number</span> <span class="s s-Atom">of</span> <span class="s s-Atom">lines</span> <span class="s s-Atom">in</span> <span class="nv">HILLS</span> <span class="s s-Atom">file</span> <span class="p">{</span><span class="nf">len</span><span class="p">(</span><span class="s s-Atom">self</span><span class="p">.</span><span class="s s-Atom">hills</span><span class="p">.</span><span class="s s-Atom">cv</span><span class="p">[</span><span class="o">:</span><span class="p">,</span> <span class="mi">0</span><span class="p">])},</span><span class="s2">&quot;,</span>

<span class="s2">                    &quot;</span><span class="s s-Atom">which</span> <span class="s s-Atom">will</span> <span class="s s-Atom">be</span> <span class="s s-Atom">used</span> <span class="s s-Atom">instead</span><span class="p">.</span><span class="s2">&quot;</span>

<span class="s2">                )</span>

<span class="s2">        if calculate_new_fes:</span>

<span class="s2">            if not original:</span>

<span class="s2">                self.makefes(resolution, cv_select,</span>

<span class="s2">                             cv_range, time_min, time_max)</span>

<span class="s2">            else:</span>

<span class="s2">                self.makefes2(resolution, cv_select,</span>

<span class="s2">                              cv_range, time_min, time_max)</span>

<span class="s2">    def generate_cv_map(</span>

<span class="s2">        self,</span>

<span class="s2">        cv_select: Optional[List[int]] = None,</span>

<span class="s2">        cv_range: Optional[List[float]] = None</span>

<span class="s2">    ):</span>

<span class="s2">        &quot;&quot;&quot;</span><span class="s s-Atom">generate</span> <span class="nv">CV</span> <span class="s s-Atom">map</span>

        <span class="nv">Args</span><span class="o">:</span>

            <span class="nf">cv_select</span> <span class="p">(</span><span class="nv">List</span><span class="p">[</span><span class="s s-Atom">int</span><span class="p">],</span> <span class="s s-Atom">optional</span><span class="p">)</span><span class="o">:</span> <span class="s s-Atom">\</span>

                <span class="nv">A</span> <span class="s s-Atom">list</span> <span class="s s-Atom">of</span> <span class="s s-Atom">integers</span> <span class="s s-Atom">specifying</span> <span class="s s-Atom">which</span> <span class="s s-Atom">collective</span> <span class="nf">variables</span> <span class="p">(</span><span class="nv">CVs</span><span class="p">)</span> <span class="s s-Atom">should</span> <span class="s s-Atom">be</span> <span class="s s-Atom">used</span> <span class="s s-Atom">for</span> <span class="nv">FES</span> <span class="s s-Atom">calculation</span><span class="p">.</span> <span class="s s-Atom">\</span>

                <span class="nv">Defaults</span> <span class="s s-Atom">to</span> <span class="nv">None</span><span class="p">.</span>

            <span class="nf">cv_range</span> <span class="p">(</span><span class="nv">Optional</span><span class="p">[</span><span class="nv">List</span><span class="p">[</span><span class="s s-Atom">float</span><span class="p">]],</span> <span class="s s-Atom">optional</span><span class="p">)</span><span class="o">:</span> <span class="s s-Atom">\</span>

                <span class="nv">A</span> <span class="s s-Atom">list</span> <span class="s s-Atom">of</span> <span class="s s-Atom">two</span> <span class="s s-Atom">numbers</span> <span class="s s-Atom">defining</span> <span class="s s-Atom">the</span> <span class="s s-Atom">lower</span> <span class="s s-Atom">and</span> <span class="s s-Atom">upper</span> <span class="s s-Atom">bounds</span> <span class="s s-Atom">of</span> <span class="s s-Atom">the</span> <span class="nv">CVs</span> <span class="p">(</span><span class="s s-Atom">in</span> <span class="s s-Atom">the</span> <span class="s s-Atom">units</span> <span class="s s-Atom">of</span> <span class="s s-Atom">the</span> <span class="nv">CV</span><span class="p">).</span> <span class="s s-Atom">\</span>

                <span class="nv">Defaults</span> <span class="s s-Atom">to</span> <span class="nv">None</span><span class="p">.</span> <span class="s s-Atom">\</span>

        <span class="nv">Returns</span><span class="o">:</span>

            <span class="nv">Tuple</span><span class="o">:</span> <span class="s s-Atom">cv_min</span><span class="p">,</span> <span class="s s-Atom">cv_max</span><span class="p">,</span> <span class="s s-Atom">cv_fes_range</span>

        <span class="s2">&quot;&quot;&quot;</span>

<span class="s2">        if cv_select is None:</span>

<span class="s2">            cv_select = list(range(self.cvs))</span>

<span class="s2">        self.cv_select = cv_select</span>

<span class="s2">        self.cvs = len(cv_select)</span>

<span class="s2">        if cv_range is None:</span>

<span class="s2">            cv_min = self.hills.cv_min[cv_select]</span>

<span class="s2">            cv_max = self.hills.cv_max[cv_select]</span>

<span class="s2">            cv_range = self.hills.cv_max - self.hills.cv_min</span>

<span class="s2">        else:</span>

<span class="s2">            if len(cv_range) != len(cv_select) and len(cv_range) != 2:</span>

<span class="s2">                raise ValueError(</span>

<span class="s2">                    &quot;</span><span class="s s-Atom">cv_range</span> <span class="s s-Atom">has</span> <span class="s s-Atom">to</span> <span class="s s-Atom">have</span> <span class="s s-Atom">the</span> <span class="s s-Atom">same</span> <span class="s s-Atom">length</span> <span class="s s-Atom">as</span> <span class="s s-Atom">cv_select</span><span class="s2">&quot;</span>

<span class="s2">                    &quot;</span><span class="s s-Atom">or</span> <span class="s s-Atom">be</span> <span class="s s-Atom">a</span> <span class="s s-Atom">list</span> <span class="s s-Atom">of</span> <span class="s s-Atom">two</span> <span class="s s-Atom">numbers</span><span class="s2">&quot;</span>

<span class="s2">                )</span>

<span class="s2">            elif len(cv_range) == 2:</span>

<span class="s2">                if type(cv_range[0]) == int:</span>

<span class="s2">                    cv_min = np.full(len(cv_select), cv_range[0])</span>

<span class="s2">                    cv_max = np.full(len(cv_select), cv_range[1])</span>

<span class="s2">            else:</span>

<span class="s2">                cv_min = np.array(cv_range)[:, 0]</span>

<span class="s2">                cv_max = np.array(cv_range)[:, 1]</span>

<span class="s2">        self.cv_range = cv_range</span>

<span class="s2">        cv_min[~self.periodic[cv_select] # type: ignore</span>

<span class="s2">               ] -= cv_range[~self.periodic[cv_select]] * 0.15 # type: ignore</span>

<span class="s2">        cv_max[~self.periodic[cv_select] # type: ignore</span>

<span class="s2">               ] += cv_range[~self.periodic[cv_select]] * 0.15 # type: ignore</span>

<span class="s2">        cv_fes_range = np.abs(cv_max - cv_min) # type: ignore</span>

<span class="s2">        # generate remapped cv_min and cv_max</span>

<span class="s2">        self.cv_min = cv_min # type: ignore</span>

<span class="s2">        self.cv_max = cv_max # type: ignore</span>

<span class="s2">        self.cv_fes_range = cv_fes_range</span>

<span class="s2">    def makefes(</span>

<span class="s2">        self,</span>

<span class="s2">        resolution: Optional[int] = None,</span>

<span class="s2">        cv_select: Optional[List[int]] = None,</span>

<span class="s2">        cv_range: Optional[List[float]] = None,</span>

<span class="s2">        time_min: Optional[int] = None,</span>

<span class="s2">        time_max: Optional[int] = None</span>

<span class="s2">    ):</span>

<span class="s2">        &quot;&quot;&quot;</span><span class="nv">Function</span> <span class="s s-Atom">used</span> <span class="s s-Atom">internally</span> <span class="s s-Atom">for</span> <span class="s s-Atom">summing</span> <span class="s s-Atom">hills</span> <span class="s s-Atom">in</span> <span class="nv">Hills</span> <span class="s s-Atom">object</span> <span class="s s-Atom">with</span> <span class="s s-Atom">the</span> <span class="s s-Atom">fast</span> <span class="nv">Bias</span> <span class="nv">Sum</span> <span class="nv">Algorithm</span><span class="p">.</span>

        <span class="nv">Args</span><span class="o">:</span>

            <span class="nf">resolution</span> <span class="p">(</span><span class="s s-Atom">int</span><span class="p">,</span> <span class="s s-Atom">optional</span><span class="p">)</span><span class="o">:</span> <span class="s s-Atom">\</span>

                <span class="nv">The</span> <span class="s s-Atom">resolution</span> <span class="s s-Atom">of</span> <span class="s s-Atom">the</span> <span class="s s-Atom">free</span> <span class="s s-Atom">energy</span> <span class="s s-Atom">surface</span><span class="p">.</span> <span class="nv">Defaults</span> <span class="s s-Atom">to</span> <span class="mf">256.</span>

            <span class="nf">cv_select</span> <span class="p">(</span><span class="nv">List</span><span class="p">[</span><span class="s s-Atom">int</span><span class="p">],</span> <span class="s s-Atom">optional</span><span class="p">)</span><span class="o">:</span> <span class="s s-Atom">\</span>

                <span class="nv">A</span> <span class="s s-Atom">list</span> <span class="s s-Atom">of</span> <span class="s s-Atom">integers</span> <span class="s s-Atom">specifying</span> <span class="s s-Atom">which</span> <span class="s s-Atom">collective</span> <span class="nf">variables</span> <span class="p">(</span><span class="nv">CVs</span><span class="p">)</span> <span class="s s-Atom">should</span> <span class="s s-Atom">be</span> <span class="s s-Atom">used</span> <span class="s s-Atom">for</span> <span class="nv">FES</span> <span class="s s-Atom">calculation</span><span class="p">.</span> <span class="s s-Atom">\</span>

                <span class="nv">Defaults</span> <span class="s s-Atom">to</span> <span class="nv">None</span><span class="p">.</span>

            <span class="nf">cv_range</span> <span class="p">(</span><span class="nv">List</span><span class="p">[</span><span class="s s-Atom">float</span><span class="p">],</span> <span class="s s-Atom">optional</span><span class="p">)</span><span class="o">:</span> <span class="s s-Atom">\</span>

                <span class="nv">A</span> <span class="s s-Atom">list</span> <span class="s s-Atom">of</span> <span class="s s-Atom">two</span> <span class="s s-Atom">numbers</span> <span class="s s-Atom">defining</span> <span class="s s-Atom">the</span> <span class="s s-Atom">lower</span> <span class="s s-Atom">and</span> <span class="s s-Atom">upper</span> <span class="s s-Atom">bounds</span> <span class="s s-Atom">of</span> <span class="s s-Atom">the</span> <span class="nv">CVs</span> <span class="p">(</span><span class="s s-Atom">in</span> <span class="s s-Atom">the</span> <span class="s s-Atom">units</span> <span class="s s-Atom">of</span> <span class="s s-Atom">the</span> <span class="nv">CV</span><span class="p">).</span> <span class="s s-Atom">\</span>

                <span class="nv">Defaults</span> <span class="s s-Atom">to</span> <span class="nv">None</span><span class="p">.</span> <span class="s s-Atom">\</span>

            <span class="nf">time_min</span> <span class="p">(</span><span class="s s-Atom">int</span><span class="p">)</span><span class="o">:</span> <span class="nv">The</span> <span class="s s-Atom">starting</span> <span class="s s-Atom">time</span> <span class="s s-Atom">step</span> <span class="s s-Atom">of</span> <span class="s s-Atom">simulation</span><span class="p">.</span> <span class="nv">Defaults</span> <span class="s s-Atom">to</span> <span class="mf">0.</span>

            <span class="nf">time_max</span> <span class="p">(</span><span class="s s-Atom">int</span><span class="p">,</span> <span class="s s-Atom">optional</span><span class="p">)</span><span class="o">:</span> <span class="nv">The</span> <span class="s s-Atom">ending</span> <span class="s s-Atom">time</span> <span class="s s-Atom">step</span> <span class="s s-Atom">of</span> <span class="s s-Atom">simulation</span><span class="p">.</span> <span class="nv">Defaults</span> <span class="s s-Atom">to</span> <span class="nv">None</span><span class="p">.</span>

        <span class="s2">&quot;&quot;&quot;</span>

<span class="s2">        if resolution is None:</span>

<span class="s2">            resolution = self.res</span>

<span class="s2">        self.generate_cv_map(cv_select, cv_range)</span>

<span class="s2">        cv_min = self.cv_min</span>

<span class="s2">        cv_max = self.cv_max</span>

<span class="s2">        cv_fes_range = self.cv_fes_range</span>

<span class="s2">        cv_bins = np.array([np.ceil(</span>

<span class="s2">            (self.hills.cv[time_min:time_max, cv_index] -</span>

<span class="s2">             cv_min[cv_index]) * resolution / cv_fes_range[cv_index]</span>

<span class="s2">        ) for cv_index in cv_select])</span>

<span class="s2">        cvs = len(cv_select)</span>

<span class="s2">        cv_bins = cv_bins.astype(int)</span>

<span class="s2">        sigma = np.array([self.hills.sigma[cv_index][0]</span>

<span class="s2">                         for cv_index in cv_select])</span>

<span class="s2">        sigma_res = (sigma * self.res) / (cv_max - cv_min)</span>

<span class="s2">        gauss_res = np.max((8 * sigma_res).astype(int))</span>

<span class="s2">        if gauss_res % 2 == 0:</span>

<span class="s2">            gauss_res += 1</span>

<span class="s2">        gauss_center_to_end = int((gauss_res - 1) / 2)</span>

<span class="s2">        gauss_center = gauss_center_to_end + 1</span>

<span class="s2">        grids = np.meshgrid(*[np.arange(gauss_res)] * cvs)</span>

<span class="s2">        exponent = 0.</span>

<span class="s2">        for i in range(len(sigma_res)):</span>

<span class="s2">            i_diff = (grids[i] + 1) - gauss_center</span>

<span class="s2">            exponent += -(i_diff ** 2) / (2 * sigma_res[i] ** 2)</span>

<span class="s2">        gauss = -np.exp(exponent)</span>

<span class="s2">        fes = np.zeros([resolution] * cvs)</span>

<span class="s2">        for line in trange(len(cv_bins[0]), desc=&quot;</span><span class="nv">Constructing</span> <span class="nv">FES</span><span class="err">&quot;</span><span class="p">)</span><span class="o">:</span>

            <span class="s s-Atom">#</span> <span class="s s-Atom">create</span> <span class="s s-Atom">a</span> <span class="s s-Atom">meshgrid</span> <span class="s s-Atom">of</span> <span class="s s-Atom">the</span> <span class="s s-Atom">indexes</span> <span class="s s-Atom">of</span> <span class="s s-Atom">the</span> <span class="s s-Atom">fes</span> <span class="s s-Atom">that</span> <span class="s s-Atom">need</span> <span class="s s-Atom">to</span> <span class="s s-Atom">be</span> <span class="s s-Atom">edited</span>

            <span class="s s-Atom">#</span> <span class="s s-Atom">size</span> <span class="s s-Atom">of</span> <span class="s s-Atom">the</span> <span class="s s-Atom">meshgrid</span> <span class="o">is</span> <span class="s s-Atom">the</span> <span class="s s-Atom">same</span> <span class="s s-Atom">as</span> <span class="s s-Atom">the</span> <span class="s s-Atom">size</span> <span class="s s-Atom">of</span> <span class="s s-Atom">the</span> <span class="s s-Atom">gauss</span>

            <span class="s s-Atom">fes_index_to_edit</span> <span class="o">=</span> <span class="s s-Atom">np</span><span class="p">.</span><span class="nf">meshgrid</span><span class="p">(</span>

                <span class="s s-Atom">*</span><span class="p">([</span>

                    <span class="s s-Atom">np</span><span class="p">.</span><span class="nf">arange</span><span class="p">(</span><span class="s s-Atom">gauss_res</span><span class="p">)</span> <span class="o">-</span> <span class="s s-Atom">gauss_center</span>

                <span class="p">]</span> <span class="o">*</span> <span class="nf">len</span><span class="p">(</span><span class="s s-Atom">cv_bins</span><span class="p">[</span><span class="o">:</span><span class="p">,</span> <span class="s s-Atom">line</span><span class="p">]))</span>

            <span class="p">)</span>

            <span class="s s-Atom">#</span> <span class="s s-Atom">create</span> <span class="s s-Atom">a</span> <span class="s s-Atom">mask</span> <span class="s s-Atom">to</span> <span class="s s-Atom">avoid</span> <span class="s s-Atom">editing</span> <span class="s s-Atom">indexes</span> <span class="s s-Atom">outside</span> <span class="s s-Atom">the</span> <span class="s s-Atom">fes</span>

            <span class="s s-Atom">local_mask</span> <span class="o">=</span> <span class="s s-Atom">np</span><span class="p">.</span><span class="nf">ones_like</span><span class="p">(</span><span class="s s-Atom">gauss</span><span class="p">,</span> <span class="s s-Atom">dtype</span><span class="o">=</span><span class="s s-Atom">int</span><span class="p">)</span>

            <span class="s s-Atom">for</span> <span class="s s-Atom">d</span> <span class="s s-Atom">in</span> <span class="nf">range</span><span class="p">(</span><span class="s s-Atom">cvs</span><span class="p">)</span><span class="o">:</span>

                <span class="s s-Atom">fes_index_to_edit</span><span class="p">[</span><span class="s s-Atom">d</span><span class="p">]</span> <span class="s s-Atom">+=</span> <span class="s s-Atom">cv_bins</span><span class="p">[</span><span class="s s-Atom">d</span><span class="p">][</span><span class="s s-Atom">line</span><span class="p">]</span>

                <span class="s s-Atom">if</span> <span class="o">not</span> <span class="s s-Atom">self</span><span class="p">.</span><span class="s s-Atom">periodic</span><span class="p">[</span><span class="s s-Atom">d</span><span class="p">]</span><span class="o">:</span>

                    <span class="s s-Atom">mask</span> <span class="o">=</span> <span class="s s-Atom">np</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span>

                        <span class="p">(</span><span class="s s-Atom">fes_index_to_edit</span><span class="p">[</span><span class="s s-Atom">d</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span>

                            <span class="s s-Atom">fes_index_to_edit</span><span class="p">[</span><span class="s s-Atom">d</span><span class="p">]</span> <span class="o">&gt;</span> <span class="s s-Atom">resolution</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>

                    <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

                    <span class="s s-Atom">#</span> <span class="s s-Atom">if</span> <span class="s s-Atom">the</span> <span class="s s-Atom">cv</span> <span class="o">is</span> <span class="o">not</span> <span class="s s-Atom">periodic</span><span class="p">,</span> <span class="s s-Atom">remove</span> <span class="s s-Atom">the</span> <span class="s s-Atom">indexes</span> <span class="s s-Atom">outside</span> <span class="s s-Atom">the</span> <span class="s s-Atom">fes</span>

                    <span class="s s-Atom">local_mask</span><span class="p">[</span><span class="s s-Atom">mask</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

                <span class="s s-Atom">#</span> <span class="s s-Atom">make</span> <span class="s s-Atom">sure</span> <span class="s s-Atom">the</span> <span class="s s-Atom">indexes</span> <span class="s s-Atom">are</span> <span class="s s-Atom">inside</span> <span class="s s-Atom">the</span> <span class="s s-Atom">fes</span>

                <span class="s s-Atom">fes_index_to_edit</span><span class="p">[</span><span class="s s-Atom">d</span><span class="p">]</span> <span class="o">=</span> <span class="s s-Atom">np</span><span class="p">.</span><span class="o">mod</span><span class="p">(</span><span class="s s-Atom">fes_index_to_edit</span><span class="p">[</span><span class="s s-Atom">d</span><span class="p">],</span> <span class="s s-Atom">resolution</span><span class="p">)</span>

            <span class="s s-Atom">fes</span><span class="p">[</span><span class="nf">tuple</span><span class="p">(</span><span class="s s-Atom">fes_index_to_edit</span><span class="p">)]</span> <span class="s s-Atom">+=</span> <span class="s s-Atom">gauss</span> <span class="o">*</span> <span class="s s-Atom">\</span>

                <span class="s s-Atom">local_mask</span> <span class="o">*</span> <span class="s s-Atom">self</span><span class="p">.</span><span class="s s-Atom">hills</span><span class="p">.</span><span class="s s-Atom">heights</span><span class="p">[</span><span class="s s-Atom">line</span><span class="p">]</span>

        <span class="s s-Atom">fes</span> <span class="o">=</span> <span class="s s-Atom">fes</span> <span class="o">-</span> <span class="s s-Atom">np</span><span class="p">.</span><span class="nf">min</span><span class="p">(</span><span class="s s-Atom">fes</span><span class="p">)</span>

        <span class="s s-Atom">self</span><span class="p">.</span><span class="s s-Atom">fes</span> <span class="o">=</span> <span class="s s-Atom">fes</span>

        <span class="s s-Atom">return</span> <span class="s s-Atom">fes</span>

    <span class="s s-Atom">def</span> <span class="nf">makefes2</span><span class="p">(</span>

        <span class="s s-Atom">self</span><span class="p">,</span>

        <span class="s s-Atom">resolution</span><span class="p">:</span> <span class="nv">Optional</span><span class="p">[</span><span class="s s-Atom">int</span><span class="p">],</span>

        <span class="s s-Atom">cv_select</span><span class="o">:</span> <span class="nv">Optional</span><span class="p">[</span><span class="nv">List</span><span class="p">[</span><span class="s s-Atom">int</span><span class="p">]]</span> <span class="o">=</span> <span class="nv">None</span><span class="p">,</span>

        <span class="s s-Atom">cv_range</span><span class="o">:</span> <span class="nv">Optional</span><span class="p">[</span><span class="nv">List</span><span class="p">[</span><span class="s s-Atom">float</span><span class="p">]]</span> <span class="o">=</span> <span class="nv">None</span><span class="p">,</span>

        <span class="s s-Atom">time_min</span><span class="o">:</span> <span class="nv">Optional</span><span class="p">[</span><span class="s s-Atom">int</span><span class="p">]</span> <span class="o">=</span> <span class="nv">None</span><span class="p">,</span>

        <span class="s s-Atom">time_max</span><span class="o">:</span> <span class="nv">Optional</span><span class="p">[</span><span class="s s-Atom">int</span><span class="p">]</span> <span class="o">=</span> <span class="nv">None</span>

    <span class="p">)</span><span class="o">:</span>

        <span class="s2">&quot;&quot;</span><span class="err">&quot;</span>

        <span class="nv">Function</span> <span class="s s-Atom">internally</span> <span class="s s-Atom">used</span> <span class="s s-Atom">to</span> <span class="s s-Atom">sum</span> <span class="nv">Hills</span> <span class="s s-Atom">in</span> <span class="s s-Atom">the</span> <span class="s s-Atom">same</span> <span class="s s-Atom">way</span> <span class="s s-Atom">as</span> <span class="nv">Plumed</span> <span class="err">`</span><span class="s s-Atom">sum_hills</span><span class="err">`</span><span class="p">.</span>

        <span class="nv">Args</span><span class="o">:</span>

            <span class="nf">resolution</span> <span class="p">(</span><span class="s s-Atom">int</span><span class="p">,</span> <span class="s s-Atom">optional</span><span class="p">)</span><span class="o">:</span> <span class="s s-Atom">\</span>

                <span class="nv">The</span> <span class="s s-Atom">resolution</span> <span class="s s-Atom">of</span> <span class="s s-Atom">the</span> <span class="s s-Atom">free</span> <span class="s s-Atom">energy</span> <span class="s s-Atom">surface</span><span class="p">.</span> <span class="nv">Defaults</span> <span class="s s-Atom">to</span> <span class="mf">256.</span>

            <span class="nf">cv_select</span> <span class="p">(</span><span class="nv">List</span><span class="p">[</span><span class="s s-Atom">int</span><span class="p">],</span> <span class="s s-Atom">optional</span><span class="p">)</span><span class="o">:</span> <span class="s s-Atom">\</span>

                <span class="nv">A</span> <span class="s s-Atom">list</span> <span class="s s-Atom">of</span> <span class="s s-Atom">integers</span> <span class="s s-Atom">specifying</span> <span class="s s-Atom">which</span> <span class="s s-Atom">collective</span> <span class="nf">variables</span> <span class="p">(</span><span class="nv">CVs</span><span class="p">)</span> <span class="s s-Atom">should</span> <span class="s s-Atom">be</span> <span class="s s-Atom">used</span> <span class="s s-Atom">for</span> <span class="nv">FES</span> <span class="s s-Atom">calculation</span><span class="p">.</span> <span class="s s-Atom">\</span>

                <span class="nv">Defaults</span> <span class="s s-Atom">to</span> <span class="nv">None</span><span class="p">.</span>

            <span class="nf">cv_range</span> <span class="p">(</span><span class="nv">List</span><span class="p">[</span><span class="s s-Atom">float</span><span class="p">],</span> <span class="s s-Atom">optional</span><span class="p">)</span><span class="o">:</span> <span class="s s-Atom">\</span>

                <span class="nv">A</span> <span class="s s-Atom">list</span> <span class="s s-Atom">of</span> <span class="s s-Atom">two</span> <span class="s s-Atom">numbers</span> <span class="s s-Atom">defining</span> <span class="s s-Atom">the</span> <span class="s s-Atom">lower</span> <span class="s s-Atom">and</span> <span class="s s-Atom">upper</span> <span class="s s-Atom">bounds</span> <span class="s s-Atom">of</span> <span class="s s-Atom">the</span> <span class="nv">CVs</span> <span class="p">(</span><span class="s s-Atom">in</span> <span class="s s-Atom">the</span> <span class="s s-Atom">units</span> <span class="s s-Atom">of</span> <span class="s s-Atom">the</span> <span class="nv">CV</span><span class="p">).</span> <span class="s s-Atom">\</span>

                <span class="nv">Defaults</span> <span class="s s-Atom">to</span> <span class="nv">None</span><span class="p">.</span> <span class="s s-Atom">\</span>

            <span class="nf">time_min</span> <span class="p">(</span><span class="s s-Atom">int</span><span class="p">)</span><span class="o">:</span> <span class="nv">The</span> <span class="s s-Atom">starting</span> <span class="s s-Atom">time</span> <span class="s s-Atom">step</span> <span class="s s-Atom">of</span> <span class="s s-Atom">simulation</span><span class="p">.</span> <span class="nv">Defaults</span> <span class="s s-Atom">to</span> <span class="mf">0.</span>

            <span class="nf">time_max</span> <span class="p">(</span><span class="s s-Atom">int</span><span class="p">,</span> <span class="s s-Atom">optional</span><span class="p">)</span><span class="o">:</span> <span class="nv">The</span> <span class="s s-Atom">ending</span> <span class="s s-Atom">time</span> <span class="s s-Atom">step</span> <span class="s s-Atom">of</span> <span class="s s-Atom">simulation</span><span class="p">.</span> <span class="nv">Defaults</span> <span class="s s-Atom">to</span> <span class="nv">None</span><span class="p">.</span>

        <span class="s2">&quot;&quot;&quot;</span>

<span class="s2">        if resolution is None:</span>

<span class="s2">            resolution = self.res</span>

<span class="s2">        self.generate_cv_map(cv_select, cv_range)</span>

<span class="s2">        cv_min = self.cv_min</span>

<span class="s2">        cv_max = self.cv_max</span>

<span class="s2">        cv_fes_range = self.cv_fes_range</span>

<span class="s2">        cvs = len(self.cv_select)</span>

<span class="s2">        fes = np.zeros([resolution] * cvs)</span>

<span class="s2">        if time_min and time_max:</span>

<span class="s2">            time_limit = time_max - time_min</span>

<span class="s2">        else:</span>

<span class="s2">            time_min = 0</span>

<span class="s2">            time_max = self.hills.cv[:, 0].shape[0]</span>

<span class="s2">            time_limit = time_max - time_min</span>

<span class="s2">        for index in tqdm(np.ndindex(fes.shape),  # type: ignore</span>

<span class="s2">                          desc=&quot;</span><span class="nv">Constructing</span> <span class="nv">FES</span><span class="err">&quot;</span><span class="p">,</span>

                          <span class="s s-Atom">total</span><span class="o">=</span><span class="s s-Atom">np</span><span class="p">.</span><span class="nf">prod</span><span class="p">(</span><span class="s s-Atom">fes</span><span class="p">.</span><span class="s s-Atom">shape</span><span class="p">))</span><span class="o">:</span>  <span class="s s-Atom">#</span> <span class="s s-Atom">type</span><span class="p">:</span> <span class="s s-Atom">ignore</span>

            <span class="s s-Atom">dp2_array</span> <span class="o">=</span> <span class="s s-Atom">np</span><span class="p">.</span><span class="nf">zeros</span><span class="p">([</span><span class="s s-Atom">cvs</span><span class="p">,</span> <span class="s s-Atom">time_limit</span><span class="p">])</span>

            <span class="s s-Atom">for</span> <span class="s s-Atom">i</span><span class="p">,</span> <span class="s s-Atom">cv_idx</span> <span class="s s-Atom">in</span> <span class="nf">enumerate</span><span class="p">(</span><span class="s s-Atom">self</span><span class="p">.</span><span class="s s-Atom">cv_select</span><span class="p">)</span><span class="o">:</span>

                <span class="s s-Atom">dist_cv</span> <span class="o">=</span> <span class="s s-Atom">\</span>

                    <span class="s s-Atom">self</span><span class="p">.</span><span class="s s-Atom">hills</span><span class="p">.</span><span class="s s-Atom">cv</span><span class="p">[</span><span class="o">:</span><span class="p">,</span> <span class="s s-Atom">cv_idx</span><span class="p">]</span> <span class="o">-</span> <span class="s s-Atom">\</span>

                    <span class="p">(</span><span class="s s-Atom">cv_min</span><span class="p">[</span><span class="s s-Atom">i</span><span class="p">]</span> <span class="o">+</span> <span class="s s-Atom">index</span><span class="p">[</span><span class="s s-Atom">i</span><span class="p">]</span> <span class="o">*</span> <span class="s s-Atom">cv_fes_range</span><span class="p">[</span><span class="s s-Atom">i</span><span class="p">]</span> <span class="o">/</span> <span class="s s-Atom">resolution</span><span class="p">)</span>

                <span class="s s-Atom">if</span> <span class="s s-Atom">self</span><span class="p">.</span><span class="s s-Atom">periodic</span><span class="p">[</span><span class="s s-Atom">cv_idx</span><span class="p">]</span><span class="o">:</span>

                    <span class="s s-Atom">dist_cv</span><span class="p">[</span><span class="s s-Atom">dist_cv</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mf">0.5</span><span class="o">*</span><span class="s s-Atom">cv_fes_range</span><span class="p">[</span><span class="s s-Atom">i</span><span class="p">]]</span> <span class="s s-Atom">+=</span> <span class="s s-Atom">cv_fes_range</span><span class="p">[</span><span class="s s-Atom">i</span><span class="p">]</span>

                    <span class="s s-Atom">dist_cv</span><span class="p">[</span><span class="s s-Atom">dist_cv</span> <span class="o">&gt;</span> <span class="o">+</span><span class="mf">0.5</span><span class="o">*</span><span class="s s-Atom">cv_fes_range</span><span class="p">[</span><span class="s s-Atom">i</span><span class="p">]]</span> <span class="s s-Atom">-=</span> <span class="s s-Atom">cv_fes_range</span><span class="p">[</span><span class="s s-Atom">i</span><span class="p">]</span>

                <span class="s s-Atom">dp2_local</span> <span class="o">=</span> <span class="s s-Atom">dist_cv</span> <span class="s s-Atom">**</span> <span class="mi">2</span> <span class="o">/</span> <span class="s s-Atom">\</span>

                    <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="s s-Atom">self</span><span class="p">.</span><span class="s s-Atom">hills</span><span class="p">.</span><span class="s s-Atom">sigma</span><span class="p">[</span><span class="s s-Atom">cv_idx</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="s s-Atom">**</span> <span class="mi">2</span><span class="p">)</span>

                <span class="s s-Atom">dp2_array</span><span class="p">[</span><span class="s s-Atom">i</span><span class="p">]</span> <span class="o">=</span> <span class="s s-Atom">dp2_local</span>

            <span class="s s-Atom">dp2</span> <span class="o">=</span> <span class="s s-Atom">np</span><span class="p">.</span><span class="nf">sum</span><span class="p">(</span><span class="s s-Atom">dp2_array</span><span class="p">,</span> <span class="s s-Atom">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

            <span class="s s-Atom">tmp</span> <span class="o">=</span> <span class="s s-Atom">np</span><span class="p">.</span><span class="nf">zeros</span><span class="p">(</span><span class="s s-Atom">time_limit</span><span class="p">)</span>

            <span class="s s-Atom">tmp</span><span class="p">[</span><span class="s s-Atom">dp2</span> <span class="o">&lt;</span> <span class="mf">6.25</span><span class="p">]</span> <span class="o">=</span> <span class="s s-Atom">self</span><span class="p">.</span><span class="s s-Atom">hills</span><span class="p">.</span><span class="s s-Atom">heights</span><span class="p">[</span><span class="s s-Atom">dp2</span> <span class="o">&lt;</span> <span class="mf">6.25</span><span class="p">]</span> <span class="o">*</span> <span class="s s-Atom">\</span>

                <span class="p">(</span><span class="s s-Atom">np</span><span class="p">.</span><span class="nf">exp</span><span class="p">(</span><span class="o">-</span><span class="s s-Atom">dp2</span><span class="p">[</span><span class="s s-Atom">dp2</span> <span class="o">&lt;</span> <span class="mf">6.25</span><span class="p">])</span> <span class="o">*</span>

                 <span class="mf">1.00193418799744762399</span> <span class="o">-</span> <span class="mf">0.00193418799744762399</span><span class="p">)</span>

            <span class="s s-Atom">fes</span><span class="p">[</span><span class="s s-Atom">index</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="s s-Atom">tmp</span><span class="p">.</span><span class="nf">sum</span><span class="p">()</span>

        <span class="s s-Atom">fes</span> <span class="o">=</span> <span class="s s-Atom">fes</span> <span class="o">-</span> <span class="s s-Atom">np</span><span class="p">.</span><span class="nf">min</span><span class="p">(</span><span class="s s-Atom">fes</span><span class="p">)</span>

        <span class="s s-Atom">self</span><span class="p">.</span><span class="s s-Atom">fes</span> <span class="o">=</span> <span class="s s-Atom">np</span><span class="p">.</span><span class="nf">array</span><span class="p">(</span><span class="s s-Atom">fes</span><span class="p">)</span>

    <span class="s s-Atom">def</span> <span class="nf">plot</span><span class="p">(</span>

        <span class="s s-Atom">self</span><span class="p">,</span>

        <span class="s s-Atom">png_name</span><span class="o">:</span> <span class="nv">Optional</span><span class="p">[</span><span class="s s-Atom">str</span><span class="p">]</span> <span class="o">=</span> <span class="nv">None</span><span class="p">,</span>

        <span class="s s-Atom">contours</span><span class="p">:</span> <span class="s s-Atom">bool</span> <span class="o">=</span> <span class="nv">True</span><span class="p">,</span>

        <span class="s s-Atom">contours_spacing</span><span class="o">:</span> <span class="s s-Atom">float</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span>

        <span class="s s-Atom">aspect</span><span class="p">:</span> <span class="s s-Atom">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>

        <span class="s s-Atom">cmap</span><span class="p">:</span> <span class="s s-Atom">str</span> <span class="o">=</span> <span class="s2">&quot;jet&quot;</span><span class="p">,</span>

        <span class="s s-Atom">energy_unit</span><span class="o">:</span> <span class="s s-Atom">str</span> <span class="o">=</span> <span class="s2">&quot;kJ/mol&quot;</span><span class="p">,</span>

        <span class="s s-Atom">xlabel</span><span class="p">:</span> <span class="nv">Optional</span><span class="p">[</span><span class="s s-Atom">str</span><span class="p">]</span> <span class="o">=</span> <span class="nv">None</span><span class="p">,</span>

        <span class="s s-Atom">ylabel</span><span class="p">:</span> <span class="nv">Optional</span><span class="p">[</span><span class="s s-Atom">str</span><span class="p">]</span> <span class="o">=</span> <span class="nv">None</span><span class="p">,</span>

        <span class="s s-Atom">zlabel</span><span class="p">:</span> <span class="nv">Optional</span><span class="p">[</span><span class="s s-Atom">str</span><span class="p">]</span> <span class="o">=</span> <span class="nv">None</span><span class="p">,</span>

        <span class="s s-Atom">label_size</span><span class="o">:</span> <span class="s s-Atom">int</span> <span class="o">=</span> <span class="mi">12</span><span class="p">,</span>

        <span class="s s-Atom">image_size</span><span class="o">:</span> <span class="nv">List</span><span class="p">[</span><span class="s s-Atom">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">7</span><span class="p">],</span>

        <span class="s s-Atom">vmin</span><span class="p">:</span> <span class="s s-Atom">float</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>

        <span class="s s-Atom">vmax</span><span class="p">:</span> <span class="nv">Optional</span><span class="p">[</span><span class="s s-Atom">float</span><span class="p">]</span> <span class="o">=</span> <span class="nv">None</span><span class="p">,</span>

        <span class="s s-Atom">opacity</span><span class="p">:</span> <span class="s s-Atom">float</span> <span class="o">=</span> <span class="mf">0.2</span><span class="p">,</span>

        <span class="s s-Atom">levels</span><span class="p">:</span> <span class="nv">Optional</span><span class="p">[</span><span class="nv">List</span><span class="p">[</span><span class="s s-Atom">float</span><span class="p">]]</span> <span class="o">=</span> <span class="nv">None</span><span class="p">,</span>

    <span class="p">)</span><span class="o">:</span>

        <span class="s2">&quot;&quot;&quot;</span>

<span class="s2">        Visualizes the free energy surface (FES) using Matplotlib and PyVista.</span>

<span class="s2">        Usage:</span>

<span class="s2">        ```python</span>

<span class="s2">        fes.plot()</span>

<span class="s2">        ```</span>

<span class="s2">        Args:</span>

<span class="s2">            png_name (str, optional): If provided, the picture of FES will be saved under this name in the current working directory.</span>

<span class="s2">            contours (bool, default=True): Determines whether contours should be shown on the 2D FES.</span>

<span class="s2">            contours_spacing (float, default=0.0): When a positive number is set, it will be used as the spacing for contours on the 2D FES. Otherwise, if contours=True, there will be five equally spaced contour levels.</span>

<span class="s2">            aspect (float, default=1.0): The aspect ratio of the graph. Works with 1D and 2D FES.</span>

<span class="s2">            cmap (str, default=&quot;</span><span class="s s-Atom">jet</span><span class="s2">&quot;): The Matplotlib colormap used to color the 2D or 3D FES.</span>

<span class="s2">            energy_unit (str, default=&quot;</span><span class="s s-Atom">kJ</span><span class="o">/</span><span class="s s-Atom">mol</span><span class="s2">&quot;): The unit used in the description of the colorbar.</span>

<span class="s2">            xlabel, ylabel, zlabel (str, optional): If provided, they will be used as labels for the graphs.</span>

<span class="s2">            label_size (int, default=12): The size of text in the labels.</span>

<span class="s2">            image_size (List[int], default=[10,7]): The width and height of the picture.</span>

<span class="s2">            vmin (float, default=0): The lower bound for the colormap on the 2D FES.</span>

<span class="s2">            vmax (float, optional): The upper bound for the colormap on the 2D FES.</span>

<span class="s2">            opacity (float, default=0.2): A number between 0 and 1 that represents the opacity of isosurfaces in the 3D FES.</span>

<span class="s2">            levels (List[float], optional): A list of free energy values for isosurfaces in the 3D FES. If not provided, default values from the contours parameters will be used instead.</span>

<span class="s2">        &quot;&quot;&quot;</span>

        <span class="s s-Atom">import</span> <span class="s s-Atom">matplotlib</span><span class="p">.</span><span class="s s-Atom">cm</span> <span class="s s-Atom">as</span> <span class="s s-Atom">cm</span>

        <span class="s s-Atom">import</span> <span class="s s-Atom">matplotlib</span><span class="p">.</span><span class="s s-Atom">pyplot</span> <span class="s s-Atom">as</span> <span class="s s-Atom">plt</span>

        <span class="s s-Atom">if</span> <span class="s s-Atom">self</span><span class="p">.</span><span class="s s-Atom">fes</span> <span class="o">is</span> <span class="nv">None</span><span class="o">:</span>

            <span class="s s-Atom">raise</span> <span class="nv">ValueError</span><span class="p">(</span>

                <span class="s2">&quot;FES not calculated yet. Use makefes() or makefes2() first.&quot;</span><span class="p">)</span>

        <span class="s s-Atom">if</span> <span class="s s-Atom">vmax</span> <span class="o">==</span> <span class="nv">None</span><span class="o">:</span>

            <span class="s s-Atom">#</span> <span class="s s-Atom">if</span> <span class="s s-Atom">the</span> <span class="s s-Atom">addition</span> <span class="o">is</span> <span class="s s-Atom">smaller</span> <span class="s s-Atom">than</span> <span class="mf">0.01</span><span class="p">,</span> <span class="s s-Atom">the</span> <span class="mi">3</span><span class="s s-Atom">d</span> <span class="s s-Atom">plot</span> <span class="s s-Atom">stops</span> <span class="s s-Atom">working</span><span class="p">.</span>

            <span class="s s-Atom">vmax</span> <span class="o">=</span> <span class="s s-Atom">np</span><span class="p">.</span><span class="nf">max</span><span class="p">(</span><span class="s s-Atom">self</span><span class="p">.</span><span class="s s-Atom">fes</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.01</span>

        <span class="s s-Atom">if</span> <span class="s s-Atom">contours_spacing</span> <span class="o">==</span> <span class="mf">0.0</span><span class="o">:</span>

            <span class="s s-Atom">contours_spacing</span> <span class="o">=</span> <span class="p">(</span><span class="s s-Atom">vmax</span><span class="o">-</span><span class="s s-Atom">vmin</span><span class="p">)</span><span class="o">/</span><span class="mf">5.0</span>

        <span class="s s-Atom">cmap</span> <span class="o">=</span> <span class="s s-Atom">cm</span><span class="p">.</span><span class="nf">get_cmap</span><span class="p">(</span><span class="s s-Atom">cmap</span><span class="p">)</span>

        <span class="s s-Atom">cmap</span><span class="p">.</span><span class="nf">set_over</span><span class="p">(</span><span class="s2">&quot;white&quot;</span><span class="p">)</span>

        <span class="s s-Atom">cmap</span><span class="p">.</span><span class="nf">set_under</span><span class="p">(</span><span class="s2">&quot;white&quot;</span><span class="p">)</span>

        <span class="s s-Atom">cvs</span> <span class="o">=</span> <span class="nf">len</span><span class="p">(</span><span class="s s-Atom">self</span><span class="p">.</span><span class="s s-Atom">cv_select</span><span class="p">)</span>

        <span class="s s-Atom">if</span> <span class="s s-Atom">cvs</span> <span class="o">==</span> <span class="mi">1</span><span class="o">:</span>

            <span class="s s-Atom">cv_index</span> <span class="o">=</span> <span class="s s-Atom">self</span><span class="p">.</span><span class="s s-Atom">cv_select</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

            <span class="s s-Atom">plt</span><span class="p">.</span><span class="nf">figure</span><span class="p">(</span><span class="s s-Atom">figsize=</span><span class="p">(</span><span class="s s-Atom">image_size</span><span class="p">[</span><span class="s s-Atom">cv_index</span><span class="p">],</span> <span class="s s-Atom">image_size</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>

            <span class="nv">X</span> <span class="o">=</span> <span class="s s-Atom">np</span><span class="p">.</span><span class="nf">linspace</span><span class="p">(</span><span class="s s-Atom">self</span><span class="p">.</span><span class="s s-Atom">cv_min</span><span class="p">[</span><span class="s s-Atom">cv_index</span><span class="p">],</span>

                            <span class="s s-Atom">self</span><span class="p">.</span><span class="s s-Atom">cv_max</span><span class="p">[</span><span class="s s-Atom">cv_index</span><span class="p">],</span> <span class="s s-Atom">self</span><span class="p">.</span><span class="s s-Atom">res</span><span class="p">)</span>

            <span class="s s-Atom">plt</span><span class="p">.</span><span class="nf">plot</span><span class="p">(</span><span class="nv">X</span><span class="p">,</span> <span class="s s-Atom">self</span><span class="p">.</span><span class="s s-Atom">fes</span><span class="p">)</span>

            <span class="s s-Atom">if</span> <span class="s s-Atom">xlabel</span> <span class="o">==</span> <span class="nv">None</span><span class="o">:</span>

                <span class="s s-Atom">plt</span><span class="p">.</span><span class="nf">xlabel</span><span class="p">(</span>

                    <span class="s s-Atom">f&#39;CV1 - {self.hills.cv_name[cv_index]}&#39;</span><span class="p">,</span> <span class="s s-Atom">size</span><span class="o">=</span><span class="s s-Atom">label_size</span><span class="p">)</span>

            <span class="s s-Atom">else</span><span class="p">:</span>

                <span class="s s-Atom">plt</span><span class="p">.</span><span class="nf">xlabel</span><span class="p">(</span><span class="s s-Atom">xlabel</span><span class="p">,</span> <span class="s s-Atom">size</span><span class="o">=</span><span class="s s-Atom">label_size</span><span class="p">)</span>

            <span class="s s-Atom">if</span> <span class="s s-Atom">ylabel</span> <span class="o">==</span> <span class="nv">None</span><span class="o">:</span>

                <span class="s s-Atom">plt</span><span class="p">.</span><span class="nf">ylabel</span><span class="p">(</span><span class="s s-Atom">f&#39;free energy ({energy_unit})&#39;</span><span class="p">,</span> <span class="s s-Atom">size</span><span class="o">=</span><span class="s s-Atom">label_size</span><span class="p">)</span>

            <span class="s s-Atom">else</span><span class="p">:</span>

                <span class="s s-Atom">plt</span><span class="p">.</span><span class="nf">ylabel</span><span class="p">(</span><span class="s s-Atom">ylabel</span><span class="p">,</span> <span class="s s-Atom">size</span><span class="o">=</span><span class="s s-Atom">label_size</span><span class="p">)</span>

        <span class="s s-Atom">elif</span> <span class="s s-Atom">cvs</span> <span class="o">==</span> <span class="mi">2</span><span class="o">:</span>

            <span class="s s-Atom">cv1_index</span> <span class="o">=</span> <span class="s s-Atom">self</span><span class="p">.</span><span class="s s-Atom">cv_select</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

            <span class="s s-Atom">cv2_index</span> <span class="o">=</span> <span class="s s-Atom">self</span><span class="p">.</span><span class="s s-Atom">cv_select</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

            <span class="s s-Atom">cv1min</span> <span class="o">=</span> <span class="s s-Atom">self</span><span class="p">.</span><span class="s s-Atom">cv_min</span><span class="p">[</span><span class="s s-Atom">self</span><span class="p">.</span><span class="s s-Atom">cv_select</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>

            <span class="s s-Atom">cv1max</span> <span class="o">=</span> <span class="s s-Atom">self</span><span class="p">.</span><span class="s s-Atom">cv_max</span><span class="p">[</span><span class="s s-Atom">self</span><span class="p">.</span><span class="s s-Atom">cv_select</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>

            <span class="s s-Atom">cv2min</span> <span class="o">=</span> <span class="s s-Atom">self</span><span class="p">.</span><span class="s s-Atom">cv_min</span><span class="p">[</span><span class="s s-Atom">self</span><span class="p">.</span><span class="s s-Atom">cv_select</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>

            <span class="s s-Atom">cv2max</span> <span class="o">=</span> <span class="s s-Atom">self</span><span class="p">.</span><span class="s s-Atom">cv_max</span><span class="p">[</span><span class="s s-Atom">self</span><span class="p">.</span><span class="s s-Atom">cv_select</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>

            <span class="s s-Atom">fig</span> <span class="o">=</span> <span class="s s-Atom">plt</span><span class="p">.</span><span class="nf">figure</span><span class="p">(</span><span class="s s-Atom">figsize=</span><span class="p">(</span><span class="s s-Atom">image_size</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s s-Atom">image_size</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>

            <span class="s s-Atom">plt</span><span class="p">.</span><span class="nf">imshow</span><span class="p">(</span><span class="s s-Atom">np</span><span class="p">.</span><span class="nf">rot90</span><span class="p">(</span><span class="s s-Atom">self</span><span class="p">.</span><span class="s s-Atom">fes</span><span class="p">,</span> <span class="s s-Atom">axes=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)),</span> <span class="s s-Atom">cmap</span><span class="o">=</span><span class="s s-Atom">cmap</span><span class="p">,</span> <span class="s s-Atom">interpolation=&#39;nearest&#39;</span><span class="p">,</span>

                       <span class="s s-Atom">extent</span><span class="o">=</span><span class="p">[</span><span class="s s-Atom">cv1min</span><span class="p">,</span> <span class="s s-Atom">cv1max</span><span class="p">,</span> <span class="s s-Atom">cv2min</span><span class="p">,</span> <span class="s s-Atom">cv2max</span><span class="p">],</span>

                       <span class="s s-Atom">aspect=</span><span class="p">(((</span><span class="s s-Atom">cv1max</span><span class="o">-</span><span class="s s-Atom">cv1min</span><span class="p">)</span><span class="s s-Atom">/</span><span class="p">(</span><span class="s s-Atom">cv2max</span><span class="o">-</span><span class="s s-Atom">cv2min</span><span class="p">))</span><span class="s s-Atom">/</span><span class="p">(</span><span class="s s-Atom">aspect</span><span class="p">)),</span>

                       <span class="s s-Atom">vmin</span><span class="o">=</span><span class="s s-Atom">vmin</span><span class="p">,</span> <span class="s s-Atom">vmax</span><span class="o">=</span><span class="s s-Atom">vmax</span><span class="p">)</span>  <span class="s s-Atom">#</span> <span class="s s-Atom">type</span><span class="p">:</span> <span class="s s-Atom">ignore</span>

            <span class="s s-Atom">cbar</span> <span class="o">=</span> <span class="s s-Atom">plt</span><span class="p">.</span><span class="nf">colorbar</span><span class="p">()</span>

            <span class="s s-Atom">cbar</span><span class="p">.</span><span class="nf">set_label</span><span class="p">(</span><span class="s s-Atom">energy_unit</span><span class="p">,</span> <span class="s s-Atom">size</span><span class="o">=</span><span class="s s-Atom">label_size</span><span class="p">)</span>

            <span class="s s-Atom">if</span> <span class="s s-Atom">contours</span><span class="p">:</span>

                <span class="s s-Atom">cont</span> <span class="o">=</span> <span class="s s-Atom">plt</span><span class="p">.</span><span class="nf">contour</span><span class="p">(</span><span class="s s-Atom">np</span><span class="p">.</span><span class="nf">rot90</span><span class="p">(</span><span class="s s-Atom">self</span><span class="p">.</span><span class="s s-Atom">fes</span><span class="p">,</span> <span class="s s-Atom">axes=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)),</span>

                                   <span class="s s-Atom">levels</span><span class="o">=</span><span class="s s-Atom">np</span><span class="p">.</span><span class="nf">arange</span><span class="p">(</span>

                                       <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="s s-Atom">vmax</span> <span class="o">-</span> <span class="mf">0.01</span><span class="p">),</span> <span class="s s-Atom">contours_spacing</span><span class="p">),</span>

                                   <span class="s s-Atom">extent</span><span class="o">=</span><span class="p">[</span><span class="s s-Atom">cv1min</span><span class="p">,</span> <span class="s s-Atom">cv1max</span><span class="p">,</span> <span class="s s-Atom">cv2max</span><span class="p">,</span> <span class="s s-Atom">cv2min</span><span class="p">],</span>

                                   <span class="s s-Atom">colors=</span><span class="s2">&quot;k&quot;</span><span class="p">)</span>

                <span class="s s-Atom">plt</span><span class="p">.</span><span class="nf">clabel</span><span class="p">(</span><span class="s s-Atom">cont</span><span class="p">,</span> <span class="s s-Atom">levels</span><span class="o">=</span><span class="s s-Atom">np</span><span class="p">.</span><span class="nf">arange</span><span class="p">(</span>

                    <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="s s-Atom">vmax</span> <span class="o">-</span> <span class="mf">0.01</span><span class="p">),</span> <span class="s s-Atom">contours_spacing</span><span class="p">))</span>

            <span class="s s-Atom">if</span> <span class="s s-Atom">xlabel</span> <span class="o">==</span> <span class="nv">None</span><span class="o">:</span>

                <span class="s s-Atom">plt</span><span class="p">.</span><span class="nf">xlabel</span><span class="p">(</span>

                    <span class="s s-Atom">f&#39;CV1 - {self.hills.cv_name[cv1_index]}&#39;</span><span class="p">,</span> <span class="s s-Atom">size</span><span class="o">=</span><span class="s s-Atom">label_size</span><span class="p">)</span>

            <span class="s s-Atom">else</span><span class="p">:</span>

                <span class="s s-Atom">plt</span><span class="p">.</span><span class="nf">xlabel</span><span class="p">(</span><span class="s s-Atom">xlabel</span><span class="p">,</span> <span class="s s-Atom">size</span><span class="o">=</span><span class="s s-Atom">label_size</span><span class="p">)</span>

            <span class="s s-Atom">if</span> <span class="s s-Atom">ylabel</span> <span class="o">==</span> <span class="nv">None</span><span class="o">:</span>

                <span class="s s-Atom">plt</span><span class="p">.</span><span class="nf">ylabel</span><span class="p">(</span>

                    <span class="s s-Atom">f&#39;CV2 - {self.hills.cv_name[cv2_index]}&#39;</span><span class="p">,</span> <span class="s s-Atom">size</span><span class="o">=</span><span class="s s-Atom">label_size</span><span class="p">)</span>

            <span class="s s-Atom">else</span><span class="p">:</span>

                <span class="s s-Atom">plt</span><span class="p">.</span><span class="nf">ylabel</span><span class="p">(</span><span class="s s-Atom">ylabel</span><span class="p">,</span> <span class="s s-Atom">size</span><span class="o">=</span><span class="s s-Atom">label_size</span><span class="p">)</span>

        <span class="s s-Atom">elif</span> <span class="s s-Atom">cvs</span> <span class="o">==</span> <span class="mi">3</span><span class="o">:</span>

            <span class="s s-Atom">try</span><span class="p">:</span>

                <span class="s s-Atom">import</span> <span class="s s-Atom">pyvista</span> <span class="s s-Atom">as</span> <span class="s s-Atom">pv</span>

            <span class="nf">except</span> <span class="p">(</span><span class="nv">ImportError</span><span class="p">,</span> <span class="nv">ModuleNotFoundError</span><span class="p">)</span> <span class="s s-Atom">as</span> <span class="s s-Atom">e</span><span class="p">:</span>

                <span class="nf">print</span><span class="p">(</span><span class="s s-Atom">e</span><span class="p">)</span>

                <span class="s s-Atom">sys</span><span class="p">.</span><span class="nf">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

            <span class="s s-Atom">cv1_index</span> <span class="o">=</span> <span class="s s-Atom">self</span><span class="p">.</span><span class="s s-Atom">cv_select</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

            <span class="s s-Atom">cv2_index</span> <span class="o">=</span> <span class="s s-Atom">self</span><span class="p">.</span><span class="s s-Atom">cv_select</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

            <span class="s s-Atom">cv3_index</span> <span class="o">=</span> <span class="s s-Atom">self</span><span class="p">.</span><span class="s s-Atom">cv_select</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

            <span class="s s-Atom">cv1min</span> <span class="o">=</span> <span class="s s-Atom">self</span><span class="p">.</span><span class="s s-Atom">cv_min</span><span class="p">[</span><span class="s s-Atom">self</span><span class="p">.</span><span class="s s-Atom">cv_select</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>

            <span class="s s-Atom">cv1max</span> <span class="o">=</span> <span class="s s-Atom">self</span><span class="p">.</span><span class="s s-Atom">cv_max</span><span class="p">[</span><span class="s s-Atom">self</span><span class="p">.</span><span class="s s-Atom">cv_select</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>

            <span class="s s-Atom">cv2min</span> <span class="o">=</span> <span class="s s-Atom">self</span><span class="p">.</span><span class="s s-Atom">cv_min</span><span class="p">[</span><span class="s s-Atom">self</span><span class="p">.</span><span class="s s-Atom">cv_select</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>

            <span class="s s-Atom">cv2max</span> <span class="o">=</span> <span class="s s-Atom">self</span><span class="p">.</span><span class="s s-Atom">cv_max</span><span class="p">[</span><span class="s s-Atom">self</span><span class="p">.</span><span class="s s-Atom">cv_select</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>

            <span class="s s-Atom">cv3min</span> <span class="o">=</span> <span class="s s-Atom">self</span><span class="p">.</span><span class="s s-Atom">cv_min</span><span class="p">[</span><span class="s s-Atom">self</span><span class="p">.</span><span class="s s-Atom">cv_select</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span>

            <span class="s s-Atom">cv3max</span> <span class="o">=</span> <span class="s s-Atom">self</span><span class="p">.</span><span class="s s-Atom">cv_max</span><span class="p">[</span><span class="s s-Atom">self</span><span class="p">.</span><span class="s s-Atom">cv_select</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span>

            <span class="s s-Atom">if</span> <span class="s s-Atom">xlabel</span> <span class="o">==</span> <span class="nv">None</span><span class="o">:</span>

                <span class="s s-Atom">xlabel</span> <span class="o">=</span> <span class="s2">&quot;CV1 - &quot;</span> <span class="o">+</span> <span class="s s-Atom">self</span><span class="p">.</span><span class="s s-Atom">hills</span><span class="p">.</span><span class="s s-Atom">cv_name</span><span class="p">[</span><span class="s s-Atom">cv1_index</span><span class="p">]</span>

            <span class="s s-Atom">if</span> <span class="s s-Atom">ylabel</span> <span class="o">==</span> <span class="nv">None</span><span class="o">:</span>

                <span class="s s-Atom">ylabel</span> <span class="o">=</span> <span class="s2">&quot;CV2 - &quot;</span> <span class="o">+</span> <span class="s s-Atom">self</span><span class="p">.</span><span class="s s-Atom">hills</span><span class="p">.</span><span class="s s-Atom">cv_name</span><span class="p">[</span><span class="s s-Atom">cv2_index</span><span class="p">]</span>

            <span class="s s-Atom">if</span> <span class="s s-Atom">zlabel</span> <span class="o">==</span> <span class="nv">None</span><span class="o">:</span>

                <span class="s s-Atom">zlabel</span> <span class="o">=</span> <span class="s2">&quot;CV3 - &quot;</span> <span class="o">+</span> <span class="s s-Atom">self</span><span class="p">.</span><span class="s s-Atom">hills</span><span class="p">.</span><span class="s s-Atom">cv_name</span><span class="p">[</span><span class="s s-Atom">cv3_index</span><span class="p">]</span>

            <span class="s s-Atom">grid</span> <span class="o">=</span> <span class="s s-Atom">pv</span><span class="p">.</span><span class="nv">UniformGrid</span><span class="p">(</span>

                <span class="s s-Atom">dimensions=</span><span class="p">(</span><span class="s s-Atom">self</span><span class="p">.</span><span class="s s-Atom">res</span><span class="p">,</span> <span class="s s-Atom">self</span><span class="p">.</span><span class="s s-Atom">res</span><span class="p">,</span> <span class="s s-Atom">self</span><span class="p">.</span><span class="s s-Atom">res</span><span class="p">),</span>

                <span class="s s-Atom">spacing=</span><span class="p">((</span><span class="s s-Atom">cv1max</span><span class="o">-</span><span class="s s-Atom">cv1min</span><span class="p">)</span><span class="o">/</span><span class="s s-Atom">self</span><span class="p">.</span><span class="s s-Atom">res</span><span class="p">,</span> <span class="p">(</span><span class="s s-Atom">cv2max</span><span class="o">-</span><span class="s s-Atom">cv2min</span><span class="p">)</span> <span class="o">/</span>

                         <span class="s s-Atom">self</span><span class="p">.</span><span class="s s-Atom">res</span><span class="p">,</span> <span class="p">(</span><span class="s s-Atom">cv3max</span><span class="o">-</span><span class="s s-Atom">cv3min</span><span class="p">)</span><span class="o">/</span><span class="s s-Atom">self</span><span class="p">.</span><span class="s s-Atom">res</span><span class="p">),</span>

                <span class="s s-Atom">origin=</span><span class="p">(</span><span class="s s-Atom">cv1min</span><span class="p">,</span> <span class="s s-Atom">cv2min</span><span class="p">,</span> <span class="s s-Atom">cv3min</span><span class="p">)</span>

            <span class="p">)</span>

            <span class="s s-Atom">grid</span><span class="p">[</span><span class="s2">&quot;vol&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s s-Atom">self</span><span class="p">.</span><span class="s s-Atom">fes</span><span class="p">.</span><span class="nf">ravel</span><span class="p">(</span><span class="s s-Atom">order=</span><span class="s2">&quot;F&quot;</span><span class="p">)</span>

            <span class="s s-Atom">if</span> <span class="s s-Atom">levels</span> <span class="o">==</span> <span class="nv">None</span><span class="o">:</span>

                <span class="s s-Atom">contours</span> <span class="o">=</span> <span class="s s-Atom">grid</span><span class="p">.</span><span class="nf">contour</span><span class="p">(</span>

                    <span class="s s-Atom">np</span><span class="p">.</span><span class="nf">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="s s-Atom">vmax</span> <span class="o">-</span> <span class="mf">0.01</span><span class="p">),</span> <span class="s s-Atom">contours_spacing</span><span class="p">))</span>

            <span class="s s-Atom">else</span><span class="p">:</span>

                <span class="s s-Atom">contours</span> <span class="o">=</span> <span class="s s-Atom">grid</span><span class="p">.</span><span class="nf">contour</span><span class="p">(</span><span class="s s-Atom">levels</span><span class="p">)</span>

            <span class="s s-Atom">fescolors</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="s s-Atom">for</span> <span class="s s-Atom">i</span> <span class="s s-Atom">in</span> <span class="nf">range</span><span class="p">(</span><span class="s s-Atom">contours</span><span class="p">.</span><span class="s s-Atom">points</span><span class="p">.</span><span class="s s-Atom">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">:</span>

                <span class="s s-Atom">fescolors</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="s s-Atom">self</span><span class="p">.</span><span class="s s-Atom">fes</span><span class="p">[</span><span class="nf">int</span><span class="p">((</span><span class="s s-Atom">contours</span><span class="p">.</span><span class="s s-Atom">points</span><span class="p">[</span><span class="s s-Atom">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="s s-Atom">cv1min</span><span class="p">)</span><span class="o">*</span><span class="s s-Atom">self</span><span class="p">.</span><span class="s s-Atom">res/</span><span class="p">(</span><span class="s s-Atom">cv1max</span><span class="o">-</span><span class="s s-Atom">cv1min</span><span class="p">)),</span>

                                          <span class="nf">int</span><span class="p">((</span>

                                              <span class="s s-Atom">contours</span><span class="p">.</span><span class="s s-Atom">points</span><span class="p">[</span><span class="s s-Atom">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="s s-Atom">cv2min</span><span class="p">)</span><span class="o">*</span><span class="s s-Atom">self</span><span class="p">.</span><span class="s s-Atom">res/</span><span class="p">(</span><span class="s s-Atom">cv2max</span><span class="o">-</span><span class="s s-Atom">cv2min</span><span class="p">)),</span>

                                          <span class="nf">int</span><span class="p">((</span><span class="s s-Atom">contours</span><span class="p">.</span><span class="s s-Atom">points</span><span class="p">[</span><span class="s s-Atom">i</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="s s-Atom">cv3min</span><span class="p">)</span><span class="o">*</span><span class="s s-Atom">self</span><span class="p">.</span><span class="s s-Atom">res/</span><span class="p">(</span><span class="s s-Atom">cv3max</span><span class="o">-</span><span class="s s-Atom">cv3min</span><span class="p">))])</span>

            <span class="s s-Atom">#</span> <span class="c1">%% Visualization</span>

            <span class="s s-Atom">pv</span><span class="p">.</span><span class="nf">set_plot_theme</span><span class="p">(</span><span class="s s-Atom">&#39;document&#39;</span><span class="p">)</span>

            <span class="s s-Atom">p</span> <span class="o">=</span> <span class="s s-Atom">pv</span><span class="p">.</span><span class="nv">Plotter</span><span class="p">()</span>

            <span class="s s-Atom">p</span><span class="p">.</span><span class="nf">add_mesh</span><span class="p">(</span><span class="s s-Atom">contours</span><span class="p">,</span> <span class="s s-Atom">scalars</span><span class="o">=</span><span class="s s-Atom">fescolors</span><span class="p">,</span> <span class="s s-Atom">opacity</span><span class="o">=</span><span class="s s-Atom">opacity</span><span class="p">,</span>

                       <span class="s s-Atom">cmap</span><span class="o">=</span><span class="s s-Atom">cmap</span><span class="p">,</span> <span class="s s-Atom">show_scalar_bar</span><span class="o">=</span><span class="nv">False</span><span class="p">,</span> <span class="s s-Atom">interpolate_before_map</span><span class="o">=</span><span class="nv">True</span><span class="p">)</span>

            <span class="s s-Atom">p</span><span class="p">.</span><span class="nf">show_grid</span><span class="p">(</span><span class="s s-Atom">xlabel</span><span class="o">=</span><span class="s s-Atom">xlabel</span><span class="p">,</span> <span class="s s-Atom">ylabel</span><span class="o">=</span><span class="s s-Atom">ylabel</span><span class="p">,</span> <span class="s s-Atom">zlabel</span><span class="o">=</span><span class="s s-Atom">zlabel</span><span class="p">)</span>

            <span class="s s-Atom">p</span><span class="p">.</span><span class="nf">show</span><span class="p">()</span>

        <span class="s s-Atom">else</span><span class="p">:</span>

            <span class="s s-Atom">raise</span> <span class="nv">ValueError</span><span class="p">(</span><span class="s2">&quot;Only 1D, 2D and 3D FES are supported.&quot;</span><span class="p">)</span>

        <span class="s s-Atom">if</span> <span class="s s-Atom">png_name</span> <span class="p">!</span><span class="o">=</span> <span class="nv">None</span><span class="o">:</span>

            <span class="s s-Atom">plt</span><span class="p">.</span><span class="nf">savefig</span><span class="p">(</span><span class="s s-Atom">png_name</span><span class="p">)</span>

    <span class="s s-Atom">def</span> <span class="nf">set_fes</span><span class="p">(</span><span class="s s-Atom">self</span><span class="p">,</span> <span class="s s-Atom">fes</span><span class="p">)</span><span class="o">:</span>

        <span class="s s-Atom">self</span><span class="p">.</span><span class="s s-Atom">fes</span> <span class="o">=</span> <span class="s s-Atom">fes</span>

    <span class="s s-Atom">def</span> <span class="nf">surface_plot</span><span class="p">(</span>

        <span class="s s-Atom">self</span><span class="p">,</span>

        <span class="s s-Atom">cv_select</span><span class="o">:</span> <span class="nv">Optional</span><span class="p">[</span><span class="nv">None</span><span class="p">]</span> <span class="o">=</span> <span class="nv">None</span><span class="p">,</span>

        <span class="s s-Atom">cv_range</span><span class="o">:</span> <span class="nv">Optional</span><span class="p">[</span><span class="nv">None</span><span class="p">]</span> <span class="o">=</span> <span class="nv">None</span><span class="p">,</span>

        <span class="s s-Atom">cmap</span><span class="p">:</span> <span class="s s-Atom">str</span> <span class="o">=</span> <span class="s2">&quot;jet&quot;</span><span class="p">,</span>

        <span class="s s-Atom">energy_unit</span><span class="o">:</span> <span class="s s-Atom">str</span> <span class="o">=</span> <span class="s2">&quot;kJ/mol&quot;</span><span class="p">,</span>

        <span class="s s-Atom">xlabel</span><span class="p">:</span> <span class="nv">Optional</span><span class="p">[</span><span class="s s-Atom">str</span><span class="p">]</span> <span class="o">=</span> <span class="nv">None</span><span class="p">,</span>

        <span class="s s-Atom">ylabel</span><span class="p">:</span> <span class="nv">Optional</span><span class="p">[</span><span class="s s-Atom">str</span><span class="p">]</span> <span class="o">=</span> <span class="nv">None</span><span class="p">,</span>

        <span class="s s-Atom">zlabel</span><span class="p">:</span> <span class="nv">Optional</span><span class="p">[</span><span class="s s-Atom">str</span><span class="p">]</span> <span class="o">=</span> <span class="nv">None</span><span class="p">,</span>

        <span class="s s-Atom">label_size</span><span class="o">:</span> <span class="s s-Atom">int</span> <span class="o">=</span> <span class="mi">12</span><span class="p">,</span>

        <span class="s s-Atom">image_size</span><span class="o">:</span> <span class="nv">List</span><span class="p">[</span><span class="s s-Atom">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">12</span><span class="p">,</span> <span class="mi">7</span><span class="p">],</span>

        <span class="s s-Atom">rstride</span><span class="p">:</span> <span class="s s-Atom">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>

        <span class="s s-Atom">cstride</span><span class="p">:</span> <span class="s s-Atom">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>

        <span class="s s-Atom">vmin</span><span class="p">:</span> <span class="s s-Atom">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>

        <span class="s s-Atom">vmax</span><span class="p">:</span> <span class="nv">Optional</span><span class="p">[</span><span class="s s-Atom">int</span><span class="p">]</span> <span class="o">=</span> <span class="nv">None</span><span class="p">,</span>

    <span class="p">)</span><span class="o">:</span>

        <span class="s2">&quot;&quot;&quot;</span>

<span class="s2">        Visualizes the 2D free energy surface (FES) as a 3D surface plot using Matplotlib.</span>

<span class="s2">        Note: Interactivity is currently limited to jupyter notebook or jupyter lab in `%matplotlib widget` mode. Otherwise, it is a static image of the 3D surface plot.</span>

<span class="s2">        Usage:</span>

<span class="s2">        ```python</span>

<span class="s2">        %matplotlib widget</span>

<span class="s2">        fes.surface_plot()</span>

<span class="s2">        ```</span>

<span class="s2">        Future plans include implementing this function using PyVista. However, in the current version of PyVista (0.38.5), there is an issue with labels on the 3rd axis for free energy showing wrong values.</span>

<span class="s2">        &quot;&quot;&quot;</span>

        <span class="s s-Atom">import</span> <span class="s s-Atom">matplotlib</span><span class="p">.</span><span class="s s-Atom">pyplot</span> <span class="s s-Atom">as</span> <span class="s s-Atom">plt</span>

        <span class="s s-Atom">if</span> <span class="s s-Atom">cv_select</span> <span class="o">is</span> <span class="nv">None</span><span class="o">:</span>

            <span class="s s-Atom">cv_select</span> <span class="o">=</span> <span class="nf">list</span><span class="p">(</span><span class="nf">range</span><span class="p">(</span><span class="s s-Atom">self</span><span class="p">.</span><span class="s s-Atom">cvs</span><span class="p">))</span>

        <span class="s s-Atom">if</span> <span class="s s-Atom">self</span><span class="p">.</span><span class="s s-Atom">cvs</span> <span class="o">==</span> <span class="mi">2</span><span class="o">:</span>

            <span class="s s-Atom">cv1_index</span> <span class="o">=</span> <span class="s s-Atom">self</span><span class="p">.</span><span class="s s-Atom">cv_select</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

            <span class="s s-Atom">cv2_index</span> <span class="o">=</span> <span class="s s-Atom">self</span><span class="p">.</span><span class="s s-Atom">cv_select</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

            <span class="s s-Atom">cv1min</span> <span class="o">=</span> <span class="s s-Atom">self</span><span class="p">.</span><span class="s s-Atom">cv_min</span><span class="p">[</span><span class="s s-Atom">self</span><span class="p">.</span><span class="s s-Atom">cv_select</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>

            <span class="s s-Atom">cv1max</span> <span class="o">=</span> <span class="s s-Atom">self</span><span class="p">.</span><span class="s s-Atom">cv_max</span><span class="p">[</span><span class="s s-Atom">self</span><span class="p">.</span><span class="s s-Atom">cv_select</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>

            <span class="s s-Atom">cv2min</span> <span class="o">=</span> <span class="s s-Atom">self</span><span class="p">.</span><span class="s s-Atom">cv_min</span><span class="p">[</span><span class="s s-Atom">self</span><span class="p">.</span><span class="s s-Atom">cv_select</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>

            <span class="s s-Atom">cv2max</span> <span class="o">=</span> <span class="s s-Atom">self</span><span class="p">.</span><span class="s s-Atom">cv_max</span><span class="p">[</span><span class="s s-Atom">self</span><span class="p">.</span><span class="s s-Atom">cv_select</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>

            <span class="s s-Atom">x</span> <span class="o">=</span> <span class="s s-Atom">np</span><span class="p">.</span><span class="nf">linspace</span><span class="p">(</span><span class="s s-Atom">cv1min</span><span class="p">,</span> <span class="s s-Atom">cv1max</span><span class="p">,</span> <span class="s s-Atom">self</span><span class="p">.</span><span class="s s-Atom">res</span><span class="p">)</span>

            <span class="s s-Atom">y</span> <span class="o">=</span> <span class="s s-Atom">np</span><span class="p">.</span><span class="nf">linspace</span><span class="p">(</span><span class="s s-Atom">cv2min</span><span class="p">,</span> <span class="s s-Atom">cv2max</span><span class="p">,</span> <span class="s s-Atom">self</span><span class="p">.</span><span class="s s-Atom">res</span><span class="p">)</span>

            <span class="nv">X</span><span class="p">,</span> <span class="nv">Y</span> <span class="o">=</span> <span class="s s-Atom">np</span><span class="p">.</span><span class="nf">meshgrid</span><span class="p">(</span><span class="s s-Atom">x</span><span class="p">,</span> <span class="s s-Atom">y</span><span class="p">)</span>

            <span class="nv">Z</span> <span class="o">=</span> <span class="s s-Atom">self</span><span class="p">.</span><span class="s s-Atom">fes</span>

            <span class="s s-Atom">#grid</span> <span class="o">=</span> <span class="s s-Atom">pv</span><span class="p">.</span><span class="nv">StructuredGrid</span><span class="p">(</span><span class="nv">X</span><span class="p">,</span> <span class="nv">Y</span><span class="p">,</span> <span class="nv">Z</span><span class="p">)</span>

            <span class="s s-Atom">#</span> <span class="s s-Atom">grid</span><span class="p">.</span><span class="nf">plot</span><span class="p">()</span>

            <span class="s s-Atom">fig</span><span class="p">,</span> <span class="s s-Atom">ax</span> <span class="o">=</span> <span class="s s-Atom">plt</span><span class="p">.</span><span class="nf">subplots</span><span class="p">(</span><span class="s s-Atom">subplot_kw=</span><span class="p">{</span><span class="s2">&quot;projection&quot;</span><span class="o">:</span> <span class="s2">&quot;3d&quot;</span><span class="p">})</span>

            <span class="s s-Atom">ax</span><span class="p">.</span><span class="nf">plot_surface</span><span class="p">(</span><span class="nv">X</span><span class="p">,</span> <span class="nv">Y</span><span class="p">,</span> <span class="nv">Z</span><span class="p">,</span> <span class="s s-Atom">cmap</span><span class="o">=</span><span class="s s-Atom">cmap</span><span class="p">,</span>  <span class="s s-Atom">#</span> <span class="s s-Atom">type</span><span class="p">:</span> <span class="s s-Atom">ignore</span>

                            <span class="s s-Atom">rstride</span><span class="o">=</span><span class="s s-Atom">rstride</span><span class="p">,</span> <span class="s s-Atom">cstride</span><span class="o">=</span><span class="s s-Atom">cstride</span><span class="p">)</span>

            <span class="s s-Atom">if</span> <span class="s s-Atom">xlabel</span> <span class="o">==</span> <span class="nv">None</span><span class="o">:</span>

                <span class="s s-Atom">ax</span><span class="p">.</span><span class="nf">set_xlabel</span><span class="p">(</span>

                    <span class="s s-Atom">f&#39;CV1 - {self.hills.cv_name[cv1_index]}&#39;</span><span class="p">,</span> <span class="s s-Atom">size</span><span class="o">=</span><span class="s s-Atom">label_size</span><span class="p">)</span>

            <span class="s s-Atom">else</span><span class="p">:</span>

                <span class="s s-Atom">ax</span><span class="p">.</span><span class="nf">set_xlabel</span><span class="p">(</span><span class="s s-Atom">xlabel</span><span class="p">,</span> <span class="s s-Atom">size</span><span class="o">=</span><span class="s s-Atom">label_size</span><span class="p">)</span>

            <span class="s s-Atom">if</span> <span class="s s-Atom">ylabel</span> <span class="o">==</span> <span class="nv">None</span><span class="o">:</span>

                <span class="s s-Atom">ax</span><span class="p">.</span><span class="nf">set_ylabel</span><span class="p">(</span>

                    <span class="s s-Atom">f&#39;CV2 - {self.hills.cv_name[cv2_index]}&#39;</span><span class="p">,</span> <span class="s s-Atom">size</span><span class="o">=</span><span class="s s-Atom">label_size</span><span class="p">)</span>

            <span class="s s-Atom">else</span><span class="p">:</span>

                <span class="s s-Atom">ax</span><span class="p">.</span><span class="nf">set_ylabel</span><span class="p">(</span><span class="s s-Atom">ylabel</span><span class="p">,</span> <span class="s s-Atom">size</span><span class="o">=</span><span class="s s-Atom">label_size</span><span class="p">)</span>

            <span class="s s-Atom">if</span> <span class="s s-Atom">zlabel</span> <span class="o">==</span> <span class="nv">None</span><span class="o">:</span>

                <span class="s s-Atom">#</span> <span class="s s-Atom">type</span><span class="p">:</span> <span class="s s-Atom">ignore</span>

                <span class="s s-Atom">ax</span><span class="p">.</span><span class="nf">set_zlabel</span><span class="p">(</span><span class="s s-Atom">f&#39;free energy ({energy_unit})&#39;</span><span class="p">,</span> <span class="s s-Atom">size</span><span class="o">=</span><span class="s s-Atom">label_size</span><span class="p">)</span>

            <span class="s s-Atom">else</span><span class="p">:</span>

                <span class="s s-Atom">ax</span><span class="p">.</span><span class="nf">set_zlabel</span><span class="p">(</span><span class="s s-Atom">zlabel</span><span class="p">,</span> <span class="s s-Atom">size</span><span class="o">=</span><span class="s s-Atom">label_size</span><span class="p">)</span>  <span class="s s-Atom">#</span> <span class="s s-Atom">type</span><span class="p">:</span> <span class="s s-Atom">ignore</span>

        <span class="s s-Atom">else</span><span class="p">:</span>

            <span class="s s-Atom">raise</span> <span class="nv">ValueError</span><span class="p">(</span>

                <span class="s s-Atom">f</span><span class="s2">&quot;Surface plot only works for FES with exactly two CVs, and this FES has {self.hills.cvs}&quot;</span>

            <span class="p">)</span>

    <span class="s s-Atom">def</span> <span class="nf">removeCV</span><span class="p">(</span>

        <span class="s s-Atom">self</span><span class="p">,</span>

        <span class="nv">CV</span><span class="o">:</span> <span class="s s-Atom">int</span><span class="p">,</span>

        <span class="s s-Atom">kb</span><span class="p">:</span> <span class="nv">Optional</span><span class="p">[</span><span class="s s-Atom">float</span><span class="p">]</span> <span class="o">=</span> <span class="nv">None</span><span class="p">,</span>

        <span class="s s-Atom">energy_unit</span><span class="o">:</span> <span class="s s-Atom">str</span> <span class="o">=</span> <span class="s2">&quot;kJ/mol&quot;</span><span class="p">,</span>

        <span class="s s-Atom">temp</span><span class="p">:</span> <span class="s s-Atom">float</span> <span class="o">=</span> <span class="mf">300.0</span>

    <span class="p">)</span><span class="o">:</span>

        <span class="s2">&quot;&quot;&quot;Remove a CV from an existing FES.</span>

<span class="s2">        The function first recalculates the FES to an array of probabilities.</span>

<span class="s2">        The probabilities are summed along the CV to be removed,</span>

<span class="s2">        and resulting probability distribution with 1 less dimension</span>

<span class="s2">        is converted back to FES.</span>

<span class="s2">        Interactivity was working in jupyter notebook/lab with &quot;</span><span class="c1">%matplotlib widget&quot;.</span>

        <span class="nv">Args</span><span class="o">:</span>

            <span class="nv">CV</span> <span class="p">(</span><span class="s s-Atom">int</span><span class="p">)</span><span class="o">:</span> <span class="s s-Atom">the</span> <span class="s s-Atom">index</span> <span class="s s-Atom">of</span> <span class="nv">CV</span> <span class="s s-Atom">to</span> <span class="s s-Atom">be</span> <span class="s s-Atom">removed</span><span class="p">.</span>

            <span class="nf">energy_unit</span> <span class="p">(</span><span class="s s-Atom">str</span><span class="p">)</span><span class="o">:</span> <span class="s s-Atom">has</span> <span class="s s-Atom">to</span> <span class="s s-Atom">be</span> <span class="s s-Atom">either</span> <span class="s2">&quot;kJ/mol&quot;</span> <span class="s s-Atom">or</span> <span class="s2">&quot;kcal/mol&quot;</span><span class="p">.</span> <span class="nv">Defaults</span> <span class="s s-Atom">to</span> <span class="s s-Atom">be</span> <span class="s2">&quot;kJ/mol&quot;</span><span class="p">.</span>

            <span class="nf">kb</span> <span class="p">(</span><span class="s s-Atom">float</span><span class="p">,</span> <span class="s s-Atom">optional</span><span class="p">)</span><span class="o">:</span> <span class="s s-Atom">the</span> <span class="nv">Boltzmann</span> <span class="nv">Constant</span> <span class="s s-Atom">in</span> <span class="s s-Atom">the</span> <span class="s s-Atom">energy</span> <span class="s s-Atom">unit</span><span class="p">.</span> <span class="s s-Atom">\</span>

                <span class="nv">Defaults</span> <span class="s s-Atom">to</span> <span class="s s-Atom">be</span> <span class="nv">None</span><span class="p">,</span> <span class="s s-Atom">which</span> <span class="s s-Atom">will</span> <span class="s s-Atom">be</span> <span class="s s-Atom">set</span> <span class="s s-Atom">according</span> <span class="s s-Atom">to</span> <span class="s s-Atom">energy_unit</span><span class="p">.</span>

            <span class="nf">temp</span> <span class="p">(</span><span class="s s-Atom">float</span><span class="p">)</span> <span class="o">=</span> <span class="s s-Atom">temperature</span> <span class="s s-Atom">of</span> <span class="s s-Atom">the</span> <span class="s s-Atom">simulation</span> <span class="s s-Atom">in</span> <span class="nv">Kelvins</span><span class="p">.</span>

        <span class="nv">Return</span><span class="o">:</span>

            <span class="nv">New</span> <span class="err">`</span><span class="nv">Fes</span><span class="err">`</span> <span class="s s-Atom">instance</span> <span class="s s-Atom">without</span> <span class="s s-Atom">the</span> <span class="nv">CV</span> <span class="s s-Atom">to</span> <span class="s s-Atom">be</span> <span class="s s-Atom">removed</span><span class="p">.</span>

        <span class="s2">&quot;&quot;&quot;</span>

<span class="s2">        print(f&quot;</span><span class="nv">Removing</span> <span class="nv">CV</span> <span class="p">{</span><span class="nv">CV</span><span class="p">}.</span><span class="s2">&quot;)</span>

<span class="s2">        if self.fes is None:</span>

<span class="s2">            raise ValueError(</span>

<span class="s2">                &quot;</span><span class="nv">FES</span> <span class="o">not</span> <span class="s s-Atom">calculated</span> <span class="s s-Atom">yet</span><span class="p">.</span> <span class="nv">Use</span> <span class="nf">makefes</span><span class="p">()</span> <span class="s s-Atom">or</span> <span class="nf">makefes2</span><span class="p">()</span> <span class="s s-Atom">first</span><span class="p">.</span><span class="s2">&quot;)</span>

<span class="s2">        if CV &gt; self.hills.cvs:</span>

<span class="s2">            print(&quot;</span><span class="nv">Error</span><span class="o">:</span> <span class="nv">The</span> <span class="nv">CV</span> <span class="s s-Atom">to</span> <span class="s s-Atom">remove</span> <span class="o">is</span> <span class="o">not</span> <span class="s s-Atom">available</span> <span class="s s-Atom">in</span> <span class="s s-Atom">this</span> <span class="nv">FES</span> <span class="s s-Atom">object</span><span class="p">.</span><span class="s2">&quot;)</span>

<span class="s2">            return None</span>

<span class="s2">        if kb == None:</span>

<span class="s2">            if energy_unit == &quot;</span><span class="s s-Atom">kJ</span><span class="o">/</span><span class="s s-Atom">mol</span><span class="s2">&quot;:</span>

<span class="s2">                kb = 8.314e-3</span>

<span class="s2">            elif energy_unit == &quot;</span><span class="s s-Atom">kcal</span><span class="o">/</span><span class="s s-Atom">mol</span><span class="s2">&quot;:</span>

<span class="s2">                kb = 8.314e-3 / 4.184</span>

<span class="s2">            else:</span>

<span class="s2">                raise ValueError(</span>

<span class="s2">                    &quot;</span><span class="nv">Please</span> <span class="s s-Atom">give</span> <span class="s s-Atom">the</span> <span class="nv">Boltzmann</span> <span class="nv">Constant</span> <span class="s s-Atom">in</span> <span class="s s-Atom">the</span> <span class="s s-Atom">energy</span> <span class="s s-Atom">unit</span><span class="p">.</span><span class="s2">&quot;)</span>

<span class="s2">        if self.cvs == 1:</span>

<span class="s2">            print(&quot;</span><span class="nv">Error</span><span class="o">:</span> <span class="nv">You</span> <span class="s s-Atom">can</span> <span class="o">not</span> <span class="s s-Atom">remove</span> <span class="s s-Atom">the</span> <span class="s s-Atom">only</span> <span class="nv">CV</span><span class="p">.</span> <span class="s2">&quot;)</span>

<span class="s2">            return None</span>

<span class="s2">        else:</span>

<span class="s2">            probabilities = np.exp(-self.fes / (kb * temp))</span>

<span class="s2">            new_prob = np.sum(probabilities, axis=CV)</span>

<span class="s2">            new_fes = Fes(hills=self.hills, calculate_new_fes=False)</span>

<span class="s2">            new_fes.fes = - kb * temp * np.log(new_prob)</span>

<span class="s2">            new_fes.fes = new_fes.fes - np.min(new_fes.fes)</span>

<span class="s2">            new_fes.res = self.res</span>

<span class="s2">            mask = np.ones(len(self.cv_select), dtype=bool)</span>

<span class="s2">            mask[CV] = False</span>

<span class="s2">            new_fes.cv_select = self.cv_select[mask]</span>

<span class="s2">            new_fes.cv_min = self.cv_min[mask]</span>

<span class="s2">            new_fes.cv_max = self.cv_max[mask]</span>

<span class="s2">            new_fes.cv_fes_range = self.cv_fes_range[mask]</span>

<span class="s2">            return new_fes</span>

<span class="s2">    def make_gif(</span>

<span class="s2">        self,</span>

<span class="s2">        gif_name: str = &quot;</span><span class="nv">FES</span><span class="p">.</span><span class="s s-Atom">gif</span><span class="s2">&quot;,</span>

<span class="s2">        cmap: str = &quot;</span><span class="s s-Atom">jet</span><span class="s2">&quot;,</span>

<span class="s2">        xlabel: Optional[str] = None,</span>

<span class="s2">        ylabel: Optional[str] = None,</span>

<span class="s2">        zlabel: Optional[str] = None,</span>

<span class="s2">        label_size: int = 12,</span>

<span class="s2">        image_size: List[int] = [10, 7],</span>

<span class="s2">        opacity: float = 0.2,</span>

<span class="s2">        levels: Optional[List[float]] = None,</span>

<span class="s2">        frames: int = 64,</span>

<span class="s2">    ):</span>

<span class="s2">        &quot;&quot;&quot;</span>

        <span class="nv">Generates</span> <span class="s s-Atom">an</span> <span class="s s-Atom">animation</span> <span class="s s-Atom">of</span> <span class="s s-Atom">the</span> <span class="mi">3</span><span class="nv">D</span> <span class="s s-Atom">free</span> <span class="s s-Atom">energy</span> <span class="nf">surface</span> <span class="p">(</span><span class="nv">FES</span><span class="p">)</span> <span class="s s-Atom">showing</span> <span class="s s-Atom">different</span> <span class="s s-Atom">isosurfaces</span><span class="p">.</span>

        <span class="nv">Usage</span><span class="o">:</span>

        <span class="err">```</span><span class="s s-Atom">python</span>

        <span class="s s-Atom">fes</span><span class="p">.</span><span class="nf">make_gif</span><span class="p">()</span>

        <span class="err">```</span>

        <span class="nv">Args</span><span class="o">:</span>

            <span class="nf">gif_name</span> <span class="p">(</span><span class="s s-Atom">str</span><span class="p">,</span> <span class="s s-Atom">default=</span><span class="s2">&quot;FES.gif&quot;</span><span class="p">)</span><span class="o">:</span> <span class="s s-Atom">\</span>

                <span class="nv">The</span> <span class="s s-Atom">name</span> <span class="s s-Atom">of</span> <span class="s s-Atom">the</span> <span class="s s-Atom">gif</span> <span class="s s-Atom">file</span> <span class="s s-Atom">of</span> <span class="s s-Atom">the</span> <span class="nv">FES</span> <span class="s s-Atom">that</span> <span class="s s-Atom">will</span> <span class="s s-Atom">be</span> <span class="s s-Atom">saved</span> <span class="s s-Atom">in</span> <span class="s s-Atom">the</span> <span class="s s-Atom">current</span> <span class="s s-Atom">working</span> <span class="s s-Atom">directory</span><span class="p">.</span>

            <span class="nf">cmap</span> <span class="p">(</span><span class="s s-Atom">str</span><span class="p">,</span> <span class="s s-Atom">default=</span><span class="s2">&quot;jet&quot;</span><span class="p">)</span><span class="o">:</span> <span class="s s-Atom">\</span>

                <span class="nv">The</span> <span class="nv">Matplotlib</span> <span class="s s-Atom">colormap</span> <span class="s s-Atom">used</span> <span class="s s-Atom">to</span> <span class="s s-Atom">color</span> <span class="s s-Atom">the</span> <span class="mi">3</span><span class="nv">D</span> <span class="nv">FES</span><span class="p">.</span>

            <span class="s s-Atom">xlabel</span><span class="p">,</span> <span class="s s-Atom">ylabel</span><span class="p">,</span> <span class="nf">zlabel</span> <span class="p">(</span><span class="s s-Atom">str</span><span class="p">,</span> <span class="s s-Atom">optional</span><span class="p">)</span><span class="o">:</span> <span class="s s-Atom">\</span>

                <span class="nv">If</span> <span class="s s-Atom">provided</span><span class="p">,</span> <span class="s s-Atom">they</span> <span class="s s-Atom">will</span> <span class="s s-Atom">be</span> <span class="s s-Atom">used</span> <span class="s s-Atom">as</span> <span class="s s-Atom">labels</span> <span class="s s-Atom">for</span> <span class="s s-Atom">the</span> <span class="s s-Atom">graph</span><span class="p">.</span>

            <span class="nf">label_size</span> <span class="p">(</span><span class="s s-Atom">int</span><span class="p">,</span> <span class="s s-Atom">default</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span><span class="o">:</span> <span class="s s-Atom">\</span>

                <span class="nv">The</span> <span class="s s-Atom">size</span> <span class="s s-Atom">of</span> <span class="s s-Atom">text</span> <span class="s s-Atom">in</span> <span class="s s-Atom">the</span> <span class="s s-Atom">labels</span><span class="p">.</span>

            <span class="nf">image_size</span> <span class="p">(</span><span class="nv">List</span><span class="p">[</span><span class="s s-Atom">int</span><span class="p">],</span> <span class="s s-Atom">default</span><span class="o">=</span><span class="p">[</span><span class="mi">10</span><span class="p">,</span><span class="mi">7</span><span class="p">])</span><span class="o">:</span> <span class="s s-Atom">\</span>

                <span class="nv">The</span> <span class="s s-Atom">width</span> <span class="s s-Atom">and</span> <span class="s s-Atom">height</span> <span class="s s-Atom">of</span> <span class="s s-Atom">the</span> <span class="s s-Atom">picture</span><span class="p">.</span>

            <span class="nf">opacity</span> <span class="p">(</span><span class="s s-Atom">float</span><span class="p">,</span> <span class="s s-Atom">default</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span><span class="o">:</span> <span class="s s-Atom">\</span>

                <span class="nv">A</span> <span class="s s-Atom">number</span> <span class="s s-Atom">between</span> <span class="mi">0</span> <span class="s s-Atom">and</span> <span class="mi">1</span> <span class="s s-Atom">representing</span> <span class="s s-Atom">the</span> <span class="s s-Atom">opacity</span> <span class="s s-Atom">of</span> <span class="s s-Atom">isosurfaces</span> <span class="s s-Atom">in</span> <span class="s s-Atom">the</span> <span class="mi">3</span><span class="nv">D</span> <span class="nv">FES</span><span class="p">.</span>

            <span class="nf">levels</span> <span class="p">(</span><span class="nv">List</span><span class="p">[</span><span class="s s-Atom">float</span><span class="p">],</span> <span class="s s-Atom">optional</span><span class="p">)</span><span class="o">:</span> <span class="s s-Atom">\</span>

                <span class="nv">A</span> <span class="s s-Atom">list</span> <span class="s s-Atom">of</span> <span class="s s-Atom">free</span> <span class="s s-Atom">energy</span> <span class="nb">val</span><span class="s s-Atom">ues</span> <span class="s s-Atom">for</span> <span class="s s-Atom">isosurfaces</span> <span class="s s-Atom">in</span> <span class="s s-Atom">the</span> <span class="mi">3</span><span class="nv">D</span> <span class="nv">FES</span><span class="p">.</span> <span class="nv">If</span> <span class="o">not</span> <span class="s s-Atom">provided</span><span class="p">,</span> <span class="s s-Atom">default</span> <span class="nb">val</span><span class="s s-Atom">ues</span> <span class="s s-Atom">from</span> <span class="s s-Atom">the</span> <span class="s s-Atom">contours</span> <span class="s s-Atom">parameters</span> <span class="s s-Atom">will</span> <span class="s s-Atom">be</span> <span class="s s-Atom">used</span> <span class="s s-Atom">instead</span><span class="p">.</span>

            <span class="nf">frames</span> <span class="p">(</span><span class="s s-Atom">int</span><span class="p">,</span> <span class="s s-Atom">default</span><span class="o">=</span><span class="mi">64</span><span class="p">)</span><span class="o">:</span> <span class="s s-Atom">\</span>

                <span class="nv">The</span> <span class="s s-Atom">number</span> <span class="s s-Atom">of</span> <span class="s s-Atom">frames</span> <span class="s s-Atom">the</span> <span class="s s-Atom">animation</span> <span class="s s-Atom">will</span> <span class="s s-Atom">be</span> <span class="s s-Atom">composed</span> <span class="s s-Atom">of</span><span class="p">.</span>

        <span class="s2">&quot;&quot;&quot;</span>

<span class="s2">        try:</span>

<span class="s2">            import pyvista as pv</span>

<span class="s2">        except (ImportError, ModuleNotFoundError) as e:</span>

<span class="s2">            print(e)</span>

<span class="s2">            sys.exit(1)</span>

<span class="s2">        if self.fes is None:</span>

<span class="s2">            raise ValueError(</span>

<span class="s2">                &quot;</span><span class="nv">FES</span> <span class="o">not</span> <span class="s s-Atom">calculated</span> <span class="s s-Atom">yet</span><span class="p">.</span> <span class="nv">Use</span> <span class="nf">makefes</span><span class="p">()</span> <span class="s s-Atom">or</span> <span class="nf">makefes2</span><span class="p">()</span> <span class="s s-Atom">first</span><span class="p">.</span><span class="s2">&quot;)</span>

<span class="s2">        if self.cvs == 3:</span>

<span class="s2">            cv1_index = self.cv_select[0]</span>

<span class="s2">            cv2_index = self.cv_select[1]</span>

<span class="s2">            cv3_index = self.cv_select[2]</span>

<span class="s2">            cv1min = self.cv_min[self.cv_select[0]]</span>

<span class="s2">            cv1max = self.cv_max[self.cv_select[0]]</span>

<span class="s2">            cv2min = self.cv_min[self.cv_select[1]]</span>

<span class="s2">            cv2max = self.cv_max[self.cv_select[1]]</span>

<span class="s2">            cv3min = self.cv_min[self.cv_select[2]]</span>

<span class="s2">            cv3max = self.cv_max[self.cv_select[2]]</span>

<span class="s2">            values = np.linspace(np.min(self.fes)+0.01,</span>

<span class="s2">                                 np.max(self.fes), num=frames)</span>

<span class="s2">            grid = pv.UniformGrid(</span>

<span class="s2">                dimensions=(self.res, self.res, self.res),</span>

<span class="s2">                spacing=((cv1max-cv1min)/self.res, (cv2max-cv2min) /</span>

<span class="s2">                         self.res, (cv3max-cv3min)/self.res),</span>

<span class="s2">                origin=(cv1min, cv2min, cv3min),</span>

<span class="s2">            )</span>

<span class="s2">            grid[&quot;</span><span class="s s-Atom">vol</span><span class="s2">&quot;] = np.ravel(self.fes, order=&quot;</span><span class="nv">F</span><span class="s2">&quot;)</span>

<span class="s2">            surface = grid.contour(values[:1])</span>

<span class="s2">            surfaces = [grid.contour([v]) for v in values]</span>

<span class="s2">            surface = surfaces[0].copy()</span>

<span class="s2">            pv.set_plot_theme(&#39;document&#39;)</span>

<span class="s2">            plotter = pv.Plotter(off_screen=True)</span>

<span class="s2">            # Open a movie file</span>

<span class="s2">            plotter.open_gif(gif_name)</span>

<span class="s2">            # Add initial mesh</span>

<span class="s2">            plotter.add_mesh(</span>

<span class="s2">                surface,</span>

<span class="s2">                opacity=0.3,</span>

<span class="s2">                clim=grid.get_data_range(),</span>

<span class="s2">                show_scalar_bar=False,</span>

<span class="s2">                cmap=&quot;</span><span class="s s-Atom">jet</span><span class="s2">&quot;</span>

<span class="s2">            )</span>

<span class="s2">            plotter.add_mesh(grid.outline_corners(), color=&quot;</span><span class="s s-Atom">k</span><span class="s2">&quot;)</span>

<span class="s2">            if xlabel == None and ylabel == None and zlabel == None:</span>

<span class="s2">                plotter.show_grid(</span>

<span class="s2">                    xlabel=f&quot;</span><span class="nv">CV1</span> <span class="o">-</span> <span class="p">{</span><span class="s s-Atom">self</span><span class="p">.</span><span class="s s-Atom">hills</span><span class="p">.</span><span class="s s-Atom">cv_name</span><span class="p">[</span><span class="s s-Atom">cv1_index</span><span class="p">]}</span><span class="s2">&quot;,</span>

<span class="s2">                    ylabel=f&quot;</span><span class="nv">CV2</span> <span class="o">-</span> <span class="p">{</span><span class="s s-Atom">self</span><span class="p">.</span><span class="s s-Atom">hills</span><span class="p">.</span><span class="s s-Atom">cv_name</span><span class="p">[</span><span class="s s-Atom">cv2_index</span><span class="p">]}</span><span class="s2">&quot;,</span>

<span class="s2">                    zlabel=f&quot;</span><span class="nv">CV3</span> <span class="o">-</span> <span class="p">{</span><span class="s s-Atom">self</span><span class="p">.</span><span class="s s-Atom">hills</span><span class="p">.</span><span class="s s-Atom">cv_name</span><span class="p">[</span><span class="s s-Atom">cv3_index</span><span class="p">]}</span><span class="s2">&quot;)</span>

<span class="s2">            else:</span>

<span class="s2">                plotter.show_grid(xlabel=xlabel, ylabel=ylabel, zlabel=zlabel)</span>

<span class="s2">            plotter.set_background(&#39;white&#39;)</span>

<span class="s2">            plotter.show(auto_close=False)</span>

<span class="s2">            # Run through each frame</span>

<span class="s2">            for surf in surfaces:</span>

<span class="s2">                surface.copy_from(surf)</span>

<span class="s2">                plotter.write_frame()  # Write this frame</span>

<span class="s2">            # Run through backwards</span>

<span class="s2">            for surf in surfaces[::-1]:</span>

<span class="s2">                surface.copy_from(surf)</span>

<span class="s2">                plotter.write_frame()  # Write this frame</span>

<span class="s2">            # Be sure to close the plotter when finished</span>

<span class="s2">            plotter.close()</span>

<span class="s2">        else:</span>

<span class="s2">            raise ValueError(</span>

<span class="s2">                &quot;</span><span class="nv">Error</span><span class="o">:</span> <span class="s s-Atom">gif_plot</span> <span class="o">is</span> <span class="s s-Atom">only</span> <span class="s s-Atom">available</span> <span class="s s-Atom">for</span> <span class="nv">FES</span> <span class="s s-Atom">with</span> <span class="mi">3</span> <span class="nv">CVs</span><span class="p">.</span><span class="err">&quot;</span><span class="p">)</span>
</code></pre></div>

</details>
<h2 id="classes">Classes</h2>
<h3 id="fes">Fes</h3>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">Fes</span><span class="p">(</span>
    <span class="n">hills</span><span class="p">:</span> <span class="n">metadynminer</span><span class="o">.</span><span class="n">hills</span><span class="o">.</span><span class="n">Hills</span><span class="p">,</span>
    <span class="n">original</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">calculate_new_fes</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">resolution</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">256</span><span class="p">,</span>
    <span class="n">cv_select</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">cv_range</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">time_min</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">time_max</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<span class="p">)</span>
</code></pre></div>

<p>Computes the free energy surface corresponding to the provided Hills object.</p>
<p>Usage:</p>
<div class="codehilite"><pre><span></span><code><span class="n">fes</span> <span class="o">=</span> <span class="n">metadynminer</span><span class="o">.</span><span class="n">Fes</span><span class="p">(</span><span class="n">hills</span><span class="o">=</span><span class="n">hillsfile</span><span class="p">)</span>
</code></pre></div>

<h4 id="attributes">Attributes</h4>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td>hills</td>
<td>Hills</td>
<td>The Hills object used for computing the free energy surface.</td>
<td>None</td>
</tr>
<tr>
<td>original</td>
<td>bool</td>
<td>If False, the free energy surface will be calculated using a fast but approximate algorithm.             If True, it will be calculated using a slower but exact algorithm             (same as FES calculated with PLUMED <code>sum_hills</code> function).             Defaults to False.</td>
<td>None</td>
</tr>
<tr>
<td>calculate_new_fes</td>
<td>bool</td>
<td>If True, the free energy surface will be calculated to form <code>self.fes</code>.             Defaults to True.</td>
<td>None</td>
</tr>
<tr>
<td>resolution</td>
<td>int</td>
<td>The resolution of the free energy surface. Defaults to 256.</td>
<td>256</td>
</tr>
<tr>
<td>cv_select</td>
<td>List[int]</td>
<td>A list of integers specifying which collective variables (CVs) should be used for FES calculation.             Defaults to None.</td>
<td>None</td>
</tr>
<tr>
<td>cv_range</td>
<td>List[float]</td>
<td>A list of two numbers defining the lower and upper bounds of the CVs (in the units of the CV).             Defaults to None.         time_min (int): The starting time step of simulation. Defaults to 0.</td>
<td>0</td>
</tr>
<tr>
<td>time_max</td>
<td>int</td>
<td>The ending time step of simulation. Defaults to None.</td>
<td>None</td>
</tr>
</tbody>
</table>
<details class="example">
<summary>View Source</summary>
<div class="codehilite"><pre><span></span><code><span class="s s-Atom">class</span> <span class="nv">Fes</span><span class="o">:</span>

    <span class="s2">&quot;&quot;</span><span class="err">&quot;</span>

    <span class="nv">Computes</span> <span class="s s-Atom">the</span> <span class="s s-Atom">free</span> <span class="s s-Atom">energy</span> <span class="s s-Atom">surface</span> <span class="s s-Atom">corresponding</span> <span class="s s-Atom">to</span> <span class="s s-Atom">the</span> <span class="s s-Atom">provided</span> <span class="nv">Hills</span> <span class="s s-Atom">object</span><span class="p">.</span>

    <span class="nv">Usage</span><span class="o">:</span>

    <span class="err">```</span><span class="s s-Atom">python</span>

    <span class="s s-Atom">fes</span> <span class="o">=</span> <span class="s s-Atom">metadynminer</span><span class="p">.</span><span class="nv">Fes</span><span class="p">(</span><span class="s s-Atom">hills</span><span class="o">=</span><span class="s s-Atom">hillsfile</span><span class="p">)</span>

    <span class="err">```</span>

    <span class="nv">Args</span><span class="o">:</span>

        <span class="nf">hills</span> <span class="p">(</span><span class="nv">Hills</span><span class="p">)</span><span class="o">:</span> <span class="nv">The</span> <span class="nv">Hills</span> <span class="s s-Atom">object</span> <span class="s s-Atom">used</span> <span class="s s-Atom">for</span> <span class="s s-Atom">computing</span> <span class="s s-Atom">the</span> <span class="s s-Atom">free</span> <span class="s s-Atom">energy</span> <span class="s s-Atom">surface</span><span class="p">.</span>

        <span class="nf">original</span> <span class="p">(</span><span class="s s-Atom">bool</span><span class="p">,</span> <span class="s s-Atom">optional</span><span class="p">)</span><span class="o">:</span> <span class="s s-Atom">\</span>

            <span class="nv">If</span> <span class="nv">False</span><span class="p">,</span> <span class="s s-Atom">the</span> <span class="s s-Atom">free</span> <span class="s s-Atom">energy</span> <span class="s s-Atom">surface</span> <span class="s s-Atom">will</span> <span class="s s-Atom">be</span> <span class="s s-Atom">calculated</span> <span class="s s-Atom">using</span> <span class="s s-Atom">a</span> <span class="s s-Atom">fast</span> <span class="s s-Atom">but</span> <span class="s s-Atom">approximate</span> <span class="s s-Atom">algorithm</span><span class="p">.</span> <span class="s s-Atom">\</span>

            <span class="nv">If</span> <span class="nv">True</span><span class="p">,</span> <span class="s s-Atom">it</span> <span class="s s-Atom">will</span> <span class="s s-Atom">be</span> <span class="s s-Atom">calculated</span> <span class="s s-Atom">using</span> <span class="s s-Atom">a</span> <span class="s s-Atom">slower</span> <span class="s s-Atom">but</span> <span class="s s-Atom">exact</span> <span class="s s-Atom">algorithm</span> <span class="s s-Atom">\</span>

            <span class="p">(</span><span class="s s-Atom">same</span> <span class="s s-Atom">as</span> <span class="nv">FES</span> <span class="s s-Atom">calculated</span> <span class="s s-Atom">with</span> <span class="nv">PLUMED</span> <span class="err">`</span><span class="s s-Atom">sum_hills</span><span class="err">`</span> <span class="s s-Atom">function</span><span class="p">).</span> <span class="s s-Atom">\</span>

            <span class="nv">Defaults</span> <span class="s s-Atom">to</span> <span class="nv">False</span><span class="p">.</span>

        <span class="nf">calculate_new_fes</span> <span class="p">(</span><span class="s s-Atom">bool</span><span class="p">,</span> <span class="s s-Atom">optional</span><span class="p">)</span><span class="o">:</span> <span class="s s-Atom">\</span>

            <span class="nv">If</span> <span class="nv">True</span><span class="p">,</span> <span class="s s-Atom">the</span> <span class="s s-Atom">free</span> <span class="s s-Atom">energy</span> <span class="s s-Atom">surface</span> <span class="s s-Atom">will</span> <span class="s s-Atom">be</span> <span class="s s-Atom">calculated</span> <span class="s s-Atom">to</span> <span class="s s-Atom">form</span> <span class="err">`</span><span class="s s-Atom">self</span><span class="p">.</span><span class="s s-Atom">fes</span><span class="err">`</span><span class="p">.</span> <span class="s s-Atom">\</span>

            <span class="nv">Defaults</span> <span class="s s-Atom">to</span> <span class="nv">True</span><span class="p">.</span>

        <span class="nf">resolution</span> <span class="p">(</span><span class="s s-Atom">int</span><span class="p">,</span> <span class="s s-Atom">optional</span><span class="p">)</span><span class="o">:</span> <span class="s s-Atom">\</span>

            <span class="nv">The</span> <span class="s s-Atom">resolution</span> <span class="s s-Atom">of</span> <span class="s s-Atom">the</span> <span class="s s-Atom">free</span> <span class="s s-Atom">energy</span> <span class="s s-Atom">surface</span><span class="p">.</span> <span class="nv">Defaults</span> <span class="s s-Atom">to</span> <span class="mf">256.</span>

        <span class="nf">cv_select</span> <span class="p">(</span><span class="nv">List</span><span class="p">[</span><span class="s s-Atom">int</span><span class="p">],</span> <span class="s s-Atom">optional</span><span class="p">)</span><span class="o">:</span> <span class="s s-Atom">\</span>

            <span class="nv">A</span> <span class="s s-Atom">list</span> <span class="s s-Atom">of</span> <span class="s s-Atom">integers</span> <span class="s s-Atom">specifying</span> <span class="s s-Atom">which</span> <span class="s s-Atom">collective</span> <span class="nf">variables</span> <span class="p">(</span><span class="nv">CVs</span><span class="p">)</span> <span class="s s-Atom">should</span> <span class="s s-Atom">be</span> <span class="s s-Atom">used</span> <span class="s s-Atom">for</span> <span class="nv">FES</span> <span class="s s-Atom">calculation</span><span class="p">.</span> <span class="s s-Atom">\</span>

            <span class="nv">Defaults</span> <span class="s s-Atom">to</span> <span class="nv">None</span><span class="p">.</span>

        <span class="nf">cv_range</span> <span class="p">(</span><span class="nv">List</span><span class="p">[</span><span class="s s-Atom">float</span><span class="p">],</span> <span class="s s-Atom">optional</span><span class="p">)</span><span class="o">:</span> <span class="s s-Atom">\</span>

            <span class="nv">A</span> <span class="s s-Atom">list</span> <span class="s s-Atom">of</span> <span class="s s-Atom">two</span> <span class="s s-Atom">numbers</span> <span class="s s-Atom">defining</span> <span class="s s-Atom">the</span> <span class="s s-Atom">lower</span> <span class="s s-Atom">and</span> <span class="s s-Atom">upper</span> <span class="s s-Atom">bounds</span> <span class="s s-Atom">of</span> <span class="s s-Atom">the</span> <span class="nv">CVs</span> <span class="p">(</span><span class="s s-Atom">in</span> <span class="s s-Atom">the</span> <span class="s s-Atom">units</span> <span class="s s-Atom">of</span> <span class="s s-Atom">the</span> <span class="nv">CV</span><span class="p">).</span> <span class="s s-Atom">\</span>

            <span class="nv">Defaults</span> <span class="s s-Atom">to</span> <span class="nv">None</span><span class="p">.</span> <span class="s s-Atom">\</span>

        <span class="nf">time_min</span> <span class="p">(</span><span class="s s-Atom">int</span><span class="p">)</span><span class="o">:</span> <span class="nv">The</span> <span class="s s-Atom">starting</span> <span class="s s-Atom">time</span> <span class="s s-Atom">step</span> <span class="s s-Atom">of</span> <span class="s s-Atom">simulation</span><span class="p">.</span> <span class="nv">Defaults</span> <span class="s s-Atom">to</span> <span class="mf">0.</span>

        <span class="nf">time_max</span> <span class="p">(</span><span class="s s-Atom">int</span><span class="p">,</span> <span class="s s-Atom">optional</span><span class="p">)</span><span class="o">:</span> <span class="nv">The</span> <span class="s s-Atom">ending</span> <span class="s s-Atom">time</span> <span class="s s-Atom">step</span> <span class="s s-Atom">of</span> <span class="s s-Atom">simulation</span><span class="p">.</span> <span class="nv">Defaults</span> <span class="s s-Atom">to</span> <span class="nv">None</span><span class="p">.</span>

    <span class="s2">&quot;&quot;&quot;</span>

<span class="s2">    def __init__(</span>

<span class="s2">        self,</span>

<span class="s2">        hills: Hills,</span>

<span class="s2">        original: bool = False,</span>

<span class="s2">        calculate_new_fes: bool = True,</span>

<span class="s2">        resolution: int = 256,</span>

<span class="s2">        cv_select: Optional[List[int]] = None,</span>

<span class="s2">        cv_range: Optional[List[float]] = None,</span>

<span class="s2">        time_min: int = 0,</span>

<span class="s2">        time_max: Optional[int] = None</span>

<span class="s2">    ):</span>

<span class="s2">        self.res = resolution</span>

<span class="s2">        self.fes = None</span>

<span class="s2">        self.hills = hills</span>

<span class="s2">        self.periodic = hills.get_periodic()</span>

<span class="s2">        if cv_select != None:</span>

<span class="s2">            self.cvs = len(cv_select)</span>

<span class="s2">        else:</span>

<span class="s2">            cv_select = [i for i in range(self.hills.cvs)]</span>

<span class="s2">            self.cvs = len(cv_select)</span>

<span class="s2">        if time_max != None:</span>

<span class="s2">            if time_max &lt;= time_min:</span>

<span class="s2">                print(&quot;</span><span class="nv">Error</span><span class="o">:</span> <span class="nv">End</span> <span class="s s-Atom">time</span> <span class="o">is</span> <span class="s s-Atom">lower</span> <span class="s s-Atom">than</span> <span class="s s-Atom">start</span> <span class="s s-Atom">time</span><span class="s2">&quot;)</span>

<span class="s2">            if time_max &gt; len(self.hills.cv[:, 0]):</span>

<span class="s2">                time_max = len(self.hills.cv[:, 0])</span>

<span class="s2">                print(</span>

<span class="s2">                    f&quot;</span><span class="nv">Error</span><span class="o">:</span> <span class="nv">End</span> <span class="s s-Atom">time</span> <span class="p">{</span><span class="s s-Atom">time_max</span><span class="p">}</span> <span class="o">is</span> <span class="s s-Atom">higher</span> <span class="s s-Atom">than</span><span class="s2">&quot;,</span>

<span class="s2">                    f&quot;</span><span class="s s-Atom">number</span> <span class="s s-Atom">of</span> <span class="s s-Atom">lines</span> <span class="s s-Atom">in</span> <span class="nv">HILLS</span> <span class="s s-Atom">file</span> <span class="p">{</span><span class="nf">len</span><span class="p">(</span><span class="s s-Atom">self</span><span class="p">.</span><span class="s s-Atom">hills</span><span class="p">.</span><span class="s s-Atom">cv</span><span class="p">[</span><span class="o">:</span><span class="p">,</span> <span class="mi">0</span><span class="p">])},</span><span class="s2">&quot;,</span>

<span class="s2">                    &quot;</span><span class="s s-Atom">which</span> <span class="s s-Atom">will</span> <span class="s s-Atom">be</span> <span class="s s-Atom">used</span> <span class="s s-Atom">instead</span><span class="p">.</span><span class="s2">&quot;</span>

<span class="s2">                )</span>

<span class="s2">        if calculate_new_fes:</span>

<span class="s2">            if not original:</span>

<span class="s2">                self.makefes(resolution, cv_select,</span>

<span class="s2">                             cv_range, time_min, time_max)</span>

<span class="s2">            else:</span>

<span class="s2">                self.makefes2(resolution, cv_select,</span>

<span class="s2">                              cv_range, time_min, time_max)</span>

<span class="s2">    def generate_cv_map(</span>

<span class="s2">        self,</span>

<span class="s2">        cv_select: Optional[List[int]] = None,</span>

<span class="s2">        cv_range: Optional[List[float]] = None</span>

<span class="s2">    ):</span>

<span class="s2">        &quot;&quot;&quot;</span><span class="s s-Atom">generate</span> <span class="nv">CV</span> <span class="s s-Atom">map</span>

        <span class="nv">Args</span><span class="o">:</span>

            <span class="nf">cv_select</span> <span class="p">(</span><span class="nv">List</span><span class="p">[</span><span class="s s-Atom">int</span><span class="p">],</span> <span class="s s-Atom">optional</span><span class="p">)</span><span class="o">:</span> <span class="s s-Atom">\</span>

                <span class="nv">A</span> <span class="s s-Atom">list</span> <span class="s s-Atom">of</span> <span class="s s-Atom">integers</span> <span class="s s-Atom">specifying</span> <span class="s s-Atom">which</span> <span class="s s-Atom">collective</span> <span class="nf">variables</span> <span class="p">(</span><span class="nv">CVs</span><span class="p">)</span> <span class="s s-Atom">should</span> <span class="s s-Atom">be</span> <span class="s s-Atom">used</span> <span class="s s-Atom">for</span> <span class="nv">FES</span> <span class="s s-Atom">calculation</span><span class="p">.</span> <span class="s s-Atom">\</span>

                <span class="nv">Defaults</span> <span class="s s-Atom">to</span> <span class="nv">None</span><span class="p">.</span>

            <span class="nf">cv_range</span> <span class="p">(</span><span class="nv">Optional</span><span class="p">[</span><span class="nv">List</span><span class="p">[</span><span class="s s-Atom">float</span><span class="p">]],</span> <span class="s s-Atom">optional</span><span class="p">)</span><span class="o">:</span> <span class="s s-Atom">\</span>

                <span class="nv">A</span> <span class="s s-Atom">list</span> <span class="s s-Atom">of</span> <span class="s s-Atom">two</span> <span class="s s-Atom">numbers</span> <span class="s s-Atom">defining</span> <span class="s s-Atom">the</span> <span class="s s-Atom">lower</span> <span class="s s-Atom">and</span> <span class="s s-Atom">upper</span> <span class="s s-Atom">bounds</span> <span class="s s-Atom">of</span> <span class="s s-Atom">the</span> <span class="nv">CVs</span> <span class="p">(</span><span class="s s-Atom">in</span> <span class="s s-Atom">the</span> <span class="s s-Atom">units</span> <span class="s s-Atom">of</span> <span class="s s-Atom">the</span> <span class="nv">CV</span><span class="p">).</span> <span class="s s-Atom">\</span>

                <span class="nv">Defaults</span> <span class="s s-Atom">to</span> <span class="nv">None</span><span class="p">.</span> <span class="s s-Atom">\</span>

        <span class="nv">Returns</span><span class="o">:</span>

            <span class="nv">Tuple</span><span class="o">:</span> <span class="s s-Atom">cv_min</span><span class="p">,</span> <span class="s s-Atom">cv_max</span><span class="p">,</span> <span class="s s-Atom">cv_fes_range</span>

        <span class="s2">&quot;&quot;&quot;</span>

<span class="s2">        if cv_select is None:</span>

<span class="s2">            cv_select = list(range(self.cvs))</span>

<span class="s2">        self.cv_select = cv_select</span>

<span class="s2">        self.cvs = len(cv_select)</span>

<span class="s2">        if cv_range is None:</span>

<span class="s2">            cv_min = self.hills.cv_min[cv_select]</span>

<span class="s2">            cv_max = self.hills.cv_max[cv_select]</span>

<span class="s2">            cv_range = self.hills.cv_max - self.hills.cv_min</span>

<span class="s2">        else:</span>

<span class="s2">            if len(cv_range) != len(cv_select) and len(cv_range) != 2:</span>

<span class="s2">                raise ValueError(</span>

<span class="s2">                    &quot;</span><span class="s s-Atom">cv_range</span> <span class="s s-Atom">has</span> <span class="s s-Atom">to</span> <span class="s s-Atom">have</span> <span class="s s-Atom">the</span> <span class="s s-Atom">same</span> <span class="s s-Atom">length</span> <span class="s s-Atom">as</span> <span class="s s-Atom">cv_select</span><span class="s2">&quot;</span>

<span class="s2">                    &quot;</span><span class="s s-Atom">or</span> <span class="s s-Atom">be</span> <span class="s s-Atom">a</span> <span class="s s-Atom">list</span> <span class="s s-Atom">of</span> <span class="s s-Atom">two</span> <span class="s s-Atom">numbers</span><span class="s2">&quot;</span>

<span class="s2">                )</span>

<span class="s2">            elif len(cv_range) == 2:</span>

<span class="s2">                if type(cv_range[0]) == int:</span>

<span class="s2">                    cv_min = np.full(len(cv_select), cv_range[0])</span>

<span class="s2">                    cv_max = np.full(len(cv_select), cv_range[1])</span>

<span class="s2">            else:</span>

<span class="s2">                cv_min = np.array(cv_range)[:, 0]</span>

<span class="s2">                cv_max = np.array(cv_range)[:, 1]</span>

<span class="s2">        self.cv_range = cv_range</span>

<span class="s2">        cv_min[~self.periodic[cv_select] # type: ignore</span>

<span class="s2">               ] -= cv_range[~self.periodic[cv_select]] * 0.15 # type: ignore</span>

<span class="s2">        cv_max[~self.periodic[cv_select] # type: ignore</span>

<span class="s2">               ] += cv_range[~self.periodic[cv_select]] * 0.15 # type: ignore</span>

<span class="s2">        cv_fes_range = np.abs(cv_max - cv_min) # type: ignore</span>

<span class="s2">        # generate remapped cv_min and cv_max</span>

<span class="s2">        self.cv_min = cv_min # type: ignore</span>

<span class="s2">        self.cv_max = cv_max # type: ignore</span>

<span class="s2">        self.cv_fes_range = cv_fes_range</span>

<span class="s2">    def makefes(</span>

<span class="s2">        self,</span>

<span class="s2">        resolution: Optional[int] = None,</span>

<span class="s2">        cv_select: Optional[List[int]] = None,</span>

<span class="s2">        cv_range: Optional[List[float]] = None,</span>

<span class="s2">        time_min: Optional[int] = None,</span>

<span class="s2">        time_max: Optional[int] = None</span>

<span class="s2">    ):</span>

<span class="s2">        &quot;&quot;&quot;</span><span class="nv">Function</span> <span class="s s-Atom">used</span> <span class="s s-Atom">internally</span> <span class="s s-Atom">for</span> <span class="s s-Atom">summing</span> <span class="s s-Atom">hills</span> <span class="s s-Atom">in</span> <span class="nv">Hills</span> <span class="s s-Atom">object</span> <span class="s s-Atom">with</span> <span class="s s-Atom">the</span> <span class="s s-Atom">fast</span> <span class="nv">Bias</span> <span class="nv">Sum</span> <span class="nv">Algorithm</span><span class="p">.</span>

        <span class="nv">Args</span><span class="o">:</span>

            <span class="nf">resolution</span> <span class="p">(</span><span class="s s-Atom">int</span><span class="p">,</span> <span class="s s-Atom">optional</span><span class="p">)</span><span class="o">:</span> <span class="s s-Atom">\</span>

                <span class="nv">The</span> <span class="s s-Atom">resolution</span> <span class="s s-Atom">of</span> <span class="s s-Atom">the</span> <span class="s s-Atom">free</span> <span class="s s-Atom">energy</span> <span class="s s-Atom">surface</span><span class="p">.</span> <span class="nv">Defaults</span> <span class="s s-Atom">to</span> <span class="mf">256.</span>

            <span class="nf">cv_select</span> <span class="p">(</span><span class="nv">List</span><span class="p">[</span><span class="s s-Atom">int</span><span class="p">],</span> <span class="s s-Atom">optional</span><span class="p">)</span><span class="o">:</span> <span class="s s-Atom">\</span>

                <span class="nv">A</span> <span class="s s-Atom">list</span> <span class="s s-Atom">of</span> <span class="s s-Atom">integers</span> <span class="s s-Atom">specifying</span> <span class="s s-Atom">which</span> <span class="s s-Atom">collective</span> <span class="nf">variables</span> <span class="p">(</span><span class="nv">CVs</span><span class="p">)</span> <span class="s s-Atom">should</span> <span class="s s-Atom">be</span> <span class="s s-Atom">used</span> <span class="s s-Atom">for</span> <span class="nv">FES</span> <span class="s s-Atom">calculation</span><span class="p">.</span> <span class="s s-Atom">\</span>

                <span class="nv">Defaults</span> <span class="s s-Atom">to</span> <span class="nv">None</span><span class="p">.</span>

            <span class="nf">cv_range</span> <span class="p">(</span><span class="nv">List</span><span class="p">[</span><span class="s s-Atom">float</span><span class="p">],</span> <span class="s s-Atom">optional</span><span class="p">)</span><span class="o">:</span> <span class="s s-Atom">\</span>

                <span class="nv">A</span> <span class="s s-Atom">list</span> <span class="s s-Atom">of</span> <span class="s s-Atom">two</span> <span class="s s-Atom">numbers</span> <span class="s s-Atom">defining</span> <span class="s s-Atom">the</span> <span class="s s-Atom">lower</span> <span class="s s-Atom">and</span> <span class="s s-Atom">upper</span> <span class="s s-Atom">bounds</span> <span class="s s-Atom">of</span> <span class="s s-Atom">the</span> <span class="nv">CVs</span> <span class="p">(</span><span class="s s-Atom">in</span> <span class="s s-Atom">the</span> <span class="s s-Atom">units</span> <span class="s s-Atom">of</span> <span class="s s-Atom">the</span> <span class="nv">CV</span><span class="p">).</span> <span class="s s-Atom">\</span>

                <span class="nv">Defaults</span> <span class="s s-Atom">to</span> <span class="nv">None</span><span class="p">.</span> <span class="s s-Atom">\</span>

            <span class="nf">time_min</span> <span class="p">(</span><span class="s s-Atom">int</span><span class="p">)</span><span class="o">:</span> <span class="nv">The</span> <span class="s s-Atom">starting</span> <span class="s s-Atom">time</span> <span class="s s-Atom">step</span> <span class="s s-Atom">of</span> <span class="s s-Atom">simulation</span><span class="p">.</span> <span class="nv">Defaults</span> <span class="s s-Atom">to</span> <span class="mf">0.</span>

            <span class="nf">time_max</span> <span class="p">(</span><span class="s s-Atom">int</span><span class="p">,</span> <span class="s s-Atom">optional</span><span class="p">)</span><span class="o">:</span> <span class="nv">The</span> <span class="s s-Atom">ending</span> <span class="s s-Atom">time</span> <span class="s s-Atom">step</span> <span class="s s-Atom">of</span> <span class="s s-Atom">simulation</span><span class="p">.</span> <span class="nv">Defaults</span> <span class="s s-Atom">to</span> <span class="nv">None</span><span class="p">.</span>

        <span class="s2">&quot;&quot;&quot;</span>

<span class="s2">        if resolution is None:</span>

<span class="s2">            resolution = self.res</span>

<span class="s2">        self.generate_cv_map(cv_select, cv_range)</span>

<span class="s2">        cv_min = self.cv_min</span>

<span class="s2">        cv_max = self.cv_max</span>

<span class="s2">        cv_fes_range = self.cv_fes_range</span>

<span class="s2">        cv_bins = np.array([np.ceil(</span>

<span class="s2">            (self.hills.cv[time_min:time_max, cv_index] -</span>

<span class="s2">             cv_min[cv_index]) * resolution / cv_fes_range[cv_index]</span>

<span class="s2">        ) for cv_index in cv_select])</span>

<span class="s2">        cvs = len(cv_select)</span>

<span class="s2">        cv_bins = cv_bins.astype(int)</span>

<span class="s2">        sigma = np.array([self.hills.sigma[cv_index][0]</span>

<span class="s2">                         for cv_index in cv_select])</span>

<span class="s2">        sigma_res = (sigma * self.res) / (cv_max - cv_min)</span>

<span class="s2">        gauss_res = np.max((8 * sigma_res).astype(int))</span>

<span class="s2">        if gauss_res % 2 == 0:</span>

<span class="s2">            gauss_res += 1</span>

<span class="s2">        gauss_center_to_end = int((gauss_res - 1) / 2)</span>

<span class="s2">        gauss_center = gauss_center_to_end + 1</span>

<span class="s2">        grids = np.meshgrid(*[np.arange(gauss_res)] * cvs)</span>

<span class="s2">        exponent = 0.</span>

<span class="s2">        for i in range(len(sigma_res)):</span>

<span class="s2">            i_diff = (grids[i] + 1) - gauss_center</span>

<span class="s2">            exponent += -(i_diff ** 2) / (2 * sigma_res[i] ** 2)</span>

<span class="s2">        gauss = -np.exp(exponent)</span>

<span class="s2">        fes = np.zeros([resolution] * cvs)</span>

<span class="s2">        for line in trange(len(cv_bins[0]), desc=&quot;</span><span class="nv">Constructing</span> <span class="nv">FES</span><span class="err">&quot;</span><span class="p">)</span><span class="o">:</span>

            <span class="s s-Atom">#</span> <span class="s s-Atom">create</span> <span class="s s-Atom">a</span> <span class="s s-Atom">meshgrid</span> <span class="s s-Atom">of</span> <span class="s s-Atom">the</span> <span class="s s-Atom">indexes</span> <span class="s s-Atom">of</span> <span class="s s-Atom">the</span> <span class="s s-Atom">fes</span> <span class="s s-Atom">that</span> <span class="s s-Atom">need</span> <span class="s s-Atom">to</span> <span class="s s-Atom">be</span> <span class="s s-Atom">edited</span>

            <span class="s s-Atom">#</span> <span class="s s-Atom">size</span> <span class="s s-Atom">of</span> <span class="s s-Atom">the</span> <span class="s s-Atom">meshgrid</span> <span class="o">is</span> <span class="s s-Atom">the</span> <span class="s s-Atom">same</span> <span class="s s-Atom">as</span> <span class="s s-Atom">the</span> <span class="s s-Atom">size</span> <span class="s s-Atom">of</span> <span class="s s-Atom">the</span> <span class="s s-Atom">gauss</span>

            <span class="s s-Atom">fes_index_to_edit</span> <span class="o">=</span> <span class="s s-Atom">np</span><span class="p">.</span><span class="nf">meshgrid</span><span class="p">(</span>

                <span class="s s-Atom">*</span><span class="p">([</span>

                    <span class="s s-Atom">np</span><span class="p">.</span><span class="nf">arange</span><span class="p">(</span><span class="s s-Atom">gauss_res</span><span class="p">)</span> <span class="o">-</span> <span class="s s-Atom">gauss_center</span>

                <span class="p">]</span> <span class="o">*</span> <span class="nf">len</span><span class="p">(</span><span class="s s-Atom">cv_bins</span><span class="p">[</span><span class="o">:</span><span class="p">,</span> <span class="s s-Atom">line</span><span class="p">]))</span>

            <span class="p">)</span>

            <span class="s s-Atom">#</span> <span class="s s-Atom">create</span> <span class="s s-Atom">a</span> <span class="s s-Atom">mask</span> <span class="s s-Atom">to</span> <span class="s s-Atom">avoid</span> <span class="s s-Atom">editing</span> <span class="s s-Atom">indexes</span> <span class="s s-Atom">outside</span> <span class="s s-Atom">the</span> <span class="s s-Atom">fes</span>

            <span class="s s-Atom">local_mask</span> <span class="o">=</span> <span class="s s-Atom">np</span><span class="p">.</span><span class="nf">ones_like</span><span class="p">(</span><span class="s s-Atom">gauss</span><span class="p">,</span> <span class="s s-Atom">dtype</span><span class="o">=</span><span class="s s-Atom">int</span><span class="p">)</span>

            <span class="s s-Atom">for</span> <span class="s s-Atom">d</span> <span class="s s-Atom">in</span> <span class="nf">range</span><span class="p">(</span><span class="s s-Atom">cvs</span><span class="p">)</span><span class="o">:</span>

                <span class="s s-Atom">fes_index_to_edit</span><span class="p">[</span><span class="s s-Atom">d</span><span class="p">]</span> <span class="s s-Atom">+=</span> <span class="s s-Atom">cv_bins</span><span class="p">[</span><span class="s s-Atom">d</span><span class="p">][</span><span class="s s-Atom">line</span><span class="p">]</span>

                <span class="s s-Atom">if</span> <span class="o">not</span> <span class="s s-Atom">self</span><span class="p">.</span><span class="s s-Atom">periodic</span><span class="p">[</span><span class="s s-Atom">d</span><span class="p">]</span><span class="o">:</span>

                    <span class="s s-Atom">mask</span> <span class="o">=</span> <span class="s s-Atom">np</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span>

                        <span class="p">(</span><span class="s s-Atom">fes_index_to_edit</span><span class="p">[</span><span class="s s-Atom">d</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span>

                            <span class="s s-Atom">fes_index_to_edit</span><span class="p">[</span><span class="s s-Atom">d</span><span class="p">]</span> <span class="o">&gt;</span> <span class="s s-Atom">resolution</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>

                    <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

                    <span class="s s-Atom">#</span> <span class="s s-Atom">if</span> <span class="s s-Atom">the</span> <span class="s s-Atom">cv</span> <span class="o">is</span> <span class="o">not</span> <span class="s s-Atom">periodic</span><span class="p">,</span> <span class="s s-Atom">remove</span> <span class="s s-Atom">the</span> <span class="s s-Atom">indexes</span> <span class="s s-Atom">outside</span> <span class="s s-Atom">the</span> <span class="s s-Atom">fes</span>

                    <span class="s s-Atom">local_mask</span><span class="p">[</span><span class="s s-Atom">mask</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

                <span class="s s-Atom">#</span> <span class="s s-Atom">make</span> <span class="s s-Atom">sure</span> <span class="s s-Atom">the</span> <span class="s s-Atom">indexes</span> <span class="s s-Atom">are</span> <span class="s s-Atom">inside</span> <span class="s s-Atom">the</span> <span class="s s-Atom">fes</span>

                <span class="s s-Atom">fes_index_to_edit</span><span class="p">[</span><span class="s s-Atom">d</span><span class="p">]</span> <span class="o">=</span> <span class="s s-Atom">np</span><span class="p">.</span><span class="o">mod</span><span class="p">(</span><span class="s s-Atom">fes_index_to_edit</span><span class="p">[</span><span class="s s-Atom">d</span><span class="p">],</span> <span class="s s-Atom">resolution</span><span class="p">)</span>

            <span class="s s-Atom">fes</span><span class="p">[</span><span class="nf">tuple</span><span class="p">(</span><span class="s s-Atom">fes_index_to_edit</span><span class="p">)]</span> <span class="s s-Atom">+=</span> <span class="s s-Atom">gauss</span> <span class="o">*</span> <span class="s s-Atom">\</span>

                <span class="s s-Atom">local_mask</span> <span class="o">*</span> <span class="s s-Atom">self</span><span class="p">.</span><span class="s s-Atom">hills</span><span class="p">.</span><span class="s s-Atom">heights</span><span class="p">[</span><span class="s s-Atom">line</span><span class="p">]</span>

        <span class="s s-Atom">fes</span> <span class="o">=</span> <span class="s s-Atom">fes</span> <span class="o">-</span> <span class="s s-Atom">np</span><span class="p">.</span><span class="nf">min</span><span class="p">(</span><span class="s s-Atom">fes</span><span class="p">)</span>

        <span class="s s-Atom">self</span><span class="p">.</span><span class="s s-Atom">fes</span> <span class="o">=</span> <span class="s s-Atom">fes</span>

        <span class="s s-Atom">return</span> <span class="s s-Atom">fes</span>

    <span class="s s-Atom">def</span> <span class="nf">makefes2</span><span class="p">(</span>

        <span class="s s-Atom">self</span><span class="p">,</span>

        <span class="s s-Atom">resolution</span><span class="p">:</span> <span class="nv">Optional</span><span class="p">[</span><span class="s s-Atom">int</span><span class="p">],</span>

        <span class="s s-Atom">cv_select</span><span class="o">:</span> <span class="nv">Optional</span><span class="p">[</span><span class="nv">List</span><span class="p">[</span><span class="s s-Atom">int</span><span class="p">]]</span> <span class="o">=</span> <span class="nv">None</span><span class="p">,</span>

        <span class="s s-Atom">cv_range</span><span class="o">:</span> <span class="nv">Optional</span><span class="p">[</span><span class="nv">List</span><span class="p">[</span><span class="s s-Atom">float</span><span class="p">]]</span> <span class="o">=</span> <span class="nv">None</span><span class="p">,</span>

        <span class="s s-Atom">time_min</span><span class="o">:</span> <span class="nv">Optional</span><span class="p">[</span><span class="s s-Atom">int</span><span class="p">]</span> <span class="o">=</span> <span class="nv">None</span><span class="p">,</span>

        <span class="s s-Atom">time_max</span><span class="o">:</span> <span class="nv">Optional</span><span class="p">[</span><span class="s s-Atom">int</span><span class="p">]</span> <span class="o">=</span> <span class="nv">None</span>

    <span class="p">)</span><span class="o">:</span>

        <span class="s2">&quot;&quot;</span><span class="err">&quot;</span>

        <span class="nv">Function</span> <span class="s s-Atom">internally</span> <span class="s s-Atom">used</span> <span class="s s-Atom">to</span> <span class="s s-Atom">sum</span> <span class="nv">Hills</span> <span class="s s-Atom">in</span> <span class="s s-Atom">the</span> <span class="s s-Atom">same</span> <span class="s s-Atom">way</span> <span class="s s-Atom">as</span> <span class="nv">Plumed</span> <span class="err">`</span><span class="s s-Atom">sum_hills</span><span class="err">`</span><span class="p">.</span>

        <span class="nv">Args</span><span class="o">:</span>

            <span class="nf">resolution</span> <span class="p">(</span><span class="s s-Atom">int</span><span class="p">,</span> <span class="s s-Atom">optional</span><span class="p">)</span><span class="o">:</span> <span class="s s-Atom">\</span>

                <span class="nv">The</span> <span class="s s-Atom">resolution</span> <span class="s s-Atom">of</span> <span class="s s-Atom">the</span> <span class="s s-Atom">free</span> <span class="s s-Atom">energy</span> <span class="s s-Atom">surface</span><span class="p">.</span> <span class="nv">Defaults</span> <span class="s s-Atom">to</span> <span class="mf">256.</span>

            <span class="nf">cv_select</span> <span class="p">(</span><span class="nv">List</span><span class="p">[</span><span class="s s-Atom">int</span><span class="p">],</span> <span class="s s-Atom">optional</span><span class="p">)</span><span class="o">:</span> <span class="s s-Atom">\</span>

                <span class="nv">A</span> <span class="s s-Atom">list</span> <span class="s s-Atom">of</span> <span class="s s-Atom">integers</span> <span class="s s-Atom">specifying</span> <span class="s s-Atom">which</span> <span class="s s-Atom">collective</span> <span class="nf">variables</span> <span class="p">(</span><span class="nv">CVs</span><span class="p">)</span> <span class="s s-Atom">should</span> <span class="s s-Atom">be</span> <span class="s s-Atom">used</span> <span class="s s-Atom">for</span> <span class="nv">FES</span> <span class="s s-Atom">calculation</span><span class="p">.</span> <span class="s s-Atom">\</span>

                <span class="nv">Defaults</span> <span class="s s-Atom">to</span> <span class="nv">None</span><span class="p">.</span>

            <span class="nf">cv_range</span> <span class="p">(</span><span class="nv">List</span><span class="p">[</span><span class="s s-Atom">float</span><span class="p">],</span> <span class="s s-Atom">optional</span><span class="p">)</span><span class="o">:</span> <span class="s s-Atom">\</span>

                <span class="nv">A</span> <span class="s s-Atom">list</span> <span class="s s-Atom">of</span> <span class="s s-Atom">two</span> <span class="s s-Atom">numbers</span> <span class="s s-Atom">defining</span> <span class="s s-Atom">the</span> <span class="s s-Atom">lower</span> <span class="s s-Atom">and</span> <span class="s s-Atom">upper</span> <span class="s s-Atom">bounds</span> <span class="s s-Atom">of</span> <span class="s s-Atom">the</span> <span class="nv">CVs</span> <span class="p">(</span><span class="s s-Atom">in</span> <span class="s s-Atom">the</span> <span class="s s-Atom">units</span> <span class="s s-Atom">of</span> <span class="s s-Atom">the</span> <span class="nv">CV</span><span class="p">).</span> <span class="s s-Atom">\</span>

                <span class="nv">Defaults</span> <span class="s s-Atom">to</span> <span class="nv">None</span><span class="p">.</span> <span class="s s-Atom">\</span>

            <span class="nf">time_min</span> <span class="p">(</span><span class="s s-Atom">int</span><span class="p">)</span><span class="o">:</span> <span class="nv">The</span> <span class="s s-Atom">starting</span> <span class="s s-Atom">time</span> <span class="s s-Atom">step</span> <span class="s s-Atom">of</span> <span class="s s-Atom">simulation</span><span class="p">.</span> <span class="nv">Defaults</span> <span class="s s-Atom">to</span> <span class="mf">0.</span>

            <span class="nf">time_max</span> <span class="p">(</span><span class="s s-Atom">int</span><span class="p">,</span> <span class="s s-Atom">optional</span><span class="p">)</span><span class="o">:</span> <span class="nv">The</span> <span class="s s-Atom">ending</span> <span class="s s-Atom">time</span> <span class="s s-Atom">step</span> <span class="s s-Atom">of</span> <span class="s s-Atom">simulation</span><span class="p">.</span> <span class="nv">Defaults</span> <span class="s s-Atom">to</span> <span class="nv">None</span><span class="p">.</span>

        <span class="s2">&quot;&quot;&quot;</span>

<span class="s2">        if resolution is None:</span>

<span class="s2">            resolution = self.res</span>

<span class="s2">        self.generate_cv_map(cv_select, cv_range)</span>

<span class="s2">        cv_min = self.cv_min</span>

<span class="s2">        cv_max = self.cv_max</span>

<span class="s2">        cv_fes_range = self.cv_fes_range</span>

<span class="s2">        cvs = len(self.cv_select)</span>

<span class="s2">        fes = np.zeros([resolution] * cvs)</span>

<span class="s2">        if time_min and time_max:</span>

<span class="s2">            time_limit = time_max - time_min</span>

<span class="s2">        else:</span>

<span class="s2">            time_min = 0</span>

<span class="s2">            time_max = self.hills.cv[:, 0].shape[0]</span>

<span class="s2">            time_limit = time_max - time_min</span>

<span class="s2">        for index in tqdm(np.ndindex(fes.shape),  # type: ignore</span>

<span class="s2">                          desc=&quot;</span><span class="nv">Constructing</span> <span class="nv">FES</span><span class="err">&quot;</span><span class="p">,</span>

                          <span class="s s-Atom">total</span><span class="o">=</span><span class="s s-Atom">np</span><span class="p">.</span><span class="nf">prod</span><span class="p">(</span><span class="s s-Atom">fes</span><span class="p">.</span><span class="s s-Atom">shape</span><span class="p">))</span><span class="o">:</span>  <span class="s s-Atom">#</span> <span class="s s-Atom">type</span><span class="p">:</span> <span class="s s-Atom">ignore</span>

            <span class="s s-Atom">dp2_array</span> <span class="o">=</span> <span class="s s-Atom">np</span><span class="p">.</span><span class="nf">zeros</span><span class="p">([</span><span class="s s-Atom">cvs</span><span class="p">,</span> <span class="s s-Atom">time_limit</span><span class="p">])</span>

            <span class="s s-Atom">for</span> <span class="s s-Atom">i</span><span class="p">,</span> <span class="s s-Atom">cv_idx</span> <span class="s s-Atom">in</span> <span class="nf">enumerate</span><span class="p">(</span><span class="s s-Atom">self</span><span class="p">.</span><span class="s s-Atom">cv_select</span><span class="p">)</span><span class="o">:</span>

                <span class="s s-Atom">dist_cv</span> <span class="o">=</span> <span class="s s-Atom">\</span>

                    <span class="s s-Atom">self</span><span class="p">.</span><span class="s s-Atom">hills</span><span class="p">.</span><span class="s s-Atom">cv</span><span class="p">[</span><span class="o">:</span><span class="p">,</span> <span class="s s-Atom">cv_idx</span><span class="p">]</span> <span class="o">-</span> <span class="s s-Atom">\</span>

                    <span class="p">(</span><span class="s s-Atom">cv_min</span><span class="p">[</span><span class="s s-Atom">i</span><span class="p">]</span> <span class="o">+</span> <span class="s s-Atom">index</span><span class="p">[</span><span class="s s-Atom">i</span><span class="p">]</span> <span class="o">*</span> <span class="s s-Atom">cv_fes_range</span><span class="p">[</span><span class="s s-Atom">i</span><span class="p">]</span> <span class="o">/</span> <span class="s s-Atom">resolution</span><span class="p">)</span>

                <span class="s s-Atom">if</span> <span class="s s-Atom">self</span><span class="p">.</span><span class="s s-Atom">periodic</span><span class="p">[</span><span class="s s-Atom">cv_idx</span><span class="p">]</span><span class="o">:</span>

                    <span class="s s-Atom">dist_cv</span><span class="p">[</span><span class="s s-Atom">dist_cv</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mf">0.5</span><span class="o">*</span><span class="s s-Atom">cv_fes_range</span><span class="p">[</span><span class="s s-Atom">i</span><span class="p">]]</span> <span class="s s-Atom">+=</span> <span class="s s-Atom">cv_fes_range</span><span class="p">[</span><span class="s s-Atom">i</span><span class="p">]</span>

                    <span class="s s-Atom">dist_cv</span><span class="p">[</span><span class="s s-Atom">dist_cv</span> <span class="o">&gt;</span> <span class="o">+</span><span class="mf">0.5</span><span class="o">*</span><span class="s s-Atom">cv_fes_range</span><span class="p">[</span><span class="s s-Atom">i</span><span class="p">]]</span> <span class="s s-Atom">-=</span> <span class="s s-Atom">cv_fes_range</span><span class="p">[</span><span class="s s-Atom">i</span><span class="p">]</span>

                <span class="s s-Atom">dp2_local</span> <span class="o">=</span> <span class="s s-Atom">dist_cv</span> <span class="s s-Atom">**</span> <span class="mi">2</span> <span class="o">/</span> <span class="s s-Atom">\</span>

                    <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="s s-Atom">self</span><span class="p">.</span><span class="s s-Atom">hills</span><span class="p">.</span><span class="s s-Atom">sigma</span><span class="p">[</span><span class="s s-Atom">cv_idx</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="s s-Atom">**</span> <span class="mi">2</span><span class="p">)</span>

                <span class="s s-Atom">dp2_array</span><span class="p">[</span><span class="s s-Atom">i</span><span class="p">]</span> <span class="o">=</span> <span class="s s-Atom">dp2_local</span>

            <span class="s s-Atom">dp2</span> <span class="o">=</span> <span class="s s-Atom">np</span><span class="p">.</span><span class="nf">sum</span><span class="p">(</span><span class="s s-Atom">dp2_array</span><span class="p">,</span> <span class="s s-Atom">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

            <span class="s s-Atom">tmp</span> <span class="o">=</span> <span class="s s-Atom">np</span><span class="p">.</span><span class="nf">zeros</span><span class="p">(</span><span class="s s-Atom">time_limit</span><span class="p">)</span>

            <span class="s s-Atom">tmp</span><span class="p">[</span><span class="s s-Atom">dp2</span> <span class="o">&lt;</span> <span class="mf">6.25</span><span class="p">]</span> <span class="o">=</span> <span class="s s-Atom">self</span><span class="p">.</span><span class="s s-Atom">hills</span><span class="p">.</span><span class="s s-Atom">heights</span><span class="p">[</span><span class="s s-Atom">dp2</span> <span class="o">&lt;</span> <span class="mf">6.25</span><span class="p">]</span> <span class="o">*</span> <span class="s s-Atom">\</span>

                <span class="p">(</span><span class="s s-Atom">np</span><span class="p">.</span><span class="nf">exp</span><span class="p">(</span><span class="o">-</span><span class="s s-Atom">dp2</span><span class="p">[</span><span class="s s-Atom">dp2</span> <span class="o">&lt;</span> <span class="mf">6.25</span><span class="p">])</span> <span class="o">*</span>

                 <span class="mf">1.00193418799744762399</span> <span class="o">-</span> <span class="mf">0.00193418799744762399</span><span class="p">)</span>

            <span class="s s-Atom">fes</span><span class="p">[</span><span class="s s-Atom">index</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="s s-Atom">tmp</span><span class="p">.</span><span class="nf">sum</span><span class="p">()</span>

        <span class="s s-Atom">fes</span> <span class="o">=</span> <span class="s s-Atom">fes</span> <span class="o">-</span> <span class="s s-Atom">np</span><span class="p">.</span><span class="nf">min</span><span class="p">(</span><span class="s s-Atom">fes</span><span class="p">)</span>

        <span class="s s-Atom">self</span><span class="p">.</span><span class="s s-Atom">fes</span> <span class="o">=</span> <span class="s s-Atom">np</span><span class="p">.</span><span class="nf">array</span><span class="p">(</span><span class="s s-Atom">fes</span><span class="p">)</span>

    <span class="s s-Atom">def</span> <span class="nf">plot</span><span class="p">(</span>

        <span class="s s-Atom">self</span><span class="p">,</span>

        <span class="s s-Atom">png_name</span><span class="o">:</span> <span class="nv">Optional</span><span class="p">[</span><span class="s s-Atom">str</span><span class="p">]</span> <span class="o">=</span> <span class="nv">None</span><span class="p">,</span>

        <span class="s s-Atom">contours</span><span class="p">:</span> <span class="s s-Atom">bool</span> <span class="o">=</span> <span class="nv">True</span><span class="p">,</span>

        <span class="s s-Atom">contours_spacing</span><span class="o">:</span> <span class="s s-Atom">float</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span>

        <span class="s s-Atom">aspect</span><span class="p">:</span> <span class="s s-Atom">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>

        <span class="s s-Atom">cmap</span><span class="p">:</span> <span class="s s-Atom">str</span> <span class="o">=</span> <span class="s2">&quot;jet&quot;</span><span class="p">,</span>

        <span class="s s-Atom">energy_unit</span><span class="o">:</span> <span class="s s-Atom">str</span> <span class="o">=</span> <span class="s2">&quot;kJ/mol&quot;</span><span class="p">,</span>

        <span class="s s-Atom">xlabel</span><span class="p">:</span> <span class="nv">Optional</span><span class="p">[</span><span class="s s-Atom">str</span><span class="p">]</span> <span class="o">=</span> <span class="nv">None</span><span class="p">,</span>

        <span class="s s-Atom">ylabel</span><span class="p">:</span> <span class="nv">Optional</span><span class="p">[</span><span class="s s-Atom">str</span><span class="p">]</span> <span class="o">=</span> <span class="nv">None</span><span class="p">,</span>

        <span class="s s-Atom">zlabel</span><span class="p">:</span> <span class="nv">Optional</span><span class="p">[</span><span class="s s-Atom">str</span><span class="p">]</span> <span class="o">=</span> <span class="nv">None</span><span class="p">,</span>

        <span class="s s-Atom">label_size</span><span class="o">:</span> <span class="s s-Atom">int</span> <span class="o">=</span> <span class="mi">12</span><span class="p">,</span>

        <span class="s s-Atom">image_size</span><span class="o">:</span> <span class="nv">List</span><span class="p">[</span><span class="s s-Atom">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">7</span><span class="p">],</span>

        <span class="s s-Atom">vmin</span><span class="p">:</span> <span class="s s-Atom">float</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>

        <span class="s s-Atom">vmax</span><span class="p">:</span> <span class="nv">Optional</span><span class="p">[</span><span class="s s-Atom">float</span><span class="p">]</span> <span class="o">=</span> <span class="nv">None</span><span class="p">,</span>

        <span class="s s-Atom">opacity</span><span class="p">:</span> <span class="s s-Atom">float</span> <span class="o">=</span> <span class="mf">0.2</span><span class="p">,</span>

        <span class="s s-Atom">levels</span><span class="p">:</span> <span class="nv">Optional</span><span class="p">[</span><span class="nv">List</span><span class="p">[</span><span class="s s-Atom">float</span><span class="p">]]</span> <span class="o">=</span> <span class="nv">None</span><span class="p">,</span>

    <span class="p">)</span><span class="o">:</span>

        <span class="s2">&quot;&quot;&quot;</span>

<span class="s2">        Visualizes the free energy surface (FES) using Matplotlib and PyVista.</span>

<span class="s2">        Usage:</span>

<span class="s2">        ```python</span>

<span class="s2">        fes.plot()</span>

<span class="s2">        ```</span>

<span class="s2">        Args:</span>

<span class="s2">            png_name (str, optional): If provided, the picture of FES will be saved under this name in the current working directory.</span>

<span class="s2">            contours (bool, default=True): Determines whether contours should be shown on the 2D FES.</span>

<span class="s2">            contours_spacing (float, default=0.0): When a positive number is set, it will be used as the spacing for contours on the 2D FES. Otherwise, if contours=True, there will be five equally spaced contour levels.</span>

<span class="s2">            aspect (float, default=1.0): The aspect ratio of the graph. Works with 1D and 2D FES.</span>

<span class="s2">            cmap (str, default=&quot;</span><span class="s s-Atom">jet</span><span class="s2">&quot;): The Matplotlib colormap used to color the 2D or 3D FES.</span>

<span class="s2">            energy_unit (str, default=&quot;</span><span class="s s-Atom">kJ</span><span class="o">/</span><span class="s s-Atom">mol</span><span class="s2">&quot;): The unit used in the description of the colorbar.</span>

<span class="s2">            xlabel, ylabel, zlabel (str, optional): If provided, they will be used as labels for the graphs.</span>

<span class="s2">            label_size (int, default=12): The size of text in the labels.</span>

<span class="s2">            image_size (List[int], default=[10,7]): The width and height of the picture.</span>

<span class="s2">            vmin (float, default=0): The lower bound for the colormap on the 2D FES.</span>

<span class="s2">            vmax (float, optional): The upper bound for the colormap on the 2D FES.</span>

<span class="s2">            opacity (float, default=0.2): A number between 0 and 1 that represents the opacity of isosurfaces in the 3D FES.</span>

<span class="s2">            levels (List[float], optional): A list of free energy values for isosurfaces in the 3D FES. If not provided, default values from the contours parameters will be used instead.</span>

<span class="s2">        &quot;&quot;&quot;</span>

        <span class="s s-Atom">import</span> <span class="s s-Atom">matplotlib</span><span class="p">.</span><span class="s s-Atom">cm</span> <span class="s s-Atom">as</span> <span class="s s-Atom">cm</span>

        <span class="s s-Atom">import</span> <span class="s s-Atom">matplotlib</span><span class="p">.</span><span class="s s-Atom">pyplot</span> <span class="s s-Atom">as</span> <span class="s s-Atom">plt</span>

        <span class="s s-Atom">if</span> <span class="s s-Atom">self</span><span class="p">.</span><span class="s s-Atom">fes</span> <span class="o">is</span> <span class="nv">None</span><span class="o">:</span>

            <span class="s s-Atom">raise</span> <span class="nv">ValueError</span><span class="p">(</span>

                <span class="s2">&quot;FES not calculated yet. Use makefes() or makefes2() first.&quot;</span><span class="p">)</span>

        <span class="s s-Atom">if</span> <span class="s s-Atom">vmax</span> <span class="o">==</span> <span class="nv">None</span><span class="o">:</span>

            <span class="s s-Atom">#</span> <span class="s s-Atom">if</span> <span class="s s-Atom">the</span> <span class="s s-Atom">addition</span> <span class="o">is</span> <span class="s s-Atom">smaller</span> <span class="s s-Atom">than</span> <span class="mf">0.01</span><span class="p">,</span> <span class="s s-Atom">the</span> <span class="mi">3</span><span class="s s-Atom">d</span> <span class="s s-Atom">plot</span> <span class="s s-Atom">stops</span> <span class="s s-Atom">working</span><span class="p">.</span>

            <span class="s s-Atom">vmax</span> <span class="o">=</span> <span class="s s-Atom">np</span><span class="p">.</span><span class="nf">max</span><span class="p">(</span><span class="s s-Atom">self</span><span class="p">.</span><span class="s s-Atom">fes</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.01</span>

        <span class="s s-Atom">if</span> <span class="s s-Atom">contours_spacing</span> <span class="o">==</span> <span class="mf">0.0</span><span class="o">:</span>

            <span class="s s-Atom">contours_spacing</span> <span class="o">=</span> <span class="p">(</span><span class="s s-Atom">vmax</span><span class="o">-</span><span class="s s-Atom">vmin</span><span class="p">)</span><span class="o">/</span><span class="mf">5.0</span>

        <span class="s s-Atom">cmap</span> <span class="o">=</span> <span class="s s-Atom">cm</span><span class="p">.</span><span class="nf">get_cmap</span><span class="p">(</span><span class="s s-Atom">cmap</span><span class="p">)</span>

        <span class="s s-Atom">cmap</span><span class="p">.</span><span class="nf">set_over</span><span class="p">(</span><span class="s2">&quot;white&quot;</span><span class="p">)</span>

        <span class="s s-Atom">cmap</span><span class="p">.</span><span class="nf">set_under</span><span class="p">(</span><span class="s2">&quot;white&quot;</span><span class="p">)</span>

        <span class="s s-Atom">cvs</span> <span class="o">=</span> <span class="nf">len</span><span class="p">(</span><span class="s s-Atom">self</span><span class="p">.</span><span class="s s-Atom">cv_select</span><span class="p">)</span>

        <span class="s s-Atom">if</span> <span class="s s-Atom">cvs</span> <span class="o">==</span> <span class="mi">1</span><span class="o">:</span>

            <span class="s s-Atom">cv_index</span> <span class="o">=</span> <span class="s s-Atom">self</span><span class="p">.</span><span class="s s-Atom">cv_select</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

            <span class="s s-Atom">plt</span><span class="p">.</span><span class="nf">figure</span><span class="p">(</span><span class="s s-Atom">figsize=</span><span class="p">(</span><span class="s s-Atom">image_size</span><span class="p">[</span><span class="s s-Atom">cv_index</span><span class="p">],</span> <span class="s s-Atom">image_size</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>

            <span class="nv">X</span> <span class="o">=</span> <span class="s s-Atom">np</span><span class="p">.</span><span class="nf">linspace</span><span class="p">(</span><span class="s s-Atom">self</span><span class="p">.</span><span class="s s-Atom">cv_min</span><span class="p">[</span><span class="s s-Atom">cv_index</span><span class="p">],</span>

                            <span class="s s-Atom">self</span><span class="p">.</span><span class="s s-Atom">cv_max</span><span class="p">[</span><span class="s s-Atom">cv_index</span><span class="p">],</span> <span class="s s-Atom">self</span><span class="p">.</span><span class="s s-Atom">res</span><span class="p">)</span>

            <span class="s s-Atom">plt</span><span class="p">.</span><span class="nf">plot</span><span class="p">(</span><span class="nv">X</span><span class="p">,</span> <span class="s s-Atom">self</span><span class="p">.</span><span class="s s-Atom">fes</span><span class="p">)</span>

            <span class="s s-Atom">if</span> <span class="s s-Atom">xlabel</span> <span class="o">==</span> <span class="nv">None</span><span class="o">:</span>

                <span class="s s-Atom">plt</span><span class="p">.</span><span class="nf">xlabel</span><span class="p">(</span>

                    <span class="s s-Atom">f&#39;CV1 - {self.hills.cv_name[cv_index]}&#39;</span><span class="p">,</span> <span class="s s-Atom">size</span><span class="o">=</span><span class="s s-Atom">label_size</span><span class="p">)</span>

            <span class="s s-Atom">else</span><span class="p">:</span>

                <span class="s s-Atom">plt</span><span class="p">.</span><span class="nf">xlabel</span><span class="p">(</span><span class="s s-Atom">xlabel</span><span class="p">,</span> <span class="s s-Atom">size</span><span class="o">=</span><span class="s s-Atom">label_size</span><span class="p">)</span>

            <span class="s s-Atom">if</span> <span class="s s-Atom">ylabel</span> <span class="o">==</span> <span class="nv">None</span><span class="o">:</span>

                <span class="s s-Atom">plt</span><span class="p">.</span><span class="nf">ylabel</span><span class="p">(</span><span class="s s-Atom">f&#39;free energy ({energy_unit})&#39;</span><span class="p">,</span> <span class="s s-Atom">size</span><span class="o">=</span><span class="s s-Atom">label_size</span><span class="p">)</span>

            <span class="s s-Atom">else</span><span class="p">:</span>

                <span class="s s-Atom">plt</span><span class="p">.</span><span class="nf">ylabel</span><span class="p">(</span><span class="s s-Atom">ylabel</span><span class="p">,</span> <span class="s s-Atom">size</span><span class="o">=</span><span class="s s-Atom">label_size</span><span class="p">)</span>

        <span class="s s-Atom">elif</span> <span class="s s-Atom">cvs</span> <span class="o">==</span> <span class="mi">2</span><span class="o">:</span>

            <span class="s s-Atom">cv1_index</span> <span class="o">=</span> <span class="s s-Atom">self</span><span class="p">.</span><span class="s s-Atom">cv_select</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

            <span class="s s-Atom">cv2_index</span> <span class="o">=</span> <span class="s s-Atom">self</span><span class="p">.</span><span class="s s-Atom">cv_select</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

            <span class="s s-Atom">cv1min</span> <span class="o">=</span> <span class="s s-Atom">self</span><span class="p">.</span><span class="s s-Atom">cv_min</span><span class="p">[</span><span class="s s-Atom">self</span><span class="p">.</span><span class="s s-Atom">cv_select</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>

            <span class="s s-Atom">cv1max</span> <span class="o">=</span> <span class="s s-Atom">self</span><span class="p">.</span><span class="s s-Atom">cv_max</span><span class="p">[</span><span class="s s-Atom">self</span><span class="p">.</span><span class="s s-Atom">cv_select</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>

            <span class="s s-Atom">cv2min</span> <span class="o">=</span> <span class="s s-Atom">self</span><span class="p">.</span><span class="s s-Atom">cv_min</span><span class="p">[</span><span class="s s-Atom">self</span><span class="p">.</span><span class="s s-Atom">cv_select</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>

            <span class="s s-Atom">cv2max</span> <span class="o">=</span> <span class="s s-Atom">self</span><span class="p">.</span><span class="s s-Atom">cv_max</span><span class="p">[</span><span class="s s-Atom">self</span><span class="p">.</span><span class="s s-Atom">cv_select</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>

            <span class="s s-Atom">fig</span> <span class="o">=</span> <span class="s s-Atom">plt</span><span class="p">.</span><span class="nf">figure</span><span class="p">(</span><span class="s s-Atom">figsize=</span><span class="p">(</span><span class="s s-Atom">image_size</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s s-Atom">image_size</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>

            <span class="s s-Atom">plt</span><span class="p">.</span><span class="nf">imshow</span><span class="p">(</span><span class="s s-Atom">np</span><span class="p">.</span><span class="nf">rot90</span><span class="p">(</span><span class="s s-Atom">self</span><span class="p">.</span><span class="s s-Atom">fes</span><span class="p">,</span> <span class="s s-Atom">axes=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)),</span> <span class="s s-Atom">cmap</span><span class="o">=</span><span class="s s-Atom">cmap</span><span class="p">,</span> <span class="s s-Atom">interpolation=&#39;nearest&#39;</span><span class="p">,</span>

                       <span class="s s-Atom">extent</span><span class="o">=</span><span class="p">[</span><span class="s s-Atom">cv1min</span><span class="p">,</span> <span class="s s-Atom">cv1max</span><span class="p">,</span> <span class="s s-Atom">cv2min</span><span class="p">,</span> <span class="s s-Atom">cv2max</span><span class="p">],</span>

                       <span class="s s-Atom">aspect=</span><span class="p">(((</span><span class="s s-Atom">cv1max</span><span class="o">-</span><span class="s s-Atom">cv1min</span><span class="p">)</span><span class="s s-Atom">/</span><span class="p">(</span><span class="s s-Atom">cv2max</span><span class="o">-</span><span class="s s-Atom">cv2min</span><span class="p">))</span><span class="s s-Atom">/</span><span class="p">(</span><span class="s s-Atom">aspect</span><span class="p">)),</span>

                       <span class="s s-Atom">vmin</span><span class="o">=</span><span class="s s-Atom">vmin</span><span class="p">,</span> <span class="s s-Atom">vmax</span><span class="o">=</span><span class="s s-Atom">vmax</span><span class="p">)</span>  <span class="s s-Atom">#</span> <span class="s s-Atom">type</span><span class="p">:</span> <span class="s s-Atom">ignore</span>

            <span class="s s-Atom">cbar</span> <span class="o">=</span> <span class="s s-Atom">plt</span><span class="p">.</span><span class="nf">colorbar</span><span class="p">()</span>

            <span class="s s-Atom">cbar</span><span class="p">.</span><span class="nf">set_label</span><span class="p">(</span><span class="s s-Atom">energy_unit</span><span class="p">,</span> <span class="s s-Atom">size</span><span class="o">=</span><span class="s s-Atom">label_size</span><span class="p">)</span>

            <span class="s s-Atom">if</span> <span class="s s-Atom">contours</span><span class="p">:</span>

                <span class="s s-Atom">cont</span> <span class="o">=</span> <span class="s s-Atom">plt</span><span class="p">.</span><span class="nf">contour</span><span class="p">(</span><span class="s s-Atom">np</span><span class="p">.</span><span class="nf">rot90</span><span class="p">(</span><span class="s s-Atom">self</span><span class="p">.</span><span class="s s-Atom">fes</span><span class="p">,</span> <span class="s s-Atom">axes=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)),</span>

                                   <span class="s s-Atom">levels</span><span class="o">=</span><span class="s s-Atom">np</span><span class="p">.</span><span class="nf">arange</span><span class="p">(</span>

                                       <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="s s-Atom">vmax</span> <span class="o">-</span> <span class="mf">0.01</span><span class="p">),</span> <span class="s s-Atom">contours_spacing</span><span class="p">),</span>

                                   <span class="s s-Atom">extent</span><span class="o">=</span><span class="p">[</span><span class="s s-Atom">cv1min</span><span class="p">,</span> <span class="s s-Atom">cv1max</span><span class="p">,</span> <span class="s s-Atom">cv2max</span><span class="p">,</span> <span class="s s-Atom">cv2min</span><span class="p">],</span>

                                   <span class="s s-Atom">colors=</span><span class="s2">&quot;k&quot;</span><span class="p">)</span>

                <span class="s s-Atom">plt</span><span class="p">.</span><span class="nf">clabel</span><span class="p">(</span><span class="s s-Atom">cont</span><span class="p">,</span> <span class="s s-Atom">levels</span><span class="o">=</span><span class="s s-Atom">np</span><span class="p">.</span><span class="nf">arange</span><span class="p">(</span>

                    <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="s s-Atom">vmax</span> <span class="o">-</span> <span class="mf">0.01</span><span class="p">),</span> <span class="s s-Atom">contours_spacing</span><span class="p">))</span>

            <span class="s s-Atom">if</span> <span class="s s-Atom">xlabel</span> <span class="o">==</span> <span class="nv">None</span><span class="o">:</span>

                <span class="s s-Atom">plt</span><span class="p">.</span><span class="nf">xlabel</span><span class="p">(</span>

                    <span class="s s-Atom">f&#39;CV1 - {self.hills.cv_name[cv1_index]}&#39;</span><span class="p">,</span> <span class="s s-Atom">size</span><span class="o">=</span><span class="s s-Atom">label_size</span><span class="p">)</span>

            <span class="s s-Atom">else</span><span class="p">:</span>

                <span class="s s-Atom">plt</span><span class="p">.</span><span class="nf">xlabel</span><span class="p">(</span><span class="s s-Atom">xlabel</span><span class="p">,</span> <span class="s s-Atom">size</span><span class="o">=</span><span class="s s-Atom">label_size</span><span class="p">)</span>

            <span class="s s-Atom">if</span> <span class="s s-Atom">ylabel</span> <span class="o">==</span> <span class="nv">None</span><span class="o">:</span>

                <span class="s s-Atom">plt</span><span class="p">.</span><span class="nf">ylabel</span><span class="p">(</span>

                    <span class="s s-Atom">f&#39;CV2 - {self.hills.cv_name[cv2_index]}&#39;</span><span class="p">,</span> <span class="s s-Atom">size</span><span class="o">=</span><span class="s s-Atom">label_size</span><span class="p">)</span>

            <span class="s s-Atom">else</span><span class="p">:</span>

                <span class="s s-Atom">plt</span><span class="p">.</span><span class="nf">ylabel</span><span class="p">(</span><span class="s s-Atom">ylabel</span><span class="p">,</span> <span class="s s-Atom">size</span><span class="o">=</span><span class="s s-Atom">label_size</span><span class="p">)</span>

        <span class="s s-Atom">elif</span> <span class="s s-Atom">cvs</span> <span class="o">==</span> <span class="mi">3</span><span class="o">:</span>

            <span class="s s-Atom">try</span><span class="p">:</span>

                <span class="s s-Atom">import</span> <span class="s s-Atom">pyvista</span> <span class="s s-Atom">as</span> <span class="s s-Atom">pv</span>

            <span class="nf">except</span> <span class="p">(</span><span class="nv">ImportError</span><span class="p">,</span> <span class="nv">ModuleNotFoundError</span><span class="p">)</span> <span class="s s-Atom">as</span> <span class="s s-Atom">e</span><span class="p">:</span>

                <span class="nf">print</span><span class="p">(</span><span class="s s-Atom">e</span><span class="p">)</span>

                <span class="s s-Atom">sys</span><span class="p">.</span><span class="nf">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

            <span class="s s-Atom">cv1_index</span> <span class="o">=</span> <span class="s s-Atom">self</span><span class="p">.</span><span class="s s-Atom">cv_select</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

            <span class="s s-Atom">cv2_index</span> <span class="o">=</span> <span class="s s-Atom">self</span><span class="p">.</span><span class="s s-Atom">cv_select</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

            <span class="s s-Atom">cv3_index</span> <span class="o">=</span> <span class="s s-Atom">self</span><span class="p">.</span><span class="s s-Atom">cv_select</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

            <span class="s s-Atom">cv1min</span> <span class="o">=</span> <span class="s s-Atom">self</span><span class="p">.</span><span class="s s-Atom">cv_min</span><span class="p">[</span><span class="s s-Atom">self</span><span class="p">.</span><span class="s s-Atom">cv_select</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>

            <span class="s s-Atom">cv1max</span> <span class="o">=</span> <span class="s s-Atom">self</span><span class="p">.</span><span class="s s-Atom">cv_max</span><span class="p">[</span><span class="s s-Atom">self</span><span class="p">.</span><span class="s s-Atom">cv_select</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>

            <span class="s s-Atom">cv2min</span> <span class="o">=</span> <span class="s s-Atom">self</span><span class="p">.</span><span class="s s-Atom">cv_min</span><span class="p">[</span><span class="s s-Atom">self</span><span class="p">.</span><span class="s s-Atom">cv_select</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>

            <span class="s s-Atom">cv2max</span> <span class="o">=</span> <span class="s s-Atom">self</span><span class="p">.</span><span class="s s-Atom">cv_max</span><span class="p">[</span><span class="s s-Atom">self</span><span class="p">.</span><span class="s s-Atom">cv_select</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>

            <span class="s s-Atom">cv3min</span> <span class="o">=</span> <span class="s s-Atom">self</span><span class="p">.</span><span class="s s-Atom">cv_min</span><span class="p">[</span><span class="s s-Atom">self</span><span class="p">.</span><span class="s s-Atom">cv_select</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span>

            <span class="s s-Atom">cv3max</span> <span class="o">=</span> <span class="s s-Atom">self</span><span class="p">.</span><span class="s s-Atom">cv_max</span><span class="p">[</span><span class="s s-Atom">self</span><span class="p">.</span><span class="s s-Atom">cv_select</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span>

            <span class="s s-Atom">if</span> <span class="s s-Atom">xlabel</span> <span class="o">==</span> <span class="nv">None</span><span class="o">:</span>

                <span class="s s-Atom">xlabel</span> <span class="o">=</span> <span class="s2">&quot;CV1 - &quot;</span> <span class="o">+</span> <span class="s s-Atom">self</span><span class="p">.</span><span class="s s-Atom">hills</span><span class="p">.</span><span class="s s-Atom">cv_name</span><span class="p">[</span><span class="s s-Atom">cv1_index</span><span class="p">]</span>

            <span class="s s-Atom">if</span> <span class="s s-Atom">ylabel</span> <span class="o">==</span> <span class="nv">None</span><span class="o">:</span>

                <span class="s s-Atom">ylabel</span> <span class="o">=</span> <span class="s2">&quot;CV2 - &quot;</span> <span class="o">+</span> <span class="s s-Atom">self</span><span class="p">.</span><span class="s s-Atom">hills</span><span class="p">.</span><span class="s s-Atom">cv_name</span><span class="p">[</span><span class="s s-Atom">cv2_index</span><span class="p">]</span>

            <span class="s s-Atom">if</span> <span class="s s-Atom">zlabel</span> <span class="o">==</span> <span class="nv">None</span><span class="o">:</span>

                <span class="s s-Atom">zlabel</span> <span class="o">=</span> <span class="s2">&quot;CV3 - &quot;</span> <span class="o">+</span> <span class="s s-Atom">self</span><span class="p">.</span><span class="s s-Atom">hills</span><span class="p">.</span><span class="s s-Atom">cv_name</span><span class="p">[</span><span class="s s-Atom">cv3_index</span><span class="p">]</span>

            <span class="s s-Atom">grid</span> <span class="o">=</span> <span class="s s-Atom">pv</span><span class="p">.</span><span class="nv">UniformGrid</span><span class="p">(</span>

                <span class="s s-Atom">dimensions=</span><span class="p">(</span><span class="s s-Atom">self</span><span class="p">.</span><span class="s s-Atom">res</span><span class="p">,</span> <span class="s s-Atom">self</span><span class="p">.</span><span class="s s-Atom">res</span><span class="p">,</span> <span class="s s-Atom">self</span><span class="p">.</span><span class="s s-Atom">res</span><span class="p">),</span>

                <span class="s s-Atom">spacing=</span><span class="p">((</span><span class="s s-Atom">cv1max</span><span class="o">-</span><span class="s s-Atom">cv1min</span><span class="p">)</span><span class="o">/</span><span class="s s-Atom">self</span><span class="p">.</span><span class="s s-Atom">res</span><span class="p">,</span> <span class="p">(</span><span class="s s-Atom">cv2max</span><span class="o">-</span><span class="s s-Atom">cv2min</span><span class="p">)</span> <span class="o">/</span>

                         <span class="s s-Atom">self</span><span class="p">.</span><span class="s s-Atom">res</span><span class="p">,</span> <span class="p">(</span><span class="s s-Atom">cv3max</span><span class="o">-</span><span class="s s-Atom">cv3min</span><span class="p">)</span><span class="o">/</span><span class="s s-Atom">self</span><span class="p">.</span><span class="s s-Atom">res</span><span class="p">),</span>

                <span class="s s-Atom">origin=</span><span class="p">(</span><span class="s s-Atom">cv1min</span><span class="p">,</span> <span class="s s-Atom">cv2min</span><span class="p">,</span> <span class="s s-Atom">cv3min</span><span class="p">)</span>

            <span class="p">)</span>

            <span class="s s-Atom">grid</span><span class="p">[</span><span class="s2">&quot;vol&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s s-Atom">self</span><span class="p">.</span><span class="s s-Atom">fes</span><span class="p">.</span><span class="nf">ravel</span><span class="p">(</span><span class="s s-Atom">order=</span><span class="s2">&quot;F&quot;</span><span class="p">)</span>

            <span class="s s-Atom">if</span> <span class="s s-Atom">levels</span> <span class="o">==</span> <span class="nv">None</span><span class="o">:</span>

                <span class="s s-Atom">contours</span> <span class="o">=</span> <span class="s s-Atom">grid</span><span class="p">.</span><span class="nf">contour</span><span class="p">(</span>

                    <span class="s s-Atom">np</span><span class="p">.</span><span class="nf">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="s s-Atom">vmax</span> <span class="o">-</span> <span class="mf">0.01</span><span class="p">),</span> <span class="s s-Atom">contours_spacing</span><span class="p">))</span>

            <span class="s s-Atom">else</span><span class="p">:</span>

                <span class="s s-Atom">contours</span> <span class="o">=</span> <span class="s s-Atom">grid</span><span class="p">.</span><span class="nf">contour</span><span class="p">(</span><span class="s s-Atom">levels</span><span class="p">)</span>

            <span class="s s-Atom">fescolors</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="s s-Atom">for</span> <span class="s s-Atom">i</span> <span class="s s-Atom">in</span> <span class="nf">range</span><span class="p">(</span><span class="s s-Atom">contours</span><span class="p">.</span><span class="s s-Atom">points</span><span class="p">.</span><span class="s s-Atom">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">:</span>

                <span class="s s-Atom">fescolors</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="s s-Atom">self</span><span class="p">.</span><span class="s s-Atom">fes</span><span class="p">[</span><span class="nf">int</span><span class="p">((</span><span class="s s-Atom">contours</span><span class="p">.</span><span class="s s-Atom">points</span><span class="p">[</span><span class="s s-Atom">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="s s-Atom">cv1min</span><span class="p">)</span><span class="o">*</span><span class="s s-Atom">self</span><span class="p">.</span><span class="s s-Atom">res/</span><span class="p">(</span><span class="s s-Atom">cv1max</span><span class="o">-</span><span class="s s-Atom">cv1min</span><span class="p">)),</span>

                                          <span class="nf">int</span><span class="p">((</span>

                                              <span class="s s-Atom">contours</span><span class="p">.</span><span class="s s-Atom">points</span><span class="p">[</span><span class="s s-Atom">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="s s-Atom">cv2min</span><span class="p">)</span><span class="o">*</span><span class="s s-Atom">self</span><span class="p">.</span><span class="s s-Atom">res/</span><span class="p">(</span><span class="s s-Atom">cv2max</span><span class="o">-</span><span class="s s-Atom">cv2min</span><span class="p">)),</span>

                                          <span class="nf">int</span><span class="p">((</span><span class="s s-Atom">contours</span><span class="p">.</span><span class="s s-Atom">points</span><span class="p">[</span><span class="s s-Atom">i</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="s s-Atom">cv3min</span><span class="p">)</span><span class="o">*</span><span class="s s-Atom">self</span><span class="p">.</span><span class="s s-Atom">res/</span><span class="p">(</span><span class="s s-Atom">cv3max</span><span class="o">-</span><span class="s s-Atom">cv3min</span><span class="p">))])</span>

            <span class="s s-Atom">#</span> <span class="c1">%% Visualization</span>

            <span class="s s-Atom">pv</span><span class="p">.</span><span class="nf">set_plot_theme</span><span class="p">(</span><span class="s s-Atom">&#39;document&#39;</span><span class="p">)</span>

            <span class="s s-Atom">p</span> <span class="o">=</span> <span class="s s-Atom">pv</span><span class="p">.</span><span class="nv">Plotter</span><span class="p">()</span>

            <span class="s s-Atom">p</span><span class="p">.</span><span class="nf">add_mesh</span><span class="p">(</span><span class="s s-Atom">contours</span><span class="p">,</span> <span class="s s-Atom">scalars</span><span class="o">=</span><span class="s s-Atom">fescolors</span><span class="p">,</span> <span class="s s-Atom">opacity</span><span class="o">=</span><span class="s s-Atom">opacity</span><span class="p">,</span>

                       <span class="s s-Atom">cmap</span><span class="o">=</span><span class="s s-Atom">cmap</span><span class="p">,</span> <span class="s s-Atom">show_scalar_bar</span><span class="o">=</span><span class="nv">False</span><span class="p">,</span> <span class="s s-Atom">interpolate_before_map</span><span class="o">=</span><span class="nv">True</span><span class="p">)</span>

            <span class="s s-Atom">p</span><span class="p">.</span><span class="nf">show_grid</span><span class="p">(</span><span class="s s-Atom">xlabel</span><span class="o">=</span><span class="s s-Atom">xlabel</span><span class="p">,</span> <span class="s s-Atom">ylabel</span><span class="o">=</span><span class="s s-Atom">ylabel</span><span class="p">,</span> <span class="s s-Atom">zlabel</span><span class="o">=</span><span class="s s-Atom">zlabel</span><span class="p">)</span>

            <span class="s s-Atom">p</span><span class="p">.</span><span class="nf">show</span><span class="p">()</span>

        <span class="s s-Atom">else</span><span class="p">:</span>

            <span class="s s-Atom">raise</span> <span class="nv">ValueError</span><span class="p">(</span><span class="s2">&quot;Only 1D, 2D and 3D FES are supported.&quot;</span><span class="p">)</span>

        <span class="s s-Atom">if</span> <span class="s s-Atom">png_name</span> <span class="p">!</span><span class="o">=</span> <span class="nv">None</span><span class="o">:</span>

            <span class="s s-Atom">plt</span><span class="p">.</span><span class="nf">savefig</span><span class="p">(</span><span class="s s-Atom">png_name</span><span class="p">)</span>

    <span class="s s-Atom">def</span> <span class="nf">set_fes</span><span class="p">(</span><span class="s s-Atom">self</span><span class="p">,</span> <span class="s s-Atom">fes</span><span class="p">)</span><span class="o">:</span>

        <span class="s s-Atom">self</span><span class="p">.</span><span class="s s-Atom">fes</span> <span class="o">=</span> <span class="s s-Atom">fes</span>

    <span class="s s-Atom">def</span> <span class="nf">surface_plot</span><span class="p">(</span>

        <span class="s s-Atom">self</span><span class="p">,</span>

        <span class="s s-Atom">cv_select</span><span class="o">:</span> <span class="nv">Optional</span><span class="p">[</span><span class="nv">None</span><span class="p">]</span> <span class="o">=</span> <span class="nv">None</span><span class="p">,</span>

        <span class="s s-Atom">cv_range</span><span class="o">:</span> <span class="nv">Optional</span><span class="p">[</span><span class="nv">None</span><span class="p">]</span> <span class="o">=</span> <span class="nv">None</span><span class="p">,</span>

        <span class="s s-Atom">cmap</span><span class="p">:</span> <span class="s s-Atom">str</span> <span class="o">=</span> <span class="s2">&quot;jet&quot;</span><span class="p">,</span>

        <span class="s s-Atom">energy_unit</span><span class="o">:</span> <span class="s s-Atom">str</span> <span class="o">=</span> <span class="s2">&quot;kJ/mol&quot;</span><span class="p">,</span>

        <span class="s s-Atom">xlabel</span><span class="p">:</span> <span class="nv">Optional</span><span class="p">[</span><span class="s s-Atom">str</span><span class="p">]</span> <span class="o">=</span> <span class="nv">None</span><span class="p">,</span>

        <span class="s s-Atom">ylabel</span><span class="p">:</span> <span class="nv">Optional</span><span class="p">[</span><span class="s s-Atom">str</span><span class="p">]</span> <span class="o">=</span> <span class="nv">None</span><span class="p">,</span>

        <span class="s s-Atom">zlabel</span><span class="p">:</span> <span class="nv">Optional</span><span class="p">[</span><span class="s s-Atom">str</span><span class="p">]</span> <span class="o">=</span> <span class="nv">None</span><span class="p">,</span>

        <span class="s s-Atom">label_size</span><span class="o">:</span> <span class="s s-Atom">int</span> <span class="o">=</span> <span class="mi">12</span><span class="p">,</span>

        <span class="s s-Atom">image_size</span><span class="o">:</span> <span class="nv">List</span><span class="p">[</span><span class="s s-Atom">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">12</span><span class="p">,</span> <span class="mi">7</span><span class="p">],</span>

        <span class="s s-Atom">rstride</span><span class="p">:</span> <span class="s s-Atom">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>

        <span class="s s-Atom">cstride</span><span class="p">:</span> <span class="s s-Atom">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>

        <span class="s s-Atom">vmin</span><span class="p">:</span> <span class="s s-Atom">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>

        <span class="s s-Atom">vmax</span><span class="p">:</span> <span class="nv">Optional</span><span class="p">[</span><span class="s s-Atom">int</span><span class="p">]</span> <span class="o">=</span> <span class="nv">None</span><span class="p">,</span>

    <span class="p">)</span><span class="o">:</span>

        <span class="s2">&quot;&quot;&quot;</span>

<span class="s2">        Visualizes the 2D free energy surface (FES) as a 3D surface plot using Matplotlib.</span>

<span class="s2">        Note: Interactivity is currently limited to jupyter notebook or jupyter lab in `%matplotlib widget` mode. Otherwise, it is a static image of the 3D surface plot.</span>

<span class="s2">        Usage:</span>

<span class="s2">        ```python</span>

<span class="s2">        %matplotlib widget</span>

<span class="s2">        fes.surface_plot()</span>

<span class="s2">        ```</span>

<span class="s2">        Future plans include implementing this function using PyVista. However, in the current version of PyVista (0.38.5), there is an issue with labels on the 3rd axis for free energy showing wrong values.</span>

<span class="s2">        &quot;&quot;&quot;</span>

        <span class="s s-Atom">import</span> <span class="s s-Atom">matplotlib</span><span class="p">.</span><span class="s s-Atom">pyplot</span> <span class="s s-Atom">as</span> <span class="s s-Atom">plt</span>

        <span class="s s-Atom">if</span> <span class="s s-Atom">cv_select</span> <span class="o">is</span> <span class="nv">None</span><span class="o">:</span>

            <span class="s s-Atom">cv_select</span> <span class="o">=</span> <span class="nf">list</span><span class="p">(</span><span class="nf">range</span><span class="p">(</span><span class="s s-Atom">self</span><span class="p">.</span><span class="s s-Atom">cvs</span><span class="p">))</span>

        <span class="s s-Atom">if</span> <span class="s s-Atom">self</span><span class="p">.</span><span class="s s-Atom">cvs</span> <span class="o">==</span> <span class="mi">2</span><span class="o">:</span>

            <span class="s s-Atom">cv1_index</span> <span class="o">=</span> <span class="s s-Atom">self</span><span class="p">.</span><span class="s s-Atom">cv_select</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

            <span class="s s-Atom">cv2_index</span> <span class="o">=</span> <span class="s s-Atom">self</span><span class="p">.</span><span class="s s-Atom">cv_select</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

            <span class="s s-Atom">cv1min</span> <span class="o">=</span> <span class="s s-Atom">self</span><span class="p">.</span><span class="s s-Atom">cv_min</span><span class="p">[</span><span class="s s-Atom">self</span><span class="p">.</span><span class="s s-Atom">cv_select</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>

            <span class="s s-Atom">cv1max</span> <span class="o">=</span> <span class="s s-Atom">self</span><span class="p">.</span><span class="s s-Atom">cv_max</span><span class="p">[</span><span class="s s-Atom">self</span><span class="p">.</span><span class="s s-Atom">cv_select</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>

            <span class="s s-Atom">cv2min</span> <span class="o">=</span> <span class="s s-Atom">self</span><span class="p">.</span><span class="s s-Atom">cv_min</span><span class="p">[</span><span class="s s-Atom">self</span><span class="p">.</span><span class="s s-Atom">cv_select</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>

            <span class="s s-Atom">cv2max</span> <span class="o">=</span> <span class="s s-Atom">self</span><span class="p">.</span><span class="s s-Atom">cv_max</span><span class="p">[</span><span class="s s-Atom">self</span><span class="p">.</span><span class="s s-Atom">cv_select</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>

            <span class="s s-Atom">x</span> <span class="o">=</span> <span class="s s-Atom">np</span><span class="p">.</span><span class="nf">linspace</span><span class="p">(</span><span class="s s-Atom">cv1min</span><span class="p">,</span> <span class="s s-Atom">cv1max</span><span class="p">,</span> <span class="s s-Atom">self</span><span class="p">.</span><span class="s s-Atom">res</span><span class="p">)</span>

            <span class="s s-Atom">y</span> <span class="o">=</span> <span class="s s-Atom">np</span><span class="p">.</span><span class="nf">linspace</span><span class="p">(</span><span class="s s-Atom">cv2min</span><span class="p">,</span> <span class="s s-Atom">cv2max</span><span class="p">,</span> <span class="s s-Atom">self</span><span class="p">.</span><span class="s s-Atom">res</span><span class="p">)</span>

            <span class="nv">X</span><span class="p">,</span> <span class="nv">Y</span> <span class="o">=</span> <span class="s s-Atom">np</span><span class="p">.</span><span class="nf">meshgrid</span><span class="p">(</span><span class="s s-Atom">x</span><span class="p">,</span> <span class="s s-Atom">y</span><span class="p">)</span>

            <span class="nv">Z</span> <span class="o">=</span> <span class="s s-Atom">self</span><span class="p">.</span><span class="s s-Atom">fes</span>

            <span class="s s-Atom">#grid</span> <span class="o">=</span> <span class="s s-Atom">pv</span><span class="p">.</span><span class="nv">StructuredGrid</span><span class="p">(</span><span class="nv">X</span><span class="p">,</span> <span class="nv">Y</span><span class="p">,</span> <span class="nv">Z</span><span class="p">)</span>

            <span class="s s-Atom">#</span> <span class="s s-Atom">grid</span><span class="p">.</span><span class="nf">plot</span><span class="p">()</span>

            <span class="s s-Atom">fig</span><span class="p">,</span> <span class="s s-Atom">ax</span> <span class="o">=</span> <span class="s s-Atom">plt</span><span class="p">.</span><span class="nf">subplots</span><span class="p">(</span><span class="s s-Atom">subplot_kw=</span><span class="p">{</span><span class="s2">&quot;projection&quot;</span><span class="o">:</span> <span class="s2">&quot;3d&quot;</span><span class="p">})</span>

            <span class="s s-Atom">ax</span><span class="p">.</span><span class="nf">plot_surface</span><span class="p">(</span><span class="nv">X</span><span class="p">,</span> <span class="nv">Y</span><span class="p">,</span> <span class="nv">Z</span><span class="p">,</span> <span class="s s-Atom">cmap</span><span class="o">=</span><span class="s s-Atom">cmap</span><span class="p">,</span>  <span class="s s-Atom">#</span> <span class="s s-Atom">type</span><span class="p">:</span> <span class="s s-Atom">ignore</span>

                            <span class="s s-Atom">rstride</span><span class="o">=</span><span class="s s-Atom">rstride</span><span class="p">,</span> <span class="s s-Atom">cstride</span><span class="o">=</span><span class="s s-Atom">cstride</span><span class="p">)</span>

            <span class="s s-Atom">if</span> <span class="s s-Atom">xlabel</span> <span class="o">==</span> <span class="nv">None</span><span class="o">:</span>

                <span class="s s-Atom">ax</span><span class="p">.</span><span class="nf">set_xlabel</span><span class="p">(</span>

                    <span class="s s-Atom">f&#39;CV1 - {self.hills.cv_name[cv1_index]}&#39;</span><span class="p">,</span> <span class="s s-Atom">size</span><span class="o">=</span><span class="s s-Atom">label_size</span><span class="p">)</span>

            <span class="s s-Atom">else</span><span class="p">:</span>

                <span class="s s-Atom">ax</span><span class="p">.</span><span class="nf">set_xlabel</span><span class="p">(</span><span class="s s-Atom">xlabel</span><span class="p">,</span> <span class="s s-Atom">size</span><span class="o">=</span><span class="s s-Atom">label_size</span><span class="p">)</span>

            <span class="s s-Atom">if</span> <span class="s s-Atom">ylabel</span> <span class="o">==</span> <span class="nv">None</span><span class="o">:</span>

                <span class="s s-Atom">ax</span><span class="p">.</span><span class="nf">set_ylabel</span><span class="p">(</span>

                    <span class="s s-Atom">f&#39;CV2 - {self.hills.cv_name[cv2_index]}&#39;</span><span class="p">,</span> <span class="s s-Atom">size</span><span class="o">=</span><span class="s s-Atom">label_size</span><span class="p">)</span>

            <span class="s s-Atom">else</span><span class="p">:</span>

                <span class="s s-Atom">ax</span><span class="p">.</span><span class="nf">set_ylabel</span><span class="p">(</span><span class="s s-Atom">ylabel</span><span class="p">,</span> <span class="s s-Atom">size</span><span class="o">=</span><span class="s s-Atom">label_size</span><span class="p">)</span>

            <span class="s s-Atom">if</span> <span class="s s-Atom">zlabel</span> <span class="o">==</span> <span class="nv">None</span><span class="o">:</span>

                <span class="s s-Atom">#</span> <span class="s s-Atom">type</span><span class="p">:</span> <span class="s s-Atom">ignore</span>

                <span class="s s-Atom">ax</span><span class="p">.</span><span class="nf">set_zlabel</span><span class="p">(</span><span class="s s-Atom">f&#39;free energy ({energy_unit})&#39;</span><span class="p">,</span> <span class="s s-Atom">size</span><span class="o">=</span><span class="s s-Atom">label_size</span><span class="p">)</span>

            <span class="s s-Atom">else</span><span class="p">:</span>

                <span class="s s-Atom">ax</span><span class="p">.</span><span class="nf">set_zlabel</span><span class="p">(</span><span class="s s-Atom">zlabel</span><span class="p">,</span> <span class="s s-Atom">size</span><span class="o">=</span><span class="s s-Atom">label_size</span><span class="p">)</span>  <span class="s s-Atom">#</span> <span class="s s-Atom">type</span><span class="p">:</span> <span class="s s-Atom">ignore</span>

        <span class="s s-Atom">else</span><span class="p">:</span>

            <span class="s s-Atom">raise</span> <span class="nv">ValueError</span><span class="p">(</span>

                <span class="s s-Atom">f</span><span class="s2">&quot;Surface plot only works for FES with exactly two CVs, and this FES has {self.hills.cvs}&quot;</span>

            <span class="p">)</span>

    <span class="s s-Atom">def</span> <span class="nf">removeCV</span><span class="p">(</span>

        <span class="s s-Atom">self</span><span class="p">,</span>

        <span class="nv">CV</span><span class="o">:</span> <span class="s s-Atom">int</span><span class="p">,</span>

        <span class="s s-Atom">kb</span><span class="p">:</span> <span class="nv">Optional</span><span class="p">[</span><span class="s s-Atom">float</span><span class="p">]</span> <span class="o">=</span> <span class="nv">None</span><span class="p">,</span>

        <span class="s s-Atom">energy_unit</span><span class="o">:</span> <span class="s s-Atom">str</span> <span class="o">=</span> <span class="s2">&quot;kJ/mol&quot;</span><span class="p">,</span>

        <span class="s s-Atom">temp</span><span class="p">:</span> <span class="s s-Atom">float</span> <span class="o">=</span> <span class="mf">300.0</span>

    <span class="p">)</span><span class="o">:</span>

        <span class="s2">&quot;&quot;&quot;Remove a CV from an existing FES.</span>

<span class="s2">        The function first recalculates the FES to an array of probabilities.</span>

<span class="s2">        The probabilities are summed along the CV to be removed,</span>

<span class="s2">        and resulting probability distribution with 1 less dimension</span>

<span class="s2">        is converted back to FES.</span>

<span class="s2">        Interactivity was working in jupyter notebook/lab with &quot;</span><span class="c1">%matplotlib widget&quot;.</span>

        <span class="nv">Args</span><span class="o">:</span>

            <span class="nv">CV</span> <span class="p">(</span><span class="s s-Atom">int</span><span class="p">)</span><span class="o">:</span> <span class="s s-Atom">the</span> <span class="s s-Atom">index</span> <span class="s s-Atom">of</span> <span class="nv">CV</span> <span class="s s-Atom">to</span> <span class="s s-Atom">be</span> <span class="s s-Atom">removed</span><span class="p">.</span>

            <span class="nf">energy_unit</span> <span class="p">(</span><span class="s s-Atom">str</span><span class="p">)</span><span class="o">:</span> <span class="s s-Atom">has</span> <span class="s s-Atom">to</span> <span class="s s-Atom">be</span> <span class="s s-Atom">either</span> <span class="s2">&quot;kJ/mol&quot;</span> <span class="s s-Atom">or</span> <span class="s2">&quot;kcal/mol&quot;</span><span class="p">.</span> <span class="nv">Defaults</span> <span class="s s-Atom">to</span> <span class="s s-Atom">be</span> <span class="s2">&quot;kJ/mol&quot;</span><span class="p">.</span>

            <span class="nf">kb</span> <span class="p">(</span><span class="s s-Atom">float</span><span class="p">,</span> <span class="s s-Atom">optional</span><span class="p">)</span><span class="o">:</span> <span class="s s-Atom">the</span> <span class="nv">Boltzmann</span> <span class="nv">Constant</span> <span class="s s-Atom">in</span> <span class="s s-Atom">the</span> <span class="s s-Atom">energy</span> <span class="s s-Atom">unit</span><span class="p">.</span> <span class="s s-Atom">\</span>

                <span class="nv">Defaults</span> <span class="s s-Atom">to</span> <span class="s s-Atom">be</span> <span class="nv">None</span><span class="p">,</span> <span class="s s-Atom">which</span> <span class="s s-Atom">will</span> <span class="s s-Atom">be</span> <span class="s s-Atom">set</span> <span class="s s-Atom">according</span> <span class="s s-Atom">to</span> <span class="s s-Atom">energy_unit</span><span class="p">.</span>

            <span class="nf">temp</span> <span class="p">(</span><span class="s s-Atom">float</span><span class="p">)</span> <span class="o">=</span> <span class="s s-Atom">temperature</span> <span class="s s-Atom">of</span> <span class="s s-Atom">the</span> <span class="s s-Atom">simulation</span> <span class="s s-Atom">in</span> <span class="nv">Kelvins</span><span class="p">.</span>

        <span class="nv">Return</span><span class="o">:</span>

            <span class="nv">New</span> <span class="err">`</span><span class="nv">Fes</span><span class="err">`</span> <span class="s s-Atom">instance</span> <span class="s s-Atom">without</span> <span class="s s-Atom">the</span> <span class="nv">CV</span> <span class="s s-Atom">to</span> <span class="s s-Atom">be</span> <span class="s s-Atom">removed</span><span class="p">.</span>

        <span class="s2">&quot;&quot;&quot;</span>

<span class="s2">        print(f&quot;</span><span class="nv">Removing</span> <span class="nv">CV</span> <span class="p">{</span><span class="nv">CV</span><span class="p">}.</span><span class="s2">&quot;)</span>

<span class="s2">        if self.fes is None:</span>

<span class="s2">            raise ValueError(</span>

<span class="s2">                &quot;</span><span class="nv">FES</span> <span class="o">not</span> <span class="s s-Atom">calculated</span> <span class="s s-Atom">yet</span><span class="p">.</span> <span class="nv">Use</span> <span class="nf">makefes</span><span class="p">()</span> <span class="s s-Atom">or</span> <span class="nf">makefes2</span><span class="p">()</span> <span class="s s-Atom">first</span><span class="p">.</span><span class="s2">&quot;)</span>

<span class="s2">        if CV &gt; self.hills.cvs:</span>

<span class="s2">            print(&quot;</span><span class="nv">Error</span><span class="o">:</span> <span class="nv">The</span> <span class="nv">CV</span> <span class="s s-Atom">to</span> <span class="s s-Atom">remove</span> <span class="o">is</span> <span class="o">not</span> <span class="s s-Atom">available</span> <span class="s s-Atom">in</span> <span class="s s-Atom">this</span> <span class="nv">FES</span> <span class="s s-Atom">object</span><span class="p">.</span><span class="s2">&quot;)</span>

<span class="s2">            return None</span>

<span class="s2">        if kb == None:</span>

<span class="s2">            if energy_unit == &quot;</span><span class="s s-Atom">kJ</span><span class="o">/</span><span class="s s-Atom">mol</span><span class="s2">&quot;:</span>

<span class="s2">                kb = 8.314e-3</span>

<span class="s2">            elif energy_unit == &quot;</span><span class="s s-Atom">kcal</span><span class="o">/</span><span class="s s-Atom">mol</span><span class="s2">&quot;:</span>

<span class="s2">                kb = 8.314e-3 / 4.184</span>

<span class="s2">            else:</span>

<span class="s2">                raise ValueError(</span>

<span class="s2">                    &quot;</span><span class="nv">Please</span> <span class="s s-Atom">give</span> <span class="s s-Atom">the</span> <span class="nv">Boltzmann</span> <span class="nv">Constant</span> <span class="s s-Atom">in</span> <span class="s s-Atom">the</span> <span class="s s-Atom">energy</span> <span class="s s-Atom">unit</span><span class="p">.</span><span class="s2">&quot;)</span>

<span class="s2">        if self.cvs == 1:</span>

<span class="s2">            print(&quot;</span><span class="nv">Error</span><span class="o">:</span> <span class="nv">You</span> <span class="s s-Atom">can</span> <span class="o">not</span> <span class="s s-Atom">remove</span> <span class="s s-Atom">the</span> <span class="s s-Atom">only</span> <span class="nv">CV</span><span class="p">.</span> <span class="s2">&quot;)</span>

<span class="s2">            return None</span>

<span class="s2">        else:</span>

<span class="s2">            probabilities = np.exp(-self.fes / (kb * temp))</span>

<span class="s2">            new_prob = np.sum(probabilities, axis=CV)</span>

<span class="s2">            new_fes = Fes(hills=self.hills, calculate_new_fes=False)</span>

<span class="s2">            new_fes.fes = - kb * temp * np.log(new_prob)</span>

<span class="s2">            new_fes.fes = new_fes.fes - np.min(new_fes.fes)</span>

<span class="s2">            new_fes.res = self.res</span>

<span class="s2">            mask = np.ones(len(self.cv_select), dtype=bool)</span>

<span class="s2">            mask[CV] = False</span>

<span class="s2">            new_fes.cv_select = self.cv_select[mask]</span>

<span class="s2">            new_fes.cv_min = self.cv_min[mask]</span>

<span class="s2">            new_fes.cv_max = self.cv_max[mask]</span>

<span class="s2">            new_fes.cv_fes_range = self.cv_fes_range[mask]</span>

<span class="s2">            return new_fes</span>

<span class="s2">    def make_gif(</span>

<span class="s2">        self,</span>

<span class="s2">        gif_name: str = &quot;</span><span class="nv">FES</span><span class="p">.</span><span class="s s-Atom">gif</span><span class="s2">&quot;,</span>

<span class="s2">        cmap: str = &quot;</span><span class="s s-Atom">jet</span><span class="s2">&quot;,</span>

<span class="s2">        xlabel: Optional[str] = None,</span>

<span class="s2">        ylabel: Optional[str] = None,</span>

<span class="s2">        zlabel: Optional[str] = None,</span>

<span class="s2">        label_size: int = 12,</span>

<span class="s2">        image_size: List[int] = [10, 7],</span>

<span class="s2">        opacity: float = 0.2,</span>

<span class="s2">        levels: Optional[List[float]] = None,</span>

<span class="s2">        frames: int = 64,</span>

<span class="s2">    ):</span>

<span class="s2">        &quot;&quot;&quot;</span>

        <span class="nv">Generates</span> <span class="s s-Atom">an</span> <span class="s s-Atom">animation</span> <span class="s s-Atom">of</span> <span class="s s-Atom">the</span> <span class="mi">3</span><span class="nv">D</span> <span class="s s-Atom">free</span> <span class="s s-Atom">energy</span> <span class="nf">surface</span> <span class="p">(</span><span class="nv">FES</span><span class="p">)</span> <span class="s s-Atom">showing</span> <span class="s s-Atom">different</span> <span class="s s-Atom">isosurfaces</span><span class="p">.</span>

        <span class="nv">Usage</span><span class="o">:</span>

        <span class="err">```</span><span class="s s-Atom">python</span>

        <span class="s s-Atom">fes</span><span class="p">.</span><span class="nf">make_gif</span><span class="p">()</span>

        <span class="err">```</span>

        <span class="nv">Args</span><span class="o">:</span>

            <span class="nf">gif_name</span> <span class="p">(</span><span class="s s-Atom">str</span><span class="p">,</span> <span class="s s-Atom">default=</span><span class="s2">&quot;FES.gif&quot;</span><span class="p">)</span><span class="o">:</span> <span class="s s-Atom">\</span>

                <span class="nv">The</span> <span class="s s-Atom">name</span> <span class="s s-Atom">of</span> <span class="s s-Atom">the</span> <span class="s s-Atom">gif</span> <span class="s s-Atom">file</span> <span class="s s-Atom">of</span> <span class="s s-Atom">the</span> <span class="nv">FES</span> <span class="s s-Atom">that</span> <span class="s s-Atom">will</span> <span class="s s-Atom">be</span> <span class="s s-Atom">saved</span> <span class="s s-Atom">in</span> <span class="s s-Atom">the</span> <span class="s s-Atom">current</span> <span class="s s-Atom">working</span> <span class="s s-Atom">directory</span><span class="p">.</span>

            <span class="nf">cmap</span> <span class="p">(</span><span class="s s-Atom">str</span><span class="p">,</span> <span class="s s-Atom">default=</span><span class="s2">&quot;jet&quot;</span><span class="p">)</span><span class="o">:</span> <span class="s s-Atom">\</span>

                <span class="nv">The</span> <span class="nv">Matplotlib</span> <span class="s s-Atom">colormap</span> <span class="s s-Atom">used</span> <span class="s s-Atom">to</span> <span class="s s-Atom">color</span> <span class="s s-Atom">the</span> <span class="mi">3</span><span class="nv">D</span> <span class="nv">FES</span><span class="p">.</span>

            <span class="s s-Atom">xlabel</span><span class="p">,</span> <span class="s s-Atom">ylabel</span><span class="p">,</span> <span class="nf">zlabel</span> <span class="p">(</span><span class="s s-Atom">str</span><span class="p">,</span> <span class="s s-Atom">optional</span><span class="p">)</span><span class="o">:</span> <span class="s s-Atom">\</span>

                <span class="nv">If</span> <span class="s s-Atom">provided</span><span class="p">,</span> <span class="s s-Atom">they</span> <span class="s s-Atom">will</span> <span class="s s-Atom">be</span> <span class="s s-Atom">used</span> <span class="s s-Atom">as</span> <span class="s s-Atom">labels</span> <span class="s s-Atom">for</span> <span class="s s-Atom">the</span> <span class="s s-Atom">graph</span><span class="p">.</span>

            <span class="nf">label_size</span> <span class="p">(</span><span class="s s-Atom">int</span><span class="p">,</span> <span class="s s-Atom">default</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span><span class="o">:</span> <span class="s s-Atom">\</span>

                <span class="nv">The</span> <span class="s s-Atom">size</span> <span class="s s-Atom">of</span> <span class="s s-Atom">text</span> <span class="s s-Atom">in</span> <span class="s s-Atom">the</span> <span class="s s-Atom">labels</span><span class="p">.</span>

            <span class="nf">image_size</span> <span class="p">(</span><span class="nv">List</span><span class="p">[</span><span class="s s-Atom">int</span><span class="p">],</span> <span class="s s-Atom">default</span><span class="o">=</span><span class="p">[</span><span class="mi">10</span><span class="p">,</span><span class="mi">7</span><span class="p">])</span><span class="o">:</span> <span class="s s-Atom">\</span>

                <span class="nv">The</span> <span class="s s-Atom">width</span> <span class="s s-Atom">and</span> <span class="s s-Atom">height</span> <span class="s s-Atom">of</span> <span class="s s-Atom">the</span> <span class="s s-Atom">picture</span><span class="p">.</span>

            <span class="nf">opacity</span> <span class="p">(</span><span class="s s-Atom">float</span><span class="p">,</span> <span class="s s-Atom">default</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span><span class="o">:</span> <span class="s s-Atom">\</span>

                <span class="nv">A</span> <span class="s s-Atom">number</span> <span class="s s-Atom">between</span> <span class="mi">0</span> <span class="s s-Atom">and</span> <span class="mi">1</span> <span class="s s-Atom">representing</span> <span class="s s-Atom">the</span> <span class="s s-Atom">opacity</span> <span class="s s-Atom">of</span> <span class="s s-Atom">isosurfaces</span> <span class="s s-Atom">in</span> <span class="s s-Atom">the</span> <span class="mi">3</span><span class="nv">D</span> <span class="nv">FES</span><span class="p">.</span>

            <span class="nf">levels</span> <span class="p">(</span><span class="nv">List</span><span class="p">[</span><span class="s s-Atom">float</span><span class="p">],</span> <span class="s s-Atom">optional</span><span class="p">)</span><span class="o">:</span> <span class="s s-Atom">\</span>

                <span class="nv">A</span> <span class="s s-Atom">list</span> <span class="s s-Atom">of</span> <span class="s s-Atom">free</span> <span class="s s-Atom">energy</span> <span class="nb">val</span><span class="s s-Atom">ues</span> <span class="s s-Atom">for</span> <span class="s s-Atom">isosurfaces</span> <span class="s s-Atom">in</span> <span class="s s-Atom">the</span> <span class="mi">3</span><span class="nv">D</span> <span class="nv">FES</span><span class="p">.</span> <span class="nv">If</span> <span class="o">not</span> <span class="s s-Atom">provided</span><span class="p">,</span> <span class="s s-Atom">default</span> <span class="nb">val</span><span class="s s-Atom">ues</span> <span class="s s-Atom">from</span> <span class="s s-Atom">the</span> <span class="s s-Atom">contours</span> <span class="s s-Atom">parameters</span> <span class="s s-Atom">will</span> <span class="s s-Atom">be</span> <span class="s s-Atom">used</span> <span class="s s-Atom">instead</span><span class="p">.</span>

            <span class="nf">frames</span> <span class="p">(</span><span class="s s-Atom">int</span><span class="p">,</span> <span class="s s-Atom">default</span><span class="o">=</span><span class="mi">64</span><span class="p">)</span><span class="o">:</span> <span class="s s-Atom">\</span>

                <span class="nv">The</span> <span class="s s-Atom">number</span> <span class="s s-Atom">of</span> <span class="s s-Atom">frames</span> <span class="s s-Atom">the</span> <span class="s s-Atom">animation</span> <span class="s s-Atom">will</span> <span class="s s-Atom">be</span> <span class="s s-Atom">composed</span> <span class="s s-Atom">of</span><span class="p">.</span>

        <span class="s2">&quot;&quot;&quot;</span>

<span class="s2">        try:</span>

<span class="s2">            import pyvista as pv</span>

<span class="s2">        except (ImportError, ModuleNotFoundError) as e:</span>

<span class="s2">            print(e)</span>

<span class="s2">            sys.exit(1)</span>

<span class="s2">        if self.fes is None:</span>

<span class="s2">            raise ValueError(</span>

<span class="s2">                &quot;</span><span class="nv">FES</span> <span class="o">not</span> <span class="s s-Atom">calculated</span> <span class="s s-Atom">yet</span><span class="p">.</span> <span class="nv">Use</span> <span class="nf">makefes</span><span class="p">()</span> <span class="s s-Atom">or</span> <span class="nf">makefes2</span><span class="p">()</span> <span class="s s-Atom">first</span><span class="p">.</span><span class="s2">&quot;)</span>

<span class="s2">        if self.cvs == 3:</span>

<span class="s2">            cv1_index = self.cv_select[0]</span>

<span class="s2">            cv2_index = self.cv_select[1]</span>

<span class="s2">            cv3_index = self.cv_select[2]</span>

<span class="s2">            cv1min = self.cv_min[self.cv_select[0]]</span>

<span class="s2">            cv1max = self.cv_max[self.cv_select[0]]</span>

<span class="s2">            cv2min = self.cv_min[self.cv_select[1]]</span>

<span class="s2">            cv2max = self.cv_max[self.cv_select[1]]</span>

<span class="s2">            cv3min = self.cv_min[self.cv_select[2]]</span>

<span class="s2">            cv3max = self.cv_max[self.cv_select[2]]</span>

<span class="s2">            values = np.linspace(np.min(self.fes)+0.01,</span>

<span class="s2">                                 np.max(self.fes), num=frames)</span>

<span class="s2">            grid = pv.UniformGrid(</span>

<span class="s2">                dimensions=(self.res, self.res, self.res),</span>

<span class="s2">                spacing=((cv1max-cv1min)/self.res, (cv2max-cv2min) /</span>

<span class="s2">                         self.res, (cv3max-cv3min)/self.res),</span>

<span class="s2">                origin=(cv1min, cv2min, cv3min),</span>

<span class="s2">            )</span>

<span class="s2">            grid[&quot;</span><span class="s s-Atom">vol</span><span class="s2">&quot;] = np.ravel(self.fes, order=&quot;</span><span class="nv">F</span><span class="s2">&quot;)</span>

<span class="s2">            surface = grid.contour(values[:1])</span>

<span class="s2">            surfaces = [grid.contour([v]) for v in values]</span>

<span class="s2">            surface = surfaces[0].copy()</span>

<span class="s2">            pv.set_plot_theme(&#39;document&#39;)</span>

<span class="s2">            plotter = pv.Plotter(off_screen=True)</span>

<span class="s2">            # Open a movie file</span>

<span class="s2">            plotter.open_gif(gif_name)</span>

<span class="s2">            # Add initial mesh</span>

<span class="s2">            plotter.add_mesh(</span>

<span class="s2">                surface,</span>

<span class="s2">                opacity=0.3,</span>

<span class="s2">                clim=grid.get_data_range(),</span>

<span class="s2">                show_scalar_bar=False,</span>

<span class="s2">                cmap=&quot;</span><span class="s s-Atom">jet</span><span class="s2">&quot;</span>

<span class="s2">            )</span>

<span class="s2">            plotter.add_mesh(grid.outline_corners(), color=&quot;</span><span class="s s-Atom">k</span><span class="s2">&quot;)</span>

<span class="s2">            if xlabel == None and ylabel == None and zlabel == None:</span>

<span class="s2">                plotter.show_grid(</span>

<span class="s2">                    xlabel=f&quot;</span><span class="nv">CV1</span> <span class="o">-</span> <span class="p">{</span><span class="s s-Atom">self</span><span class="p">.</span><span class="s s-Atom">hills</span><span class="p">.</span><span class="s s-Atom">cv_name</span><span class="p">[</span><span class="s s-Atom">cv1_index</span><span class="p">]}</span><span class="s2">&quot;,</span>

<span class="s2">                    ylabel=f&quot;</span><span class="nv">CV2</span> <span class="o">-</span> <span class="p">{</span><span class="s s-Atom">self</span><span class="p">.</span><span class="s s-Atom">hills</span><span class="p">.</span><span class="s s-Atom">cv_name</span><span class="p">[</span><span class="s s-Atom">cv2_index</span><span class="p">]}</span><span class="s2">&quot;,</span>

<span class="s2">                    zlabel=f&quot;</span><span class="nv">CV3</span> <span class="o">-</span> <span class="p">{</span><span class="s s-Atom">self</span><span class="p">.</span><span class="s s-Atom">hills</span><span class="p">.</span><span class="s s-Atom">cv_name</span><span class="p">[</span><span class="s s-Atom">cv3_index</span><span class="p">]}</span><span class="s2">&quot;)</span>

<span class="s2">            else:</span>

<span class="s2">                plotter.show_grid(xlabel=xlabel, ylabel=ylabel, zlabel=zlabel)</span>

<span class="s2">            plotter.set_background(&#39;white&#39;)</span>

<span class="s2">            plotter.show(auto_close=False)</span>

<span class="s2">            # Run through each frame</span>

<span class="s2">            for surf in surfaces:</span>

<span class="s2">                surface.copy_from(surf)</span>

<span class="s2">                plotter.write_frame()  # Write this frame</span>

<span class="s2">            # Run through backwards</span>

<span class="s2">            for surf in surfaces[::-1]:</span>

<span class="s2">                surface.copy_from(surf)</span>

<span class="s2">                plotter.write_frame()  # Write this frame</span>

<span class="s2">            # Be sure to close the plotter when finished</span>

<span class="s2">            plotter.close()</span>

<span class="s2">        else:</span>

<span class="s2">            raise ValueError(</span>

<span class="s2">                &quot;</span><span class="nv">Error</span><span class="o">:</span> <span class="s s-Atom">gif_plot</span> <span class="o">is</span> <span class="s s-Atom">only</span> <span class="s s-Atom">available</span> <span class="s s-Atom">for</span> <span class="nv">FES</span> <span class="s s-Atom">with</span> <span class="mi">3</span> <span class="nv">CVs</span><span class="p">.</span><span class="err">&quot;</span><span class="p">)</span>
</code></pre></div>

</details>
<hr />
<h4 id="methods">Methods</h4>
<h4 id="generate_cv_map">generate_cv_map</h4>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">generate_cv_map</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">cv_select</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">cv_range</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
<span class="p">)</span>
</code></pre></div>

<p>generate CV map</p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td>cv_select</td>
<td>List[int]</td>
<td>A list of integers specifying which collective variables (CVs) should be used for FES calculation.                 Defaults to None.</td>
<td>None</td>
</tr>
<tr>
<td>cv_range</td>
<td>Optional[List[float]]</td>
<td>A list of two numbers defining the lower and upper bounds of the CVs (in the units of the CV).                 Defaults to None.</td>
<td>None</td>
</tr>
</tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>Tuple</td>
<td>cv_min, cv_max, cv_fes_range</td>
</tr>
</tbody>
</table>
<details class="example">
<summary>View Source</summary>
<div class="codehilite"><pre><span></span><code><span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">generate_cv_map</span><span class="p">(</span>

<span class="w">        </span><span class="n">self</span><span class="p">,</span>

<span class="w">        </span><span class="nl">cv_select</span><span class="p">:</span><span class="w"> </span><span class="n">Optional</span><span class="o">[</span><span class="n">List[int</span><span class="o">]</span><span class="err">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">None</span><span class="p">,</span>

<span class="w">        </span><span class="nl">cv_range</span><span class="p">:</span><span class="w"> </span><span class="n">Optional</span><span class="o">[</span><span class="n">List[float</span><span class="o">]</span><span class="err">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">None</span>

<span class="w">    </span><span class="p">)</span><span class="err">:</span>

<span class="w">        </span><span class="ss">&quot;&quot;&quot;generate CV map</span>

<span class="ss">        Args:</span>

<span class="ss">            cv_select (List[int], optional): \</span>

<span class="ss">                A list of integers specifying which collective variables (CVs) should be used for FES calculation. \</span>

<span class="ss">                Defaults to None.</span>

<span class="ss">            cv_range (Optional[List[float]], optional): \</span>

<span class="ss">                A list of two numbers defining the lower and upper bounds of the CVs (in the units of the CV). \</span>

<span class="ss">                Defaults to None. \</span>

<span class="ss">        Returns:</span>

<span class="ss">            Tuple: cv_min, cv_max, cv_fes_range</span>

<span class="ss">        &quot;&quot;&quot;</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">cv_select</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="k">None</span><span class="err">:</span>

<span class="w">            </span><span class="n">cv_select</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">list</span><span class="p">(</span><span class="k">range</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">cvs</span><span class="p">))</span>

<span class="w">        </span><span class="n">self</span><span class="p">.</span><span class="n">cv_select</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cv_select</span>

<span class="w">        </span><span class="n">self</span><span class="p">.</span><span class="n">cvs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">len</span><span class="p">(</span><span class="n">cv_select</span><span class="p">)</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">cv_range</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="k">None</span><span class="err">:</span>

<span class="w">            </span><span class="n">cv_min</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">hills</span><span class="p">.</span><span class="n">cv_min</span><span class="o">[</span><span class="n">cv_select</span><span class="o">]</span>

<span class="w">            </span><span class="n">cv_max</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">hills</span><span class="p">.</span><span class="n">cv_max</span><span class="o">[</span><span class="n">cv_select</span><span class="o">]</span>

<span class="w">            </span><span class="n">cv_range</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">hills</span><span class="p">.</span><span class="n">cv_max</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">hills</span><span class="p">.</span><span class="n">cv_min</span>

<span class="w">        </span><span class="k">else</span><span class="err">:</span>

<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="nf">len</span><span class="p">(</span><span class="n">cv_range</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nf">len</span><span class="p">(</span><span class="n">cv_select</span><span class="p">)</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="nf">len</span><span class="p">(</span><span class="n">cv_range</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">2</span><span class="err">:</span>

<span class="w">                </span><span class="n">raise</span><span class="w"> </span><span class="n">ValueError</span><span class="p">(</span>

<span class="w">                    </span><span class="ss">&quot;cv_range has to have the same length as cv_select&quot;</span>

<span class="w">                    </span><span class="ss">&quot;or be a list of two numbers&quot;</span>

<span class="w">                </span><span class="p">)</span>

<span class="w">            </span><span class="n">elif</span><span class="w"> </span><span class="nf">len</span><span class="p">(</span><span class="n">cv_range</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">2</span><span class="err">:</span>

<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="n">type</span><span class="p">(</span><span class="n">cv_range</span><span class="o">[</span><span class="n">0</span><span class="o">]</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nc">int</span><span class="err">:</span>

<span class="w">                    </span><span class="n">cv_min</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">np</span><span class="p">.</span><span class="k">full</span><span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">cv_select</span><span class="p">),</span><span class="w"> </span><span class="n">cv_range</span><span class="o">[</span><span class="n">0</span><span class="o">]</span><span class="p">)</span>

<span class="w">                    </span><span class="n">cv_max</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">np</span><span class="p">.</span><span class="k">full</span><span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">cv_select</span><span class="p">),</span><span class="w"> </span><span class="n">cv_range</span><span class="o">[</span><span class="n">1</span><span class="o">]</span><span class="p">)</span>

<span class="w">            </span><span class="k">else</span><span class="err">:</span>

<span class="w">                </span><span class="n">cv_min</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">np</span><span class="p">.</span><span class="k">array</span><span class="p">(</span><span class="n">cv_range</span><span class="p">)</span><span class="o">[</span><span class="n">:, 0</span><span class="o">]</span>

<span class="w">                </span><span class="n">cv_max</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">np</span><span class="p">.</span><span class="k">array</span><span class="p">(</span><span class="n">cv_range</span><span class="p">)</span><span class="o">[</span><span class="n">:, 1</span><span class="o">]</span>

<span class="w">        </span><span class="n">self</span><span class="p">.</span><span class="n">cv_range</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cv_range</span>

<span class="w">        </span><span class="n">cv_min</span><span class="o">[</span><span class="n">~self.periodic[cv_select</span><span class="o">]</span><span class="w"> </span><span class="err">#</span><span class="w"> </span><span class="nl">type</span><span class="p">:</span><span class="w"> </span><span class="k">ignore</span>

<span class="w">               </span><span class="err">]</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="n">cv_range</span><span class="o">[</span><span class="n">~self.periodic[cv_select</span><span class="o">]</span><span class="err">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">0.15</span><span class="w"> </span><span class="err">#</span><span class="w"> </span><span class="nl">type</span><span class="p">:</span><span class="w"> </span><span class="k">ignore</span>

<span class="w">        </span><span class="n">cv_max</span><span class="o">[</span><span class="n">~self.periodic[cv_select</span><span class="o">]</span><span class="w"> </span><span class="err">#</span><span class="w"> </span><span class="nl">type</span><span class="p">:</span><span class="w"> </span><span class="k">ignore</span>

<span class="w">               </span><span class="err">]</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">cv_range</span><span class="o">[</span><span class="n">~self.periodic[cv_select</span><span class="o">]</span><span class="err">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">0.15</span><span class="w"> </span><span class="err">#</span><span class="w"> </span><span class="nl">type</span><span class="p">:</span><span class="w"> </span><span class="k">ignore</span>

<span class="w">        </span><span class="n">cv_fes_range</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">np</span><span class="p">.</span><span class="nf">abs</span><span class="p">(</span><span class="n">cv_max</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">cv_min</span><span class="p">)</span><span class="w"> </span><span class="err">#</span><span class="w"> </span><span class="nl">type</span><span class="p">:</span><span class="w"> </span><span class="k">ignore</span>

<span class="w">        </span><span class="err">#</span><span class="w"> </span><span class="n">generate</span><span class="w"> </span><span class="n">remapped</span><span class="w"> </span><span class="n">cv_min</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">cv_max</span>

<span class="w">        </span><span class="n">self</span><span class="p">.</span><span class="n">cv_min</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cv_min</span><span class="w"> </span><span class="err">#</span><span class="w"> </span><span class="nl">type</span><span class="p">:</span><span class="w"> </span><span class="k">ignore</span>

<span class="w">        </span><span class="n">self</span><span class="p">.</span><span class="n">cv_max</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cv_max</span><span class="w"> </span><span class="err">#</span><span class="w"> </span><span class="nl">type</span><span class="p">:</span><span class="w"> </span><span class="k">ignore</span>

<span class="w">        </span><span class="n">self</span><span class="p">.</span><span class="n">cv_fes_range</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cv_fes_range</span>
</code></pre></div>

</details>
<h4 id="make_gif">make_gif</h4>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">make_gif</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">gif_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;FES.gif&#39;</span><span class="p">,</span>
    <span class="n">cmap</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;jet&#39;</span><span class="p">,</span>
    <span class="n">xlabel</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">ylabel</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">zlabel</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">label_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">12</span><span class="p">,</span>
    <span class="n">image_size</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">7</span><span class="p">],</span>
    <span class="n">opacity</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.2</span><span class="p">,</span>
    <span class="n">levels</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">frames</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">64</span>
<span class="p">)</span>
</code></pre></div>

<p>Generates an animation of the 3D free energy surface (FES) showing different isosurfaces.</p>
<p>Usage:</p>
<div class="codehilite"><pre><span></span><code><span class="n">fes</span><span class="o">.</span><span class="n">make_gif</span><span class="p">()</span>
</code></pre></div>

<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td>gif_name</td>
<td>str, default="FES.gif"</td>
<td>The name of the gif file of the FES that will be saved in the current working directory.</td>
<td>None</td>
</tr>
<tr>
<td>cmap</td>
<td>str, default="jet"</td>
<td>The Matplotlib colormap used to color the 3D FES.</td>
<td>None</td>
</tr>
<tr>
<td>xlabel, ylabel, zlabel</td>
<td>str</td>
<td>If provided, they will be used as labels for the graph.</td>
<td>None</td>
</tr>
<tr>
<td>label_size</td>
<td>int, default=12</td>
<td>The size of text in the labels.</td>
<td>None</td>
</tr>
<tr>
<td>image_size</td>
<td>List[int], default=[10,7]</td>
<td>The width and height of the picture.</td>
<td>None</td>
</tr>
<tr>
<td>opacity</td>
<td>float, default=0.2</td>
<td>A number between 0 and 1 representing the opacity of isosurfaces in the 3D FES.</td>
<td>None</td>
</tr>
<tr>
<td>levels</td>
<td>List[float]</td>
<td>A list of free energy values for isosurfaces in the 3D FES. If not provided, default values from the contours parameters will be used instead.</td>
<td>None</td>
</tr>
<tr>
<td>frames</td>
<td>int, default=64</td>
<td>The number of frames the animation will be composed of.</td>
<td>None</td>
</tr>
</tbody>
</table>
<details class="example">
<summary>View Source</summary>
<div class="codehilite"><pre><span></span><code>    <span class="s s-Atom">def</span> <span class="nf">make_gif</span><span class="p">(</span>

        <span class="s s-Atom">self</span><span class="p">,</span>

        <span class="s s-Atom">gif_name</span><span class="o">:</span> <span class="s s-Atom">str</span> <span class="o">=</span> <span class="s2">&quot;FES.gif&quot;</span><span class="p">,</span>

        <span class="s s-Atom">cmap</span><span class="p">:</span> <span class="s s-Atom">str</span> <span class="o">=</span> <span class="s2">&quot;jet&quot;</span><span class="p">,</span>

        <span class="s s-Atom">xlabel</span><span class="p">:</span> <span class="nv">Optional</span><span class="p">[</span><span class="s s-Atom">str</span><span class="p">]</span> <span class="o">=</span> <span class="nv">None</span><span class="p">,</span>

        <span class="s s-Atom">ylabel</span><span class="p">:</span> <span class="nv">Optional</span><span class="p">[</span><span class="s s-Atom">str</span><span class="p">]</span> <span class="o">=</span> <span class="nv">None</span><span class="p">,</span>

        <span class="s s-Atom">zlabel</span><span class="p">:</span> <span class="nv">Optional</span><span class="p">[</span><span class="s s-Atom">str</span><span class="p">]</span> <span class="o">=</span> <span class="nv">None</span><span class="p">,</span>

        <span class="s s-Atom">label_size</span><span class="o">:</span> <span class="s s-Atom">int</span> <span class="o">=</span> <span class="mi">12</span><span class="p">,</span>

        <span class="s s-Atom">image_size</span><span class="o">:</span> <span class="nv">List</span><span class="p">[</span><span class="s s-Atom">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">7</span><span class="p">],</span>

        <span class="s s-Atom">opacity</span><span class="p">:</span> <span class="s s-Atom">float</span> <span class="o">=</span> <span class="mf">0.2</span><span class="p">,</span>

        <span class="s s-Atom">levels</span><span class="p">:</span> <span class="nv">Optional</span><span class="p">[</span><span class="nv">List</span><span class="p">[</span><span class="s s-Atom">float</span><span class="p">]]</span> <span class="o">=</span> <span class="nv">None</span><span class="p">,</span>

        <span class="s s-Atom">frames</span><span class="p">:</span> <span class="s s-Atom">int</span> <span class="o">=</span> <span class="mi">64</span><span class="p">,</span>

    <span class="p">)</span><span class="o">:</span>

        <span class="s2">&quot;&quot;&quot;</span>

<span class="s2">        Generates an animation of the 3D free energy surface (FES) showing different isosurfaces.</span>

<span class="s2">        Usage:</span>

<span class="s2">        ```python</span>

<span class="s2">        fes.make_gif()</span>

<span class="s2">        ```</span>

<span class="s2">        Args:</span>

<span class="s2">            gif_name (str, default=&quot;</span><span class="nv">FES</span><span class="p">.</span><span class="s s-Atom">gif</span><span class="err">&quot;</span><span class="p">)</span><span class="o">:</span> <span class="s s-Atom">\</span>

                <span class="nv">The</span> <span class="s s-Atom">name</span> <span class="s s-Atom">of</span> <span class="s s-Atom">the</span> <span class="s s-Atom">gif</span> <span class="s s-Atom">file</span> <span class="s s-Atom">of</span> <span class="s s-Atom">the</span> <span class="nv">FES</span> <span class="s s-Atom">that</span> <span class="s s-Atom">will</span> <span class="s s-Atom">be</span> <span class="s s-Atom">saved</span> <span class="s s-Atom">in</span> <span class="s s-Atom">the</span> <span class="s s-Atom">current</span> <span class="s s-Atom">working</span> <span class="s s-Atom">directory</span><span class="p">.</span>

            <span class="nf">cmap</span> <span class="p">(</span><span class="s s-Atom">str</span><span class="p">,</span> <span class="s s-Atom">default=</span><span class="s2">&quot;jet&quot;</span><span class="p">)</span><span class="o">:</span> <span class="s s-Atom">\</span>

                <span class="nv">The</span> <span class="nv">Matplotlib</span> <span class="s s-Atom">colormap</span> <span class="s s-Atom">used</span> <span class="s s-Atom">to</span> <span class="s s-Atom">color</span> <span class="s s-Atom">the</span> <span class="mi">3</span><span class="nv">D</span> <span class="nv">FES</span><span class="p">.</span>

            <span class="s s-Atom">xlabel</span><span class="p">,</span> <span class="s s-Atom">ylabel</span><span class="p">,</span> <span class="nf">zlabel</span> <span class="p">(</span><span class="s s-Atom">str</span><span class="p">,</span> <span class="s s-Atom">optional</span><span class="p">)</span><span class="o">:</span> <span class="s s-Atom">\</span>

                <span class="nv">If</span> <span class="s s-Atom">provided</span><span class="p">,</span> <span class="s s-Atom">they</span> <span class="s s-Atom">will</span> <span class="s s-Atom">be</span> <span class="s s-Atom">used</span> <span class="s s-Atom">as</span> <span class="s s-Atom">labels</span> <span class="s s-Atom">for</span> <span class="s s-Atom">the</span> <span class="s s-Atom">graph</span><span class="p">.</span>

            <span class="nf">label_size</span> <span class="p">(</span><span class="s s-Atom">int</span><span class="p">,</span> <span class="s s-Atom">default</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span><span class="o">:</span> <span class="s s-Atom">\</span>

                <span class="nv">The</span> <span class="s s-Atom">size</span> <span class="s s-Atom">of</span> <span class="s s-Atom">text</span> <span class="s s-Atom">in</span> <span class="s s-Atom">the</span> <span class="s s-Atom">labels</span><span class="p">.</span>

            <span class="nf">image_size</span> <span class="p">(</span><span class="nv">List</span><span class="p">[</span><span class="s s-Atom">int</span><span class="p">],</span> <span class="s s-Atom">default</span><span class="o">=</span><span class="p">[</span><span class="mi">10</span><span class="p">,</span><span class="mi">7</span><span class="p">])</span><span class="o">:</span> <span class="s s-Atom">\</span>

                <span class="nv">The</span> <span class="s s-Atom">width</span> <span class="s s-Atom">and</span> <span class="s s-Atom">height</span> <span class="s s-Atom">of</span> <span class="s s-Atom">the</span> <span class="s s-Atom">picture</span><span class="p">.</span>

            <span class="nf">opacity</span> <span class="p">(</span><span class="s s-Atom">float</span><span class="p">,</span> <span class="s s-Atom">default</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span><span class="o">:</span> <span class="s s-Atom">\</span>

                <span class="nv">A</span> <span class="s s-Atom">number</span> <span class="s s-Atom">between</span> <span class="mi">0</span> <span class="s s-Atom">and</span> <span class="mi">1</span> <span class="s s-Atom">representing</span> <span class="s s-Atom">the</span> <span class="s s-Atom">opacity</span> <span class="s s-Atom">of</span> <span class="s s-Atom">isosurfaces</span> <span class="s s-Atom">in</span> <span class="s s-Atom">the</span> <span class="mi">3</span><span class="nv">D</span> <span class="nv">FES</span><span class="p">.</span>

            <span class="nf">levels</span> <span class="p">(</span><span class="nv">List</span><span class="p">[</span><span class="s s-Atom">float</span><span class="p">],</span> <span class="s s-Atom">optional</span><span class="p">)</span><span class="o">:</span> <span class="s s-Atom">\</span>

                <span class="nv">A</span> <span class="s s-Atom">list</span> <span class="s s-Atom">of</span> <span class="s s-Atom">free</span> <span class="s s-Atom">energy</span> <span class="nb">val</span><span class="s s-Atom">ues</span> <span class="s s-Atom">for</span> <span class="s s-Atom">isosurfaces</span> <span class="s s-Atom">in</span> <span class="s s-Atom">the</span> <span class="mi">3</span><span class="nv">D</span> <span class="nv">FES</span><span class="p">.</span> <span class="nv">If</span> <span class="o">not</span> <span class="s s-Atom">provided</span><span class="p">,</span> <span class="s s-Atom">default</span> <span class="nb">val</span><span class="s s-Atom">ues</span> <span class="s s-Atom">from</span> <span class="s s-Atom">the</span> <span class="s s-Atom">contours</span> <span class="s s-Atom">parameters</span> <span class="s s-Atom">will</span> <span class="s s-Atom">be</span> <span class="s s-Atom">used</span> <span class="s s-Atom">instead</span><span class="p">.</span>

            <span class="nf">frames</span> <span class="p">(</span><span class="s s-Atom">int</span><span class="p">,</span> <span class="s s-Atom">default</span><span class="o">=</span><span class="mi">64</span><span class="p">)</span><span class="o">:</span> <span class="s s-Atom">\</span>

                <span class="nv">The</span> <span class="s s-Atom">number</span> <span class="s s-Atom">of</span> <span class="s s-Atom">frames</span> <span class="s s-Atom">the</span> <span class="s s-Atom">animation</span> <span class="s s-Atom">will</span> <span class="s s-Atom">be</span> <span class="s s-Atom">composed</span> <span class="s s-Atom">of</span><span class="p">.</span>

        <span class="s2">&quot;&quot;&quot;</span>

<span class="s2">        try:</span>

<span class="s2">            import pyvista as pv</span>

<span class="s2">        except (ImportError, ModuleNotFoundError) as e:</span>

<span class="s2">            print(e)</span>

<span class="s2">            sys.exit(1)</span>

<span class="s2">        if self.fes is None:</span>

<span class="s2">            raise ValueError(</span>

<span class="s2">                &quot;</span><span class="nv">FES</span> <span class="o">not</span> <span class="s s-Atom">calculated</span> <span class="s s-Atom">yet</span><span class="p">.</span> <span class="nv">Use</span> <span class="nf">makefes</span><span class="p">()</span> <span class="s s-Atom">or</span> <span class="nf">makefes2</span><span class="p">()</span> <span class="s s-Atom">first</span><span class="p">.</span><span class="s2">&quot;)</span>

<span class="s2">        if self.cvs == 3:</span>

<span class="s2">            cv1_index = self.cv_select[0]</span>

<span class="s2">            cv2_index = self.cv_select[1]</span>

<span class="s2">            cv3_index = self.cv_select[2]</span>

<span class="s2">            cv1min = self.cv_min[self.cv_select[0]]</span>

<span class="s2">            cv1max = self.cv_max[self.cv_select[0]]</span>

<span class="s2">            cv2min = self.cv_min[self.cv_select[1]]</span>

<span class="s2">            cv2max = self.cv_max[self.cv_select[1]]</span>

<span class="s2">            cv3min = self.cv_min[self.cv_select[2]]</span>

<span class="s2">            cv3max = self.cv_max[self.cv_select[2]]</span>

<span class="s2">            values = np.linspace(np.min(self.fes)+0.01,</span>

<span class="s2">                                 np.max(self.fes), num=frames)</span>

<span class="s2">            grid = pv.UniformGrid(</span>

<span class="s2">                dimensions=(self.res, self.res, self.res),</span>

<span class="s2">                spacing=((cv1max-cv1min)/self.res, (cv2max-cv2min) /</span>

<span class="s2">                         self.res, (cv3max-cv3min)/self.res),</span>

<span class="s2">                origin=(cv1min, cv2min, cv3min),</span>

<span class="s2">            )</span>

<span class="s2">            grid[&quot;</span><span class="s s-Atom">vol</span><span class="s2">&quot;] = np.ravel(self.fes, order=&quot;</span><span class="nv">F</span><span class="s2">&quot;)</span>

<span class="s2">            surface = grid.contour(values[:1])</span>

<span class="s2">            surfaces = [grid.contour([v]) for v in values]</span>

<span class="s2">            surface = surfaces[0].copy()</span>

<span class="s2">            pv.set_plot_theme(&#39;document&#39;)</span>

<span class="s2">            plotter = pv.Plotter(off_screen=True)</span>

<span class="s2">            # Open a movie file</span>

<span class="s2">            plotter.open_gif(gif_name)</span>

<span class="s2">            # Add initial mesh</span>

<span class="s2">            plotter.add_mesh(</span>

<span class="s2">                surface,</span>

<span class="s2">                opacity=0.3,</span>

<span class="s2">                clim=grid.get_data_range(),</span>

<span class="s2">                show_scalar_bar=False,</span>

<span class="s2">                cmap=&quot;</span><span class="s s-Atom">jet</span><span class="s2">&quot;</span>

<span class="s2">            )</span>

<span class="s2">            plotter.add_mesh(grid.outline_corners(), color=&quot;</span><span class="s s-Atom">k</span><span class="s2">&quot;)</span>

<span class="s2">            if xlabel == None and ylabel == None and zlabel == None:</span>

<span class="s2">                plotter.show_grid(</span>

<span class="s2">                    xlabel=f&quot;</span><span class="nv">CV1</span> <span class="o">-</span> <span class="p">{</span><span class="s s-Atom">self</span><span class="p">.</span><span class="s s-Atom">hills</span><span class="p">.</span><span class="s s-Atom">cv_name</span><span class="p">[</span><span class="s s-Atom">cv1_index</span><span class="p">]}</span><span class="s2">&quot;,</span>

<span class="s2">                    ylabel=f&quot;</span><span class="nv">CV2</span> <span class="o">-</span> <span class="p">{</span><span class="s s-Atom">self</span><span class="p">.</span><span class="s s-Atom">hills</span><span class="p">.</span><span class="s s-Atom">cv_name</span><span class="p">[</span><span class="s s-Atom">cv2_index</span><span class="p">]}</span><span class="s2">&quot;,</span>

<span class="s2">                    zlabel=f&quot;</span><span class="nv">CV3</span> <span class="o">-</span> <span class="p">{</span><span class="s s-Atom">self</span><span class="p">.</span><span class="s s-Atom">hills</span><span class="p">.</span><span class="s s-Atom">cv_name</span><span class="p">[</span><span class="s s-Atom">cv3_index</span><span class="p">]}</span><span class="s2">&quot;)</span>

<span class="s2">            else:</span>

<span class="s2">                plotter.show_grid(xlabel=xlabel, ylabel=ylabel, zlabel=zlabel)</span>

<span class="s2">            plotter.set_background(&#39;white&#39;)</span>

<span class="s2">            plotter.show(auto_close=False)</span>

<span class="s2">            # Run through each frame</span>

<span class="s2">            for surf in surfaces:</span>

<span class="s2">                surface.copy_from(surf)</span>

<span class="s2">                plotter.write_frame()  # Write this frame</span>

<span class="s2">            # Run through backwards</span>

<span class="s2">            for surf in surfaces[::-1]:</span>

<span class="s2">                surface.copy_from(surf)</span>

<span class="s2">                plotter.write_frame()  # Write this frame</span>

<span class="s2">            # Be sure to close the plotter when finished</span>

<span class="s2">            plotter.close()</span>

<span class="s2">        else:</span>

<span class="s2">            raise ValueError(</span>

<span class="s2">                &quot;</span><span class="nv">Error</span><span class="o">:</span> <span class="s s-Atom">gif_plot</span> <span class="o">is</span> <span class="s s-Atom">only</span> <span class="s s-Atom">available</span> <span class="s s-Atom">for</span> <span class="nv">FES</span> <span class="s s-Atom">with</span> <span class="mi">3</span> <span class="nv">CVs</span><span class="p">.</span><span class="err">&quot;</span><span class="p">)</span>
</code></pre></div>

</details>
<h4 id="makefes">makefes</h4>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">makefes</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">resolution</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">cv_select</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">cv_range</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">time_min</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">time_max</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<span class="p">)</span>
</code></pre></div>

<p>Function used internally for summing hills in Hills object with the fast Bias Sum Algorithm. </p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td>resolution</td>
<td>int</td>
<td>The resolution of the free energy surface. Defaults to 256.</td>
<td>256</td>
</tr>
<tr>
<td>cv_select</td>
<td>List[int]</td>
<td>A list of integers specifying which collective variables (CVs) should be used for FES calculation.                 Defaults to None.</td>
<td>None</td>
</tr>
<tr>
<td>cv_range</td>
<td>List[float]</td>
<td>A list of two numbers defining the lower and upper bounds of the CVs (in the units of the CV).                 Defaults to None.             time_min (int): The starting time step of simulation. Defaults to 0.</td>
<td>0</td>
</tr>
<tr>
<td>time_max</td>
<td>int</td>
<td>The ending time step of simulation. Defaults to None.</td>
<td>None</td>
</tr>
</tbody>
</table>
<details class="example">
<summary>View Source</summary>
<div class="codehilite"><pre><span></span><code><span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">makefes</span><span class="p">(</span>

<span class="w">        </span><span class="n">self</span><span class="p">,</span>

<span class="w">        </span><span class="nl">resolution</span><span class="p">:</span><span class="w"> </span><span class="n">Optional</span><span class="o">[</span><span class="n">int</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">None</span><span class="p">,</span>

<span class="w">        </span><span class="nl">cv_select</span><span class="p">:</span><span class="w"> </span><span class="n">Optional</span><span class="o">[</span><span class="n">List[int</span><span class="o">]</span><span class="err">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">None</span><span class="p">,</span>

<span class="w">        </span><span class="nl">cv_range</span><span class="p">:</span><span class="w"> </span><span class="n">Optional</span><span class="o">[</span><span class="n">List[float</span><span class="o">]</span><span class="err">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">None</span><span class="p">,</span>

<span class="w">        </span><span class="nl">time_min</span><span class="p">:</span><span class="w"> </span><span class="n">Optional</span><span class="o">[</span><span class="n">int</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">None</span><span class="p">,</span>

<span class="w">        </span><span class="nl">time_max</span><span class="p">:</span><span class="w"> </span><span class="n">Optional</span><span class="o">[</span><span class="n">int</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">None</span>

<span class="w">    </span><span class="p">)</span><span class="err">:</span>

<span class="w">        </span><span class="ss">&quot;&quot;&quot;Function used internally for summing hills in Hills object with the fast Bias Sum Algorithm.</span>

<span class="ss">        Args:</span>

<span class="ss">            resolution (int, optional): \</span>

<span class="ss">                The resolution of the free energy surface. Defaults to 256.</span>

<span class="ss">            cv_select (List[int], optional): \</span>

<span class="ss">                A list of integers specifying which collective variables (CVs) should be used for FES calculation. \</span>

<span class="ss">                Defaults to None.</span>

<span class="ss">            cv_range (List[float], optional): \</span>

<span class="ss">                A list of two numbers defining the lower and upper bounds of the CVs (in the units of the CV). \</span>

<span class="ss">                Defaults to None. \</span>

<span class="ss">            time_min (int): The starting time step of simulation. Defaults to 0.</span>

<span class="ss">            time_max (int, optional): The ending time step of simulation. Defaults to None.</span>

<span class="ss">        &quot;&quot;&quot;</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">resolution</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="k">None</span><span class="err">:</span>

<span class="w">            </span><span class="n">resolution</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">res</span>

<span class="w">        </span><span class="n">self</span><span class="p">.</span><span class="n">generate_cv_map</span><span class="p">(</span><span class="n">cv_select</span><span class="p">,</span><span class="w"> </span><span class="n">cv_range</span><span class="p">)</span>

<span class="w">        </span><span class="n">cv_min</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">cv_min</span>

<span class="w">        </span><span class="n">cv_max</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">cv_max</span>

<span class="w">        </span><span class="n">cv_fes_range</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">cv_fes_range</span>

<span class="w">        </span><span class="n">cv_bins</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">np</span><span class="p">.</span><span class="k">array</span><span class="p">(</span><span class="o">[</span><span class="n">np.ceil(</span>

<span class="n">            (self.hills.cv[time_min:time_max, cv_index</span><span class="o">]</span><span class="w"> </span><span class="o">-</span>

<span class="w">             </span><span class="n">cv_min</span><span class="o">[</span><span class="n">cv_index</span><span class="o">]</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">resolution</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">cv_fes_range</span><span class="o">[</span><span class="n">cv_index</span><span class="o">]</span>

<span class="w">        </span><span class="p">)</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">cv_index</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">cv_select</span><span class="err">]</span><span class="p">)</span>

<span class="w">        </span><span class="n">cvs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">len</span><span class="p">(</span><span class="n">cv_select</span><span class="p">)</span>

<span class="w">        </span><span class="n">cv_bins</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cv_bins</span><span class="p">.</span><span class="n">astype</span><span class="p">(</span><span class="nc">int</span><span class="p">)</span>

<span class="w">        </span><span class="n">sigma</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">np</span><span class="p">.</span><span class="k">array</span><span class="p">(</span><span class="o">[</span><span class="n">self.hills.sigma[cv_index</span><span class="o">][</span><span class="n">0</span><span class="o">]</span>

<span class="w">                         </span><span class="k">for</span><span class="w"> </span><span class="n">cv_index</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">cv_select</span><span class="err">]</span><span class="p">)</span>

<span class="w">        </span><span class="n">sigma_res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">sigma</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">res</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="n">cv_max</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">cv_min</span><span class="p">)</span>

<span class="w">        </span><span class="n">gauss_res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">np</span><span class="p">.</span><span class="nf">max</span><span class="p">((</span><span class="mi">8</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">sigma_res</span><span class="p">).</span><span class="n">astype</span><span class="p">(</span><span class="nc">int</span><span class="p">))</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">gauss_res</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="err">:</span>

<span class="w">            </span><span class="n">gauss_res</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">1</span>

<span class="w">        </span><span class="n">gauss_center_to_end</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">int</span><span class="p">((</span><span class="n">gauss_res</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span>

<span class="w">        </span><span class="n">gauss_center</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gauss_center_to_end</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span>

<span class="w">        </span><span class="n">grids</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">np</span><span class="p">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="o">*[</span><span class="n">np.arange(gauss_res)</span><span class="o">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">cvs</span><span class="p">)</span>

<span class="w">        </span><span class="n">exponent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.</span>

<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="k">range</span><span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">sigma_res</span><span class="p">))</span><span class="err">:</span>

<span class="w">            </span><span class="n">i_diff</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">grids</span><span class="o">[</span><span class="n">i</span><span class="o">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">gauss_center</span>

<span class="w">            </span><span class="n">exponent</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="o">-</span><span class="p">(</span><span class="n">i_diff</span><span class="w"> </span><span class="o">**</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="mi">2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">sigma_res</span><span class="o">[</span><span class="n">i</span><span class="o">]</span><span class="w"> </span><span class="o">**</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span>

<span class="w">        </span><span class="n">gauss</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="n">np</span><span class="p">.</span><span class="nf">exp</span><span class="p">(</span><span class="n">exponent</span><span class="p">)</span>

<span class="w">        </span><span class="n">fes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">np</span><span class="p">.</span><span class="n">zeros</span><span class="p">(</span><span class="o">[</span><span class="n">resolution</span><span class="o">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">cvs</span><span class="p">)</span>

<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="n">line</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">trange</span><span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">cv_bins</span><span class="o">[</span><span class="n">0</span><span class="o">]</span><span class="p">),</span><span class="w"> </span><span class="k">desc</span><span class="o">=</span><span class="ss">&quot;Constructing FES&quot;</span><span class="p">)</span><span class="err">:</span>

<span class="w">            </span><span class="err">#</span><span class="w"> </span><span class="k">create</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">meshgrid</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">indexes</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">fes</span><span class="w"> </span><span class="n">that</span><span class="w"> </span><span class="n">need</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">edited</span>

<span class="w">            </span><span class="err">#</span><span class="w"> </span><span class="k">size</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">meshgrid</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">same</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="k">size</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">gauss</span>

<span class="w">            </span><span class="n">fes_index_to_edit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">np</span><span class="p">.</span><span class="n">meshgrid</span><span class="p">(</span>

<span class="w">                </span><span class="o">*</span><span class="p">(</span><span class="o">[</span>

<span class="n">                    np.arange(gauss_res) - gauss_center</span>

<span class="n">                </span><span class="o">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nf">len</span><span class="p">(</span><span class="n">cv_bins</span><span class="o">[</span><span class="n">:, line</span><span class="o">]</span><span class="p">))</span>

<span class="w">            </span><span class="p">)</span>

<span class="w">            </span><span class="err">#</span><span class="w"> </span><span class="k">create</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">mask</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="n">avoid</span><span class="w"> </span><span class="n">editing</span><span class="w"> </span><span class="n">indexes</span><span class="w"> </span><span class="n">outside</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">fes</span>

<span class="w">            </span><span class="n">local_mask</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">np</span><span class="p">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">gauss</span><span class="p">,</span><span class="w"> </span><span class="n">dtype</span><span class="o">=</span><span class="nc">int</span><span class="p">)</span>

<span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="n">d</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="k">range</span><span class="p">(</span><span class="n">cvs</span><span class="p">)</span><span class="err">:</span>

<span class="w">                </span><span class="n">fes_index_to_edit</span><span class="o">[</span><span class="n">d</span><span class="o">]</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">cv_bins</span><span class="o">[</span><span class="n">d</span><span class="o">][</span><span class="n">line</span><span class="o">]</span>

<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">periodic</span><span class="o">[</span><span class="n">d</span><span class="o">]</span><span class="err">:</span>

<span class="w">                    </span><span class="n">mask</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">np</span><span class="p">.</span><span class="k">where</span><span class="p">(</span>

<span class="w">                        </span><span class="p">(</span><span class="n">fes_index_to_edit</span><span class="o">[</span><span class="n">d</span><span class="o">]</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span>

<span class="w">                            </span><span class="n">fes_index_to_edit</span><span class="o">[</span><span class="n">d</span><span class="o">]</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">resolution</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>

<span class="w">                    </span><span class="p">)</span><span class="o">[</span><span class="n">0</span><span class="o">]</span>

<span class="w">                    </span><span class="err">#</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">cv</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="n">periodic</span><span class="p">,</span><span class="w"> </span><span class="n">remove</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">indexes</span><span class="w"> </span><span class="n">outside</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">fes</span>

<span class="w">                    </span><span class="n">local_mask</span><span class="o">[</span><span class="n">mask</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>

<span class="w">                </span><span class="err">#</span><span class="w"> </span><span class="n">make</span><span class="w"> </span><span class="n">sure</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">indexes</span><span class="w"> </span><span class="k">are</span><span class="w"> </span><span class="n">inside</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">fes</span>

<span class="w">                </span><span class="n">fes_index_to_edit</span><span class="o">[</span><span class="n">d</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">np</span><span class="p">.</span><span class="k">mod</span><span class="p">(</span><span class="n">fes_index_to_edit</span><span class="o">[</span><span class="n">d</span><span class="o">]</span><span class="p">,</span><span class="w"> </span><span class="n">resolution</span><span class="p">)</span>

<span class="w">            </span><span class="n">fes</span><span class="o">[</span><span class="n">tuple(fes_index_to_edit)</span><span class="o">]</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">gauss</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="err">\</span>

<span class="w">                </span><span class="n">local_mask</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">hills</span><span class="p">.</span><span class="n">heights</span><span class="o">[</span><span class="n">line</span><span class="o">]</span>

<span class="w">        </span><span class="n">fes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fes</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">np</span><span class="p">.</span><span class="nf">min</span><span class="p">(</span><span class="n">fes</span><span class="p">)</span>

<span class="w">        </span><span class="n">self</span><span class="p">.</span><span class="n">fes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fes</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">fes</span>
</code></pre></div>

</details>
<h4 id="makefes2">makefes2</h4>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">makefes2</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">resolution</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span>
    <span class="n">cv_select</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">cv_range</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">time_min</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">time_max</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<span class="p">)</span>
</code></pre></div>

<p>Function internally used to sum Hills in the same way as Plumed <code>sum_hills</code>. </p>
<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td>resolution</td>
<td>int</td>
<td>The resolution of the free energy surface. Defaults to 256.</td>
<td>256</td>
</tr>
<tr>
<td>cv_select</td>
<td>List[int]</td>
<td>A list of integers specifying which collective variables (CVs) should be used for FES calculation.                 Defaults to None.</td>
<td>None</td>
</tr>
<tr>
<td>cv_range</td>
<td>List[float]</td>
<td>A list of two numbers defining the lower and upper bounds of the CVs (in the units of the CV).                 Defaults to None.             time_min (int): The starting time step of simulation. Defaults to 0.</td>
<td>0</td>
</tr>
<tr>
<td>time_max</td>
<td>int</td>
<td>The ending time step of simulation. Defaults to None.</td>
<td>None</td>
</tr>
</tbody>
</table>
<details class="example">
<summary>View Source</summary>
<div class="codehilite"><pre><span></span><code><span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">makefes2</span><span class="p">(</span>

<span class="w">        </span><span class="n">self</span><span class="p">,</span>

<span class="w">        </span><span class="nl">resolution</span><span class="p">:</span><span class="w"> </span><span class="n">Optional</span><span class="o">[</span><span class="n">int</span><span class="o">]</span><span class="p">,</span>

<span class="w">        </span><span class="nl">cv_select</span><span class="p">:</span><span class="w"> </span><span class="n">Optional</span><span class="o">[</span><span class="n">List[int</span><span class="o">]</span><span class="err">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">None</span><span class="p">,</span>

<span class="w">        </span><span class="nl">cv_range</span><span class="p">:</span><span class="w"> </span><span class="n">Optional</span><span class="o">[</span><span class="n">List[float</span><span class="o">]</span><span class="err">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">None</span><span class="p">,</span>

<span class="w">        </span><span class="nl">time_min</span><span class="p">:</span><span class="w"> </span><span class="n">Optional</span><span class="o">[</span><span class="n">int</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">None</span><span class="p">,</span>

<span class="w">        </span><span class="nl">time_max</span><span class="p">:</span><span class="w"> </span><span class="n">Optional</span><span class="o">[</span><span class="n">int</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">None</span>

<span class="w">    </span><span class="p">)</span><span class="err">:</span>

<span class="w">        </span><span class="ss">&quot;&quot;&quot;</span>

<span class="ss">        Function internally used to sum Hills in the same way as Plumed `sum_hills`.</span>

<span class="ss">        Args:</span>

<span class="ss">            resolution (int, optional): \</span>

<span class="ss">                The resolution of the free energy surface. Defaults to 256.</span>

<span class="ss">            cv_select (List[int], optional): \</span>

<span class="ss">                A list of integers specifying which collective variables (CVs) should be used for FES calculation. \</span>

<span class="ss">                Defaults to None.</span>

<span class="ss">            cv_range (List[float], optional): \</span>

<span class="ss">                A list of two numbers defining the lower and upper bounds of the CVs (in the units of the CV). \</span>

<span class="ss">                Defaults to None. \</span>

<span class="ss">            time_min (int): The starting time step of simulation. Defaults to 0.</span>

<span class="ss">            time_max (int, optional): The ending time step of simulation. Defaults to None.</span>

<span class="ss">        &quot;&quot;&quot;</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">resolution</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="k">None</span><span class="err">:</span>

<span class="w">            </span><span class="n">resolution</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">res</span>

<span class="w">        </span><span class="n">self</span><span class="p">.</span><span class="n">generate_cv_map</span><span class="p">(</span><span class="n">cv_select</span><span class="p">,</span><span class="w"> </span><span class="n">cv_range</span><span class="p">)</span>

<span class="w">        </span><span class="n">cv_min</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">cv_min</span>

<span class="w">        </span><span class="n">cv_max</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">cv_max</span>

<span class="w">        </span><span class="n">cv_fes_range</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">cv_fes_range</span>

<span class="w">        </span><span class="n">cvs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">len</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">cv_select</span><span class="p">)</span>

<span class="w">        </span><span class="n">fes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">np</span><span class="p">.</span><span class="n">zeros</span><span class="p">(</span><span class="o">[</span><span class="n">resolution</span><span class="o">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">cvs</span><span class="p">)</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">time_min</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="nl">time_max</span><span class="p">:</span>

<span class="w">            </span><span class="n">time_limit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">time_max</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">time_min</span>

<span class="w">        </span><span class="k">else</span><span class="err">:</span>

<span class="w">            </span><span class="n">time_min</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>

<span class="w">            </span><span class="n">time_max</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">hills</span><span class="p">.</span><span class="n">cv</span><span class="o">[</span><span class="n">:, 0</span><span class="o">]</span><span class="p">.</span><span class="n">shape</span><span class="o">[</span><span class="n">0</span><span class="o">]</span>

<span class="w">            </span><span class="n">time_limit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">time_max</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">time_min</span>

<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="k">index</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">tqdm</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="n">ndindex</span><span class="p">(</span><span class="n">fes</span><span class="p">.</span><span class="n">shape</span><span class="p">),</span><span class="w">  </span><span class="err">#</span><span class="w"> </span><span class="nl">type</span><span class="p">:</span><span class="w"> </span><span class="k">ignore</span>

<span class="w">                          </span><span class="k">desc</span><span class="o">=</span><span class="ss">&quot;Constructing FES&quot;</span><span class="p">,</span>

<span class="w">                          </span><span class="n">total</span><span class="o">=</span><span class="n">np</span><span class="p">.</span><span class="n">prod</span><span class="p">(</span><span class="n">fes</span><span class="p">.</span><span class="n">shape</span><span class="p">))</span><span class="err">:</span><span class="w">  </span><span class="err">#</span><span class="w"> </span><span class="nl">type</span><span class="p">:</span><span class="w"> </span><span class="k">ignore</span>

<span class="w">            </span><span class="n">dp2_array</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">np</span><span class="p">.</span><span class="n">zeros</span><span class="p">(</span><span class="o">[</span><span class="n">cvs, time_limit</span><span class="o">]</span><span class="p">)</span>

<span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">cv_idx</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">enumerate</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">cv_select</span><span class="p">)</span><span class="err">:</span>

<span class="w">                </span><span class="n">dist_cv</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">\</span>

<span class="w">                    </span><span class="n">self</span><span class="p">.</span><span class="n">hills</span><span class="p">.</span><span class="n">cv</span><span class="o">[</span><span class="n">:, cv_idx</span><span class="o">]</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="err">\</span>

<span class="w">                    </span><span class="p">(</span><span class="n">cv_min</span><span class="o">[</span><span class="n">i</span><span class="o">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">index</span><span class="o">[</span><span class="n">i</span><span class="o">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">cv_fes_range</span><span class="o">[</span><span class="n">i</span><span class="o">]</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">resolution</span><span class="p">)</span>

<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">periodic</span><span class="o">[</span><span class="n">cv_idx</span><span class="o">]</span><span class="err">:</span>

<span class="w">                    </span><span class="n">dist_cv</span><span class="o">[</span><span class="n">dist_cv &lt; -0.5*cv_fes_range[i</span><span class="o">]</span><span class="err">]</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">cv_fes_range</span><span class="o">[</span><span class="n">i</span><span class="o">]</span>

<span class="w">                    </span><span class="n">dist_cv</span><span class="o">[</span><span class="n">dist_cv &gt; +0.5*cv_fes_range[i</span><span class="o">]</span><span class="err">]</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="n">cv_fes_range</span><span class="o">[</span><span class="n">i</span><span class="o">]</span>

<span class="w">                </span><span class="n">dp2_local</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dist_cv</span><span class="w"> </span><span class="o">**</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="err">\</span>

<span class="w">                    </span><span class="p">(</span><span class="mi">2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">hills</span><span class="p">.</span><span class="n">sigma</span><span class="o">[</span><span class="n">cv_idx</span><span class="o">][</span><span class="n">0</span><span class="o">]</span><span class="w"> </span><span class="o">**</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span>

<span class="w">                </span><span class="n">dp2_array</span><span class="o">[</span><span class="n">i</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dp2_local</span>

<span class="w">            </span><span class="n">dp2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">np</span><span class="p">.</span><span class="nf">sum</span><span class="p">(</span><span class="n">dp2_array</span><span class="p">,</span><span class="w"> </span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="w">            </span><span class="n">tmp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">np</span><span class="p">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">time_limit</span><span class="p">)</span>

<span class="w">            </span><span class="n">tmp</span><span class="o">[</span><span class="n">dp2 &lt; 6.25</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">hills</span><span class="p">.</span><span class="n">heights</span><span class="o">[</span><span class="n">dp2 &lt; 6.25</span><span class="o">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="err">\</span>

<span class="w">                </span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="nf">exp</span><span class="p">(</span><span class="o">-</span><span class="n">dp2</span><span class="o">[</span><span class="n">dp2 &lt; 6.25</span><span class="o">]</span><span class="p">)</span><span class="w"> </span><span class="o">*</span>

<span class="w">                 </span><span class="mf">1.00193418799744762399</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">0.00193418799744762399</span><span class="p">)</span>

<span class="w">            </span><span class="n">fes</span><span class="o">[</span><span class="n">index</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="n">tmp</span><span class="p">.</span><span class="nf">sum</span><span class="p">()</span>

<span class="w">        </span><span class="n">fes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fes</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">np</span><span class="p">.</span><span class="nf">min</span><span class="p">(</span><span class="n">fes</span><span class="p">)</span>

<span class="w">        </span><span class="n">self</span><span class="p">.</span><span class="n">fes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">np</span><span class="p">.</span><span class="k">array</span><span class="p">(</span><span class="n">fes</span><span class="p">)</span>
</code></pre></div>

</details>
<h4 id="plot">plot</h4>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">plot</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">png_name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">contours</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">contours_spacing</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span>
    <span class="n">aspect</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
    <span class="n">cmap</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;jet&#39;</span><span class="p">,</span>
    <span class="n">energy_unit</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;kJ/mol&#39;</span><span class="p">,</span>
    <span class="n">xlabel</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">ylabel</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">zlabel</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">label_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">12</span><span class="p">,</span>
    <span class="n">image_size</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">7</span><span class="p">],</span>
    <span class="n">vmin</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">vmax</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">opacity</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.2</span><span class="p">,</span>
    <span class="n">levels</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
<span class="p">)</span>
</code></pre></div>

<p>Visualizes the free energy surface (FES) using Matplotlib and PyVista.</p>
<p>Usage:</p>
<div class="codehilite"><pre><span></span><code><span class="n">fes</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
</code></pre></div>

<p><strong>Parameters:</strong></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td>png_name</td>
<td>str</td>
<td>If provided, the picture of FES will be saved under this name in the current working directory.</td>
<td>None</td>
</tr>
<tr>
<td>contours</td>
<td>bool, default=True</td>
<td>Determines whether contours should be shown on the 2D FES.</td>
<td>None</td>
</tr>
<tr>
<td>contours_spacing</td>
<td>float, default=0.0</td>
<td>When a positive number is set, it will be used as the spacing for contours on the 2D FES. Otherwise, if contours=True, there will be five equally spaced contour levels.</td>
<td>None</td>
</tr>
<tr>
<td>aspect</td>
<td>float, default=1.0</td>
<td>The aspect ratio of the graph. Works with 1D and 2D FES.</td>
<td>None</td>
</tr>
<tr>
<td>cmap</td>
<td>str, default="jet"</td>
<td>The Matplotlib colormap used to color the 2D or 3D FES.</td>
<td>None</td>
</tr>
<tr>
<td>energy_unit</td>
<td>str, default="kJ/mol"</td>
<td>The unit used in the description of the colorbar.</td>
<td>None</td>
</tr>
<tr>
<td>xlabel, ylabel, zlabel</td>
<td>str</td>
<td>If provided, they will be used as labels for the graphs.</td>
<td>None</td>
</tr>
<tr>
<td>label_size</td>
<td>int, default=12</td>
<td>The size of text in the labels.</td>
<td>None</td>
</tr>
<tr>
<td>image_size</td>
<td>List[int], default=[10,7]</td>
<td>The width and height of the picture.</td>
<td>None</td>
</tr>
<tr>
<td>vmin</td>
<td>float, default=0</td>
<td>The lower bound for the colormap on the 2D FES.</td>
<td>None</td>
</tr>
<tr>
<td>vmax</td>
<td>float</td>
<td>The upper bound for the colormap on the 2D FES.</td>
<td>None</td>
</tr>
<tr>
<td>opacity</td>
<td>float, default=0.2</td>
<td>A number between 0 and 1 that represents the opacity of isosurfaces in the 3D FES.</td>
<td>None</td>
</tr>
<tr>
<td>levels</td>
<td>List[float]</td>
<td>A list of free energy values for isosurfaces in the 3D FES. If not provided, default values from the contours parameters will be used instead.</td>
<td>None</td>
</tr>
</tbody>
</table>
<details class="example">
<summary>View Source</summary>
<div class="codehilite"><pre><span></span><code><span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">plot</span><span class="p">(</span>

<span class="w">        </span><span class="n">self</span><span class="p">,</span>

<span class="w">        </span><span class="nl">png_name</span><span class="p">:</span><span class="w"> </span><span class="n">Optional</span><span class="o">[</span><span class="n">str</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">None</span><span class="p">,</span>

<span class="w">        </span><span class="nl">contours</span><span class="p">:</span><span class="w"> </span><span class="n">bool</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">True</span><span class="p">,</span>

<span class="w">        </span><span class="nl">contours_spacing</span><span class="p">:</span><span class="w"> </span><span class="nc">float</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="p">,</span>

<span class="w">        </span><span class="nl">aspect</span><span class="p">:</span><span class="w"> </span><span class="nc">float</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0</span><span class="p">,</span>

<span class="w">        </span><span class="nl">cmap</span><span class="p">:</span><span class="w"> </span><span class="nf">str</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ss">&quot;jet&quot;</span><span class="p">,</span>

<span class="w">        </span><span class="nl">energy_unit</span><span class="p">:</span><span class="w"> </span><span class="nf">str</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ss">&quot;kJ/mol&quot;</span><span class="p">,</span>

<span class="w">        </span><span class="nl">xlabel</span><span class="p">:</span><span class="w"> </span><span class="n">Optional</span><span class="o">[</span><span class="n">str</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">None</span><span class="p">,</span>

<span class="w">        </span><span class="nl">ylabel</span><span class="p">:</span><span class="w"> </span><span class="n">Optional</span><span class="o">[</span><span class="n">str</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">None</span><span class="p">,</span>

<span class="w">        </span><span class="nl">zlabel</span><span class="p">:</span><span class="w"> </span><span class="n">Optional</span><span class="o">[</span><span class="n">str</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">None</span><span class="p">,</span>

<span class="w">        </span><span class="nl">label_size</span><span class="p">:</span><span class="w"> </span><span class="nc">int</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">12</span><span class="p">,</span>

<span class="w">        </span><span class="nl">image_size</span><span class="p">:</span><span class="w"> </span><span class="n">List</span><span class="o">[</span><span class="n">int</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">[</span><span class="n">10, 7</span><span class="o">]</span><span class="p">,</span>

<span class="w">        </span><span class="nl">vmin</span><span class="p">:</span><span class="w"> </span><span class="nc">float</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>

<span class="w">        </span><span class="nl">vmax</span><span class="p">:</span><span class="w"> </span><span class="n">Optional</span><span class="o">[</span><span class="n">float</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">None</span><span class="p">,</span>

<span class="w">        </span><span class="nl">opacity</span><span class="p">:</span><span class="w"> </span><span class="nc">float</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.2</span><span class="p">,</span>

<span class="w">        </span><span class="nl">levels</span><span class="p">:</span><span class="w"> </span><span class="n">Optional</span><span class="o">[</span><span class="n">List[float</span><span class="o">]</span><span class="err">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">None</span><span class="p">,</span>

<span class="w">    </span><span class="p">)</span><span class="err">:</span>

<span class="w">        </span><span class="ss">&quot;&quot;&quot;</span>

<span class="ss">        Visualizes the free energy surface (FES) using Matplotlib and PyVista.</span>

<span class="ss">        Usage:</span>

<span class="ss">        ```python</span>

<span class="ss">        fes.plot()</span>

<span class="ss">        ```</span>

<span class="ss">        Args:</span>

<span class="ss">            png_name (str, optional): If provided, the picture of FES will be saved under this name in the current working directory.</span>

<span class="ss">            contours (bool, default=True): Determines whether contours should be shown on the 2D FES.</span>

<span class="ss">            contours_spacing (float, default=0.0): When a positive number is set, it will be used as the spacing for contours on the 2D FES. Otherwise, if contours=True, there will be five equally spaced contour levels.</span>

<span class="ss">            aspect (float, default=1.0): The aspect ratio of the graph. Works with 1D and 2D FES.</span>

<span class="ss">            cmap (str, default=&quot;</span><span class="n">jet</span><span class="ss">&quot;): The Matplotlib colormap used to color the 2D or 3D FES.</span>

<span class="ss">            energy_unit (str, default=&quot;</span><span class="n">kJ</span><span class="o">/</span><span class="n">mol</span><span class="ss">&quot;): The unit used in the description of the colorbar.</span>

<span class="ss">            xlabel, ylabel, zlabel (str, optional): If provided, they will be used as labels for the graphs.</span>

<span class="ss">            label_size (int, default=12): The size of text in the labels.</span>

<span class="ss">            image_size (List[int], default=[10,7]): The width and height of the picture.</span>

<span class="ss">            vmin (float, default=0): The lower bound for the colormap on the 2D FES.</span>

<span class="ss">            vmax (float, optional): The upper bound for the colormap on the 2D FES.</span>

<span class="ss">            opacity (float, default=0.2): A number between 0 and 1 that represents the opacity of isosurfaces in the 3D FES.</span>

<span class="ss">            levels (List[float], optional): A list of free energy values for isosurfaces in the 3D FES. If not provided, default values from the contours parameters will be used instead.</span>

<span class="ss">        &quot;&quot;&quot;</span>

<span class="w">        </span><span class="n">import</span><span class="w"> </span><span class="n">matplotlib</span><span class="p">.</span><span class="n">cm</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">cm</span>

<span class="w">        </span><span class="n">import</span><span class="w"> </span><span class="n">matplotlib</span><span class="p">.</span><span class="n">pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">plt</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">fes</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="k">None</span><span class="err">:</span>

<span class="w">            </span><span class="n">raise</span><span class="w"> </span><span class="n">ValueError</span><span class="p">(</span>

<span class="w">                </span><span class="ss">&quot;FES not calculated yet. Use makefes() or makefes2() first.&quot;</span><span class="p">)</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">vmax</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="k">None</span><span class="err">:</span>

<span class="w">            </span><span class="err">#</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">addition</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">smaller</span><span class="w"> </span><span class="k">than</span><span class="w"> </span><span class="mf">0.01</span><span class="p">,</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="mi">3</span><span class="n">d</span><span class="w"> </span><span class="n">plot</span><span class="w"> </span><span class="n">stops</span><span class="w"> </span><span class="n">working</span><span class="p">.</span>

<span class="w">            </span><span class="n">vmax</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">np</span><span class="p">.</span><span class="nf">max</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">fes</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">0.01</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">contours_spacing</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mf">0.0</span><span class="err">:</span>

<span class="w">            </span><span class="n">contours_spacing</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">vmax</span><span class="o">-</span><span class="n">vmin</span><span class="p">)</span><span class="o">/</span><span class="mf">5.0</span>

<span class="w">        </span><span class="n">cmap</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cm</span><span class="p">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="n">cmap</span><span class="p">)</span>

<span class="w">        </span><span class="n">cmap</span><span class="p">.</span><span class="n">set_over</span><span class="p">(</span><span class="ss">&quot;white&quot;</span><span class="p">)</span>

<span class="w">        </span><span class="n">cmap</span><span class="p">.</span><span class="n">set_under</span><span class="p">(</span><span class="ss">&quot;white&quot;</span><span class="p">)</span>

<span class="w">        </span><span class="n">cvs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">len</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">cv_select</span><span class="p">)</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">cvs</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="err">:</span>

<span class="w">            </span><span class="n">cv_index</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">cv_select</span><span class="o">[</span><span class="n">0</span><span class="o">]</span>

<span class="w">            </span><span class="n">plt</span><span class="p">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="n">image_size</span><span class="o">[</span><span class="n">cv_index</span><span class="o">]</span><span class="p">,</span><span class="w"> </span><span class="n">image_size</span><span class="o">[</span><span class="n">1</span><span class="o">]</span><span class="p">))</span>

<span class="w">            </span><span class="n">X</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">np</span><span class="p">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">cv_min</span><span class="o">[</span><span class="n">cv_index</span><span class="o">]</span><span class="p">,</span>

<span class="w">                            </span><span class="n">self</span><span class="p">.</span><span class="n">cv_max</span><span class="o">[</span><span class="n">cv_index</span><span class="o">]</span><span class="p">,</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">res</span><span class="p">)</span>

<span class="w">            </span><span class="n">plt</span><span class="p">.</span><span class="n">plot</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">fes</span><span class="p">)</span>

<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="n">xlabel</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="k">None</span><span class="err">:</span>

<span class="w">                </span><span class="n">plt</span><span class="p">.</span><span class="n">xlabel</span><span class="p">(</span>

<span class="w">                    </span><span class="n">f</span><span class="s1">&#39;CV1 - {self.hills.cv_name[cv_index]}&#39;</span><span class="p">,</span><span class="w"> </span><span class="k">size</span><span class="o">=</span><span class="n">label_size</span><span class="p">)</span>

<span class="w">            </span><span class="k">else</span><span class="err">:</span>

<span class="w">                </span><span class="n">plt</span><span class="p">.</span><span class="n">xlabel</span><span class="p">(</span><span class="n">xlabel</span><span class="p">,</span><span class="w"> </span><span class="k">size</span><span class="o">=</span><span class="n">label_size</span><span class="p">)</span>

<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="n">ylabel</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="k">None</span><span class="err">:</span>

<span class="w">                </span><span class="n">plt</span><span class="p">.</span><span class="n">ylabel</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;free energy ({energy_unit})&#39;</span><span class="p">,</span><span class="w"> </span><span class="k">size</span><span class="o">=</span><span class="n">label_size</span><span class="p">)</span>

<span class="w">            </span><span class="k">else</span><span class="err">:</span>

<span class="w">                </span><span class="n">plt</span><span class="p">.</span><span class="n">ylabel</span><span class="p">(</span><span class="n">ylabel</span><span class="p">,</span><span class="w"> </span><span class="k">size</span><span class="o">=</span><span class="n">label_size</span><span class="p">)</span>

<span class="w">        </span><span class="n">elif</span><span class="w"> </span><span class="n">cvs</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">2</span><span class="err">:</span>

<span class="w">            </span><span class="n">cv1_index</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">cv_select</span><span class="o">[</span><span class="n">0</span><span class="o">]</span>

<span class="w">            </span><span class="n">cv2_index</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">cv_select</span><span class="o">[</span><span class="n">1</span><span class="o">]</span>

<span class="w">            </span><span class="n">cv1min</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">cv_min</span><span class="o">[</span><span class="n">self.cv_select[0</span><span class="o">]</span><span class="err">]</span>

<span class="w">            </span><span class="n">cv1max</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">cv_max</span><span class="o">[</span><span class="n">self.cv_select[0</span><span class="o">]</span><span class="err">]</span>

<span class="w">            </span><span class="n">cv2min</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">cv_min</span><span class="o">[</span><span class="n">self.cv_select[1</span><span class="o">]</span><span class="err">]</span>

<span class="w">            </span><span class="n">cv2max</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">cv_max</span><span class="o">[</span><span class="n">self.cv_select[1</span><span class="o">]</span><span class="err">]</span>

<span class="w">            </span><span class="n">fig</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">plt</span><span class="p">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="n">image_size</span><span class="o">[</span><span class="n">0</span><span class="o">]</span><span class="p">,</span><span class="w"> </span><span class="n">image_size</span><span class="o">[</span><span class="n">1</span><span class="o">]</span><span class="p">))</span>

<span class="w">            </span><span class="n">plt</span><span class="p">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="n">rot90</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">fes</span><span class="p">,</span><span class="w"> </span><span class="n">axes</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)),</span><span class="w"> </span><span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span><span class="w"> </span><span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;nearest&#39;</span><span class="p">,</span>

<span class="w">                       </span><span class="n">extent</span><span class="o">=[</span><span class="n">cv1min, cv1max, cv2min, cv2max</span><span class="o">]</span><span class="p">,</span>

<span class="w">                       </span><span class="n">aspect</span><span class="o">=</span><span class="p">(((</span><span class="n">cv1max</span><span class="o">-</span><span class="n">cv1min</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">cv2max</span><span class="o">-</span><span class="n">cv2min</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="n">aspect</span><span class="p">)),</span>

<span class="w">                       </span><span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span><span class="w"> </span><span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">)</span><span class="w">  </span><span class="err">#</span><span class="w"> </span><span class="nl">type</span><span class="p">:</span><span class="w"> </span><span class="k">ignore</span>

<span class="w">            </span><span class="n">cbar</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">plt</span><span class="p">.</span><span class="n">colorbar</span><span class="p">()</span>

<span class="w">            </span><span class="n">cbar</span><span class="p">.</span><span class="n">set_label</span><span class="p">(</span><span class="n">energy_unit</span><span class="p">,</span><span class="w"> </span><span class="k">size</span><span class="o">=</span><span class="n">label_size</span><span class="p">)</span>

<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="nl">contours</span><span class="p">:</span>

<span class="w">                </span><span class="n">cont</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">plt</span><span class="p">.</span><span class="n">contour</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="n">rot90</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">fes</span><span class="p">,</span><span class="w"> </span><span class="n">axes</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)),</span>

<span class="w">                                   </span><span class="n">levels</span><span class="o">=</span><span class="n">np</span><span class="p">.</span><span class="n">arange</span><span class="p">(</span>

<span class="w">                                       </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">vmax</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">0.01</span><span class="p">),</span><span class="w"> </span><span class="n">contours_spacing</span><span class="p">),</span>

<span class="w">                                   </span><span class="n">extent</span><span class="o">=[</span><span class="n">cv1min, cv1max, cv2max, cv2min</span><span class="o">]</span><span class="p">,</span>

<span class="w">                                   </span><span class="n">colors</span><span class="o">=</span><span class="ss">&quot;k&quot;</span><span class="p">)</span>

<span class="w">                </span><span class="n">plt</span><span class="p">.</span><span class="n">clabel</span><span class="p">(</span><span class="n">cont</span><span class="p">,</span><span class="w"> </span><span class="n">levels</span><span class="o">=</span><span class="n">np</span><span class="p">.</span><span class="n">arange</span><span class="p">(</span>

<span class="w">                    </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">vmax</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">0.01</span><span class="p">),</span><span class="w"> </span><span class="n">contours_spacing</span><span class="p">))</span>

<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="n">xlabel</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="k">None</span><span class="err">:</span>

<span class="w">                </span><span class="n">plt</span><span class="p">.</span><span class="n">xlabel</span><span class="p">(</span>

<span class="w">                    </span><span class="n">f</span><span class="s1">&#39;CV1 - {self.hills.cv_name[cv1_index]}&#39;</span><span class="p">,</span><span class="w"> </span><span class="k">size</span><span class="o">=</span><span class="n">label_size</span><span class="p">)</span>

<span class="w">            </span><span class="k">else</span><span class="err">:</span>

<span class="w">                </span><span class="n">plt</span><span class="p">.</span><span class="n">xlabel</span><span class="p">(</span><span class="n">xlabel</span><span class="p">,</span><span class="w"> </span><span class="k">size</span><span class="o">=</span><span class="n">label_size</span><span class="p">)</span>

<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="n">ylabel</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="k">None</span><span class="err">:</span>

<span class="w">                </span><span class="n">plt</span><span class="p">.</span><span class="n">ylabel</span><span class="p">(</span>

<span class="w">                    </span><span class="n">f</span><span class="s1">&#39;CV2 - {self.hills.cv_name[cv2_index]}&#39;</span><span class="p">,</span><span class="w"> </span><span class="k">size</span><span class="o">=</span><span class="n">label_size</span><span class="p">)</span>

<span class="w">            </span><span class="k">else</span><span class="err">:</span>

<span class="w">                </span><span class="n">plt</span><span class="p">.</span><span class="n">ylabel</span><span class="p">(</span><span class="n">ylabel</span><span class="p">,</span><span class="w"> </span><span class="k">size</span><span class="o">=</span><span class="n">label_size</span><span class="p">)</span>

<span class="w">        </span><span class="n">elif</span><span class="w"> </span><span class="n">cvs</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">3</span><span class="err">:</span>

<span class="w">            </span><span class="k">try</span><span class="err">:</span>

<span class="w">                </span><span class="n">import</span><span class="w"> </span><span class="n">pyvista</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">pv</span>

<span class="w">            </span><span class="ow">except</span><span class="w"> </span><span class="p">(</span><span class="n">ImportError</span><span class="p">,</span><span class="w"> </span><span class="n">ModuleNotFoundError</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nl">e</span><span class="p">:</span>

<span class="w">                </span><span class="k">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

<span class="w">                </span><span class="n">sys</span><span class="p">.</span><span class="k">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="w">            </span><span class="n">cv1_index</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">cv_select</span><span class="o">[</span><span class="n">0</span><span class="o">]</span>

<span class="w">            </span><span class="n">cv2_index</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">cv_select</span><span class="o">[</span><span class="n">1</span><span class="o">]</span>

<span class="w">            </span><span class="n">cv3_index</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">cv_select</span><span class="o">[</span><span class="n">2</span><span class="o">]</span>

<span class="w">            </span><span class="n">cv1min</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">cv_min</span><span class="o">[</span><span class="n">self.cv_select[0</span><span class="o">]</span><span class="err">]</span>

<span class="w">            </span><span class="n">cv1max</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">cv_max</span><span class="o">[</span><span class="n">self.cv_select[0</span><span class="o">]</span><span class="err">]</span>

<span class="w">            </span><span class="n">cv2min</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">cv_min</span><span class="o">[</span><span class="n">self.cv_select[1</span><span class="o">]</span><span class="err">]</span>

<span class="w">            </span><span class="n">cv2max</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">cv_max</span><span class="o">[</span><span class="n">self.cv_select[1</span><span class="o">]</span><span class="err">]</span>

<span class="w">            </span><span class="n">cv3min</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">cv_min</span><span class="o">[</span><span class="n">self.cv_select[2</span><span class="o">]</span><span class="err">]</span>

<span class="w">            </span><span class="n">cv3max</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">cv_max</span><span class="o">[</span><span class="n">self.cv_select[2</span><span class="o">]</span><span class="err">]</span>

<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="n">xlabel</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="k">None</span><span class="err">:</span>

<span class="w">                </span><span class="n">xlabel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ss">&quot;CV1 - &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">hills</span><span class="p">.</span><span class="n">cv_name</span><span class="o">[</span><span class="n">cv1_index</span><span class="o">]</span>

<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="n">ylabel</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="k">None</span><span class="err">:</span>

<span class="w">                </span><span class="n">ylabel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ss">&quot;CV2 - &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">hills</span><span class="p">.</span><span class="n">cv_name</span><span class="o">[</span><span class="n">cv2_index</span><span class="o">]</span>

<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="n">zlabel</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="k">None</span><span class="err">:</span>

<span class="w">                </span><span class="n">zlabel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ss">&quot;CV3 - &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">hills</span><span class="p">.</span><span class="n">cv_name</span><span class="o">[</span><span class="n">cv3_index</span><span class="o">]</span>

<span class="w">            </span><span class="n">grid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pv</span><span class="p">.</span><span class="n">UniformGrid</span><span class="p">(</span>

<span class="w">                </span><span class="n">dimensions</span><span class="o">=</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">res</span><span class="p">,</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">res</span><span class="p">,</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">res</span><span class="p">),</span>

<span class="w">                </span><span class="n">spacing</span><span class="o">=</span><span class="p">((</span><span class="n">cv1max</span><span class="o">-</span><span class="n">cv1min</span><span class="p">)</span><span class="o">/</span><span class="n">self</span><span class="p">.</span><span class="n">res</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">cv2max</span><span class="o">-</span><span class="n">cv2min</span><span class="p">)</span><span class="w"> </span><span class="o">/</span>

<span class="w">                         </span><span class="n">self</span><span class="p">.</span><span class="n">res</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">cv3max</span><span class="o">-</span><span class="n">cv3min</span><span class="p">)</span><span class="o">/</span><span class="n">self</span><span class="p">.</span><span class="n">res</span><span class="p">),</span>

<span class="w">                </span><span class="n">origin</span><span class="o">=</span><span class="p">(</span><span class="n">cv1min</span><span class="p">,</span><span class="w"> </span><span class="n">cv2min</span><span class="p">,</span><span class="w"> </span><span class="n">cv3min</span><span class="p">)</span>

<span class="w">            </span><span class="p">)</span>

<span class="w">            </span><span class="n">grid</span><span class="o">[</span><span class="n">&quot;vol&quot;</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">fes</span><span class="p">.</span><span class="n">ravel</span><span class="p">(</span><span class="k">order</span><span class="o">=</span><span class="ss">&quot;F&quot;</span><span class="p">)</span>

<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="n">levels</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="k">None</span><span class="err">:</span>

<span class="w">                </span><span class="n">contours</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">grid</span><span class="p">.</span><span class="n">contour</span><span class="p">(</span>

<span class="w">                    </span><span class="n">np</span><span class="p">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">vmax</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">0.01</span><span class="p">),</span><span class="w"> </span><span class="n">contours_spacing</span><span class="p">))</span>

<span class="w">            </span><span class="k">else</span><span class="err">:</span>

<span class="w">                </span><span class="n">contours</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">grid</span><span class="p">.</span><span class="n">contour</span><span class="p">(</span><span class="n">levels</span><span class="p">)</span>

<span class="w">            </span><span class="n">fescolors</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">[]</span>

<span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="k">range</span><span class="p">(</span><span class="n">contours</span><span class="p">.</span><span class="n">points</span><span class="p">.</span><span class="n">shape</span><span class="o">[</span><span class="n">0</span><span class="o">]</span><span class="p">)</span><span class="err">:</span>

<span class="w">                </span><span class="n">fescolors</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">fes</span><span class="o">[</span><span class="n">int((contours.points[i, 0</span><span class="o">]-</span><span class="n">cv1min</span><span class="p">)</span><span class="o">*</span><span class="n">self</span><span class="p">.</span><span class="n">res</span><span class="o">/</span><span class="p">(</span><span class="n">cv1max</span><span class="o">-</span><span class="n">cv1min</span><span class="p">)),</span>

<span class="w">                                          </span><span class="nc">int</span><span class="p">((</span>

<span class="w">                                              </span><span class="n">contours</span><span class="p">.</span><span class="n">points</span><span class="o">[</span><span class="n">i, 1</span><span class="o">]-</span><span class="n">cv2min</span><span class="p">)</span><span class="o">*</span><span class="n">self</span><span class="p">.</span><span class="n">res</span><span class="o">/</span><span class="p">(</span><span class="n">cv2max</span><span class="o">-</span><span class="n">cv2min</span><span class="p">)),</span>

<span class="w">                                          </span><span class="nc">int</span><span class="p">((</span><span class="n">contours</span><span class="p">.</span><span class="n">points</span><span class="o">[</span><span class="n">i, 2</span><span class="o">]-</span><span class="n">cv3min</span><span class="p">)</span><span class="o">*</span><span class="n">self</span><span class="p">.</span><span class="n">res</span><span class="o">/</span><span class="p">(</span><span class="n">cv3max</span><span class="o">-</span><span class="n">cv3min</span><span class="p">))</span><span class="err">]</span><span class="p">)</span>

<span class="w">            </span><span class="err">#</span><span class="w"> </span><span class="o">%%</span><span class="w"> </span><span class="n">Visualization</span>

<span class="w">            </span><span class="n">pv</span><span class="p">.</span><span class="n">set_plot_theme</span><span class="p">(</span><span class="s1">&#39;document&#39;</span><span class="p">)</span>

<span class="w">            </span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pv</span><span class="p">.</span><span class="n">Plotter</span><span class="p">()</span>

<span class="w">            </span><span class="n">p</span><span class="p">.</span><span class="n">add_mesh</span><span class="p">(</span><span class="n">contours</span><span class="p">,</span><span class="w"> </span><span class="n">scalars</span><span class="o">=</span><span class="n">fescolors</span><span class="p">,</span><span class="w"> </span><span class="n">opacity</span><span class="o">=</span><span class="n">opacity</span><span class="p">,</span>

<span class="w">                       </span><span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span><span class="w"> </span><span class="n">show_scalar_bar</span><span class="o">=</span><span class="k">False</span><span class="p">,</span><span class="w"> </span><span class="n">interpolate_before_map</span><span class="o">=</span><span class="k">True</span><span class="p">)</span>

<span class="w">            </span><span class="n">p</span><span class="p">.</span><span class="n">show_grid</span><span class="p">(</span><span class="n">xlabel</span><span class="o">=</span><span class="n">xlabel</span><span class="p">,</span><span class="w"> </span><span class="n">ylabel</span><span class="o">=</span><span class="n">ylabel</span><span class="p">,</span><span class="w"> </span><span class="n">zlabel</span><span class="o">=</span><span class="n">zlabel</span><span class="p">)</span>

<span class="w">            </span><span class="n">p</span><span class="p">.</span><span class="n">show</span><span class="p">()</span>

<span class="w">        </span><span class="k">else</span><span class="err">:</span>

<span class="w">            </span><span class="n">raise</span><span class="w"> </span><span class="n">ValueError</span><span class="p">(</span><span class="ss">&quot;Only 1D, 2D and 3D FES are supported.&quot;</span><span class="p">)</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">png_name</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="k">None</span><span class="err">:</span>

<span class="w">            </span><span class="n">plt</span><span class="p">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">png_name</span><span class="p">)</span>
</code></pre></div>

</details>
<h4 id="removecv">removeCV</h4>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">removeCV</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">CV</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">kb</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">energy_unit</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;kJ/mol&#39;</span><span class="p">,</span>
    <span class="n">temp</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">300.0</span>
<span class="p">)</span>
</code></pre></div>

<p>Remove a CV from an existing FES. </p>
<p>The function first recalculates the FES to an array of probabilities. 
The probabilities are summed along the CV to be removed, 
and resulting probability distribution with 1 less dimension 
is converted back to FES. </p>
<p>Interactivity was working in jupyter notebook/lab with "%matplotlib widget".</p>
<p>Args:
    CV (int): the index of CV to be removed. 
    energy_unit (str): has to be either "kJ/mol" or "kcal/mol". Defaults to be "kJ/mol".
    kb (float, optional): the Boltzmann Constant in the energy unit.                 Defaults to be None, which will be set according to energy_unit.
    temp (float) = temperature of the simulation in Kelvins.</p>
<p>Return:
    New <code>Fes</code> instance without the CV to be removed.</p>
<details class="example">
<summary>View Source</summary>
<div class="codehilite"><pre><span></span><code><span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">removeCV</span><span class="p">(</span>

<span class="w">        </span><span class="n">self</span><span class="p">,</span>

<span class="w">        </span><span class="nl">CV</span><span class="p">:</span><span class="w"> </span><span class="nc">int</span><span class="p">,</span>

<span class="w">        </span><span class="nl">kb</span><span class="p">:</span><span class="w"> </span><span class="n">Optional</span><span class="o">[</span><span class="n">float</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">None</span><span class="p">,</span>

<span class="w">        </span><span class="nl">energy_unit</span><span class="p">:</span><span class="w"> </span><span class="nf">str</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ss">&quot;kJ/mol&quot;</span><span class="p">,</span>

<span class="w">        </span><span class="nl">temp</span><span class="p">:</span><span class="w"> </span><span class="nc">float</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">300.0</span>

<span class="w">    </span><span class="p">)</span><span class="err">:</span>

<span class="w">        </span><span class="ss">&quot;&quot;&quot;Remove a CV from an existing FES.</span>

<span class="ss">        The function first recalculates the FES to an array of probabilities.</span>

<span class="ss">        The probabilities are summed along the CV to be removed,</span>

<span class="ss">        and resulting probability distribution with 1 less dimension</span>

<span class="ss">        is converted back to FES.</span>

<span class="ss">        Interactivity was working in jupyter notebook/lab with &quot;</span><span class="o">%</span><span class="n">matplotlib</span><span class="w"> </span><span class="n">widget</span><span class="ss">&quot;.</span>

<span class="ss">        Args:</span>

<span class="ss">            CV (int): the index of CV to be removed.</span>

<span class="ss">            energy_unit (str): has to be either &quot;</span><span class="n">kJ</span><span class="o">/</span><span class="n">mol</span><span class="ss">&quot; or &quot;</span><span class="n">kcal</span><span class="o">/</span><span class="n">mol</span><span class="ss">&quot;. Defaults to be &quot;</span><span class="n">kJ</span><span class="o">/</span><span class="n">mol</span><span class="ss">&quot;.</span>

<span class="ss">            kb (float, optional): the Boltzmann Constant in the energy unit. \</span>

<span class="ss">                Defaults to be None, which will be set according to energy_unit.</span>

<span class="ss">            temp (float) = temperature of the simulation in Kelvins.</span>

<span class="ss">        Return:</span>

<span class="ss">            New `Fes` instance without the CV to be removed.</span>

<span class="ss">        &quot;&quot;&quot;</span>

<span class="w">        </span><span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="ss">&quot;Removing CV {CV}.&quot;</span><span class="p">)</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">fes</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="k">None</span><span class="err">:</span>

<span class="w">            </span><span class="n">raise</span><span class="w"> </span><span class="n">ValueError</span><span class="p">(</span>

<span class="w">                </span><span class="ss">&quot;FES not calculated yet. Use makefes() or makefes2() first.&quot;</span><span class="p">)</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">CV</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">hills</span><span class="p">.</span><span class="nl">cvs</span><span class="p">:</span>

<span class="w">            </span><span class="k">print</span><span class="p">(</span><span class="ss">&quot;Error: The CV to remove is not available in this FES object.&quot;</span><span class="p">)</span>

<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="k">None</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">kb</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="k">None</span><span class="err">:</span>

<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="n">energy_unit</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="ss">&quot;kJ/mol&quot;</span><span class="err">:</span>

<span class="w">                </span><span class="n">kb</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">8.314e-3</span>

<span class="w">            </span><span class="n">elif</span><span class="w"> </span><span class="n">energy_unit</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="ss">&quot;kcal/mol&quot;</span><span class="err">:</span>

<span class="w">                </span><span class="n">kb</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">8.314e-3</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">4.184</span>

<span class="w">            </span><span class="k">else</span><span class="err">:</span>

<span class="w">                </span><span class="n">raise</span><span class="w"> </span><span class="n">ValueError</span><span class="p">(</span>

<span class="w">                    </span><span class="ss">&quot;Please give the Boltzmann Constant in the energy unit.&quot;</span><span class="p">)</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">cvs</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="err">:</span>

<span class="w">            </span><span class="k">print</span><span class="p">(</span><span class="ss">&quot;Error: You can not remove the only CV. &quot;</span><span class="p">)</span>

<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="k">None</span>

<span class="w">        </span><span class="k">else</span><span class="err">:</span>

<span class="w">            </span><span class="n">probabilities</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">np</span><span class="p">.</span><span class="nf">exp</span><span class="p">(</span><span class="o">-</span><span class="n">self</span><span class="p">.</span><span class="n">fes</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="n">kb</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">temp</span><span class="p">))</span>

<span class="w">            </span><span class="n">new_prob</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">np</span><span class="p">.</span><span class="nf">sum</span><span class="p">(</span><span class="n">probabilities</span><span class="p">,</span><span class="w"> </span><span class="n">axis</span><span class="o">=</span><span class="n">CV</span><span class="p">)</span>

<span class="w">            </span><span class="n">new_fes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Fes</span><span class="p">(</span><span class="n">hills</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">hills</span><span class="p">,</span><span class="w"> </span><span class="n">calculate_new_fes</span><span class="o">=</span><span class="k">False</span><span class="p">)</span>

<span class="w">            </span><span class="n">new_fes</span><span class="p">.</span><span class="n">fes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">kb</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">temp</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">np</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="n">new_prob</span><span class="p">)</span>

<span class="w">            </span><span class="n">new_fes</span><span class="p">.</span><span class="n">fes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new_fes</span><span class="p">.</span><span class="n">fes</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">np</span><span class="p">.</span><span class="nf">min</span><span class="p">(</span><span class="n">new_fes</span><span class="p">.</span><span class="n">fes</span><span class="p">)</span>

<span class="w">            </span><span class="n">new_fes</span><span class="p">.</span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">res</span>

<span class="w">            </span><span class="n">mask</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">np</span><span class="p">.</span><span class="n">ones</span><span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">cv_select</span><span class="p">),</span><span class="w"> </span><span class="n">dtype</span><span class="o">=</span><span class="n">bool</span><span class="p">)</span>

<span class="w">            </span><span class="n">mask</span><span class="o">[</span><span class="n">CV</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">False</span>

<span class="w">            </span><span class="n">new_fes</span><span class="p">.</span><span class="n">cv_select</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">cv_select</span><span class="o">[</span><span class="n">mask</span><span class="o">]</span>

<span class="w">            </span><span class="n">new_fes</span><span class="p">.</span><span class="n">cv_min</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">cv_min</span><span class="o">[</span><span class="n">mask</span><span class="o">]</span>

<span class="w">            </span><span class="n">new_fes</span><span class="p">.</span><span class="n">cv_max</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">cv_max</span><span class="o">[</span><span class="n">mask</span><span class="o">]</span>

<span class="w">            </span><span class="n">new_fes</span><span class="p">.</span><span class="n">cv_fes_range</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">cv_fes_range</span><span class="o">[</span><span class="n">mask</span><span class="o">]</span>

<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">new_fes</span>
</code></pre></div>

</details>
<h4 id="set_fes">set_fes</h4>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">set_fes</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">fes</span>
<span class="p">)</span>
</code></pre></div>

<details class="example">
<summary>View Source</summary>
<div class="codehilite"><pre><span></span><code>    def set_fes(self, fes):

        self.fes = fes
</code></pre></div>

</details>
<h4 id="surface_plot">surface_plot</h4>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">surface_plot</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">cv_select</span><span class="p">:</span> <span class="n">NoneType</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">cv_range</span><span class="p">:</span> <span class="n">NoneType</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">cmap</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;jet&#39;</span><span class="p">,</span>
    <span class="n">energy_unit</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;kJ/mol&#39;</span><span class="p">,</span>
    <span class="n">xlabel</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">ylabel</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">zlabel</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">label_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">12</span><span class="p">,</span>
    <span class="n">image_size</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">12</span><span class="p">,</span> <span class="mi">7</span><span class="p">],</span>
    <span class="n">rstride</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="n">cstride</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="n">vmin</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">vmax</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<span class="p">)</span>
</code></pre></div>

<p>Visualizes the 2D free energy surface (FES) as a 3D surface plot using Matplotlib.</p>
<p>Note: Interactivity is currently limited to jupyter notebook or jupyter lab in <code>%matplotlib widget</code> mode. Otherwise, it is a static image of the 3D surface plot.</p>
<p>Usage:</p>
<div class="codehilite"><pre><span></span><code><span class="o">%</span><span class="n">matplotlib</span> <span class="n">widget</span>
<span class="n">fes</span><span class="o">.</span><span class="n">surface_plot</span><span class="p">()</span>
</code></pre></div>

<p>Future plans include implementing this function using PyVista. However, in the current version of PyVista (0.38.5), there is an issue with labels on the 3rd axis for free energy showing wrong values.</p>
<details class="example">
<summary>View Source</summary>
<div class="codehilite"><pre><span></span><code><span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="n">surface_plot</span><span class="p">(</span>

<span class="w">        </span><span class="n">self</span><span class="p">,</span>

<span class="w">        </span><span class="nl">cv_select</span><span class="p">:</span><span class="w"> </span><span class="n">Optional</span><span class="p">[</span><span class="n">None</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">None</span><span class="p">,</span>

<span class="w">        </span><span class="nl">cv_range</span><span class="p">:</span><span class="w"> </span><span class="n">Optional</span><span class="p">[</span><span class="n">None</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">None</span><span class="p">,</span>

<span class="w">        </span><span class="nl">cmap</span><span class="p">:</span><span class="w"> </span><span class="n">str</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;jet&quot;</span><span class="p">,</span>

<span class="w">        </span><span class="nl">energy_unit</span><span class="p">:</span><span class="w"> </span><span class="n">str</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;kJ/mol&quot;</span><span class="p">,</span>

<span class="w">        </span><span class="nl">xlabel</span><span class="p">:</span><span class="w"> </span><span class="n">Optional</span><span class="p">[</span><span class="n">str</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">None</span><span class="p">,</span>

<span class="w">        </span><span class="nl">ylabel</span><span class="p">:</span><span class="w"> </span><span class="n">Optional</span><span class="p">[</span><span class="n">str</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">None</span><span class="p">,</span>

<span class="w">        </span><span class="nl">zlabel</span><span class="p">:</span><span class="w"> </span><span class="n">Optional</span><span class="p">[</span><span class="n">str</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">None</span><span class="p">,</span>

<span class="w">        </span><span class="nl">label_size</span><span class="p">:</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">12</span><span class="p">,</span>

<span class="w">        </span><span class="nl">image_size</span><span class="p">:</span><span class="w"> </span><span class="n">List</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="mi">12</span><span class="p">,</span><span class="w"> </span><span class="mi">7</span><span class="p">],</span>

<span class="w">        </span><span class="nl">rstride</span><span class="p">:</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>

<span class="w">        </span><span class="nl">cstride</span><span class="p">:</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>

<span class="w">        </span><span class="nl">vmin</span><span class="p">:</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>

<span class="w">        </span><span class="nl">vmax</span><span class="p">:</span><span class="w"> </span><span class="n">Optional</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">None</span><span class="p">,</span>

<span class="w">    </span><span class="p">)</span><span class="o">:</span>

<span class="w">        </span><span class="s">&quot;&quot;&quot;</span>

<span class="w">        </span><span class="n">Visualizes</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="mi">2</span><span class="n">D</span><span class="w"> </span><span class="n">free</span><span class="w"> </span><span class="n">energy</span><span class="w"> </span><span class="n">surface</span><span class="w"> </span><span class="p">(</span><span class="n">FES</span><span class="p">)</span><span class="w"> </span><span class="n">as</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="mi">3</span><span class="n">D</span><span class="w"> </span><span class="n">surface</span><span class="w"> </span><span class="n">plot</span><span class="w"> </span><span class="k">using</span><span class="w"> </span><span class="n">Matplotlib</span><span class="p">.</span>

<span class="w">        </span><span class="nl">Note</span><span class="p">:</span><span class="w"> </span><span class="n">Interactivity</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">currently</span><span class="w"> </span><span class="n">limited</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">jupyter</span><span class="w"> </span><span class="n">notebook</span><span class="w"> </span><span class="n">or</span><span class="w"> </span><span class="n">jupyter</span><span class="w"> </span><span class="n">lab</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="err">`</span><span class="nf">%matplotlib</span><span class="w"> </span><span class="n">widget</span><span class="err">`</span><span class="w"> </span><span class="n">mode</span><span class="p">.</span><span class="w"> </span><span class="n">Otherwise</span><span class="p">,</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="k">static</span><span class="w"> </span><span class="n">image</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="mi">3</span><span class="n">D</span><span class="w"> </span><span class="n">surface</span><span class="w"> </span><span class="n">plot</span><span class="p">.</span>

<span class="w">        </span><span class="nl">Usage</span><span class="p">:</span>

<span class="w">        </span><span class="err">```</span><span class="n">python</span>

<span class="w">        </span><span class="nf">%matplotlib</span><span class="w"> </span><span class="n">widget</span>

<span class="w">        </span><span class="n">fes</span><span class="p">.</span><span class="n">surface_plot</span><span class="p">()</span>

<span class="w">        </span><span class="err">```</span>

<span class="w">        </span><span class="n">Future</span><span class="w"> </span><span class="n">plans</span><span class="w"> </span><span class="n">include</span><span class="w"> </span><span class="n">implementing</span><span class="w"> </span><span class="k">this</span><span class="w"> </span><span class="n">function</span><span class="w"> </span><span class="k">using</span><span class="w"> </span><span class="n">PyVista</span><span class="p">.</span><span class="w"> </span><span class="n">However</span><span class="p">,</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">current</span><span class="w"> </span><span class="n">version</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">PyVista</span><span class="w"> </span><span class="p">(</span><span class="mf">0.38.5</span><span class="p">),</span><span class="w"> </span><span class="n">there</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">an</span><span class="w"> </span><span class="n">issue</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="n">labels</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="mi">3</span><span class="n">rd</span><span class="w"> </span><span class="n">axis</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">free</span><span class="w"> </span><span class="n">energy</span><span class="w"> </span><span class="n">showing</span><span class="w"> </span><span class="n">wrong</span><span class="w"> </span><span class="n">values</span><span class="p">.</span>

<span class="w">        </span><span class="s">&quot;&quot;&quot;</span>

<span class="w">        </span><span class="k">import</span><span class="w"> </span><span class="n">matplotlib</span><span class="p">.</span><span class="n">pyplot</span><span class="w"> </span><span class="n">as</span><span class="w"> </span><span class="n">plt</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">cv_select</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">None</span><span class="o">:</span>

<span class="w">            </span><span class="n">cv_select</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">list</span><span class="p">(</span><span class="n">range</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">cvs</span><span class="p">))</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">cvs</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">2</span><span class="o">:</span>

<span class="w">            </span><span class="n">cv1_index</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">cv_select</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

<span class="w">            </span><span class="n">cv2_index</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">cv_select</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

<span class="w">            </span><span class="n">cv1min</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">cv_min</span><span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">cv_select</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>

<span class="w">            </span><span class="n">cv1max</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">cv_max</span><span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">cv_select</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>

<span class="w">            </span><span class="n">cv2min</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">cv_min</span><span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">cv_select</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>

<span class="w">            </span><span class="n">cv2max</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">cv_max</span><span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">cv_select</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>

<span class="w">            </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">np</span><span class="p">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">cv1min</span><span class="p">,</span><span class="w"> </span><span class="n">cv1max</span><span class="p">,</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">res</span><span class="p">)</span>

<span class="w">            </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">np</span><span class="p">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">cv2min</span><span class="p">,</span><span class="w"> </span><span class="n">cv2max</span><span class="p">,</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">res</span><span class="p">)</span>

<span class="w">            </span><span class="n">X</span><span class="p">,</span><span class="w"> </span><span class="n">Y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">np</span><span class="p">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">)</span>

<span class="w">            </span><span class="n">Z</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">fes</span>

<span class="w">            </span><span class="cp">#grid = pv.StructuredGrid(X, Y, Z)</span>

<span class="w">            </span><span class="cp"># grid.plot()</span>

<span class="w">            </span><span class="n">fig</span><span class="p">,</span><span class="w"> </span><span class="n">ax</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">plt</span><span class="p">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">subplot_kw</span><span class="o">=</span><span class="p">{</span><span class="s">&quot;projection&quot;</span><span class="o">:</span><span class="w"> </span><span class="s">&quot;3d&quot;</span><span class="p">})</span>

<span class="w">            </span><span class="n">ax</span><span class="p">.</span><span class="n">plot_surface</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="w"> </span><span class="n">Y</span><span class="p">,</span><span class="w"> </span><span class="n">Z</span><span class="p">,</span><span class="w"> </span><span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span><span class="w">  </span><span class="err">#</span><span class="w"> </span><span class="n">type</span><span class="o">:</span><span class="w"> </span><span class="n">ignore</span>

<span class="w">                            </span><span class="n">rstride</span><span class="o">=</span><span class="n">rstride</span><span class="p">,</span><span class="w"> </span><span class="n">cstride</span><span class="o">=</span><span class="n">cstride</span><span class="p">)</span>

<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="n">xlabel</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">None</span><span class="o">:</span>

<span class="w">                </span><span class="n">ax</span><span class="p">.</span><span class="n">set_xlabel</span><span class="p">(</span>

<span class="w">                    </span><span class="n">f</span><span class="err">&#39;</span><span class="n">CV1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="p">{</span><span class="n">self</span><span class="p">.</span><span class="n">hills</span><span class="p">.</span><span class="n">cv_name</span><span class="p">[</span><span class="n">cv1_index</span><span class="p">]}</span><span class="err">&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="o">=</span><span class="n">label_size</span><span class="p">)</span>

<span class="w">            </span><span class="nl">else</span><span class="p">:</span>

<span class="w">                </span><span class="n">ax</span><span class="p">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">xlabel</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="o">=</span><span class="n">label_size</span><span class="p">)</span>

<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="n">ylabel</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">None</span><span class="o">:</span>

<span class="w">                </span><span class="n">ax</span><span class="p">.</span><span class="n">set_ylabel</span><span class="p">(</span>

<span class="w">                    </span><span class="n">f</span><span class="err">&#39;</span><span class="n">CV2</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="p">{</span><span class="n">self</span><span class="p">.</span><span class="n">hills</span><span class="p">.</span><span class="n">cv_name</span><span class="p">[</span><span class="n">cv2_index</span><span class="p">]}</span><span class="err">&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="o">=</span><span class="n">label_size</span><span class="p">)</span>

<span class="w">            </span><span class="nl">else</span><span class="p">:</span>

<span class="w">                </span><span class="n">ax</span><span class="p">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">ylabel</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="o">=</span><span class="n">label_size</span><span class="p">)</span>

<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="n">zlabel</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">None</span><span class="o">:</span>

<span class="w">                </span><span class="cp"># type: ignore</span>

<span class="w">                </span><span class="n">ax</span><span class="p">.</span><span class="n">set_zlabel</span><span class="p">(</span><span class="n">f</span><span class="err">&#39;</span><span class="n">free</span><span class="w"> </span><span class="n">energy</span><span class="w"> </span><span class="p">({</span><span class="n">energy_unit</span><span class="p">})</span><span class="err">&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="o">=</span><span class="n">label_size</span><span class="p">)</span>

<span class="w">            </span><span class="nl">else</span><span class="p">:</span>

<span class="w">                </span><span class="n">ax</span><span class="p">.</span><span class="n">set_zlabel</span><span class="p">(</span><span class="n">zlabel</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="o">=</span><span class="n">label_size</span><span class="p">)</span><span class="w">  </span><span class="err">#</span><span class="w"> </span><span class="n">type</span><span class="o">:</span><span class="w"> </span><span class="n">ignore</span>

<span class="w">        </span><span class="nl">else</span><span class="p">:</span>

<span class="w">            </span><span class="n">raise</span><span class="w"> </span><span class="n">ValueError</span><span class="p">(</span>

<span class="w">                </span><span class="n">f</span><span class="s">&quot;Surface plot only works for FES with exactly two CVs, and this FES has {self.hills.cvs}&quot;</span>

<span class="w">            </span><span class="p">)</span>
</code></pre></div>

</details>





                
              </article>
            </div>
          
          
        </div>
        
      </main>
      
        
<footer class="md-footer">
    
      <nav class="md-footer__inner md-grid" aria-label="Footer">
        
          
          <a href="../../../docs/example/tutorial/" class="md-footer__link md-footer__link--prev" aria-label="Previous: Tutorial" rel="prev">
            <div class="md-footer__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
            </div>
            <div class="md-footer__title">
              <div class="md-ellipsis">
                <span class="md-footer__direction">
                  Previous
                </span>
                Tutorial
              </div>
            </div>
          </a>
        
        
          
          <a href="../hills/" class="md-footer__link md-footer__link--next" aria-label="Next: Hills" rel="next">
            <div class="md-footer__title">
              <div class="md-ellipsis">
                <span class="md-footer__direction">
                  Next
                </span>
                Hills
              </div>
            </div>
            <div class="md-footer__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg>
            </div>
          </a>
        
      </nav>
    
    <div class="md-footer-meta md-typeset">
      <div class="md-footer-meta__inner md-grid">
        <div class="md-footer-copyright">
            
            Powered by
            <a href="http://timothycrosley.github.io/portray">portray.</a>
            You too can
            <a href="http://timothycrosley.github.io/portray">
              portray</a>
            your Python project well using automatic documentation.
          </div>
        
      </div>
    </div>
  </footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "../../..", "features": [], "search": "../../../assets/javascripts/workers/search.5bf1dace.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version.title": "Select version"}}</script>
    
    
      <script src="../../../assets/javascripts/bundle.078830c0.min.js"></script>
      
    
  </body>
</html>